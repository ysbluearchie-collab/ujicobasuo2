<!doctype html>
<html lang="id">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Ujian Online</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
      color: #1f2937;
    }

    html { height: 100%; }
    * { box-sizing: border-box; }

    /* Toast Notification */
    .toast {
      position: fixed;
      top: 24px;
      right: 24px;
      background: white;
      padding: 16px 24px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 10001;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 300px;
      animation: slideIn 0.3s ease;
      border-left: 4px solid;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .toast.success { border-left-color: #10b981; color: #065f46; }
    .toast.error { border-left-color: #ef4444; color: #991b1b; }
    .toast.warning { border-left-color: #f59e0b; color: #92400e; }
    .toast.info { border-left-color: #3b82f6; color: #1e40af; }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
      20%, 40%, 60%, 80% { transform: translateX(10px); }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Login Screen */
    .login-container {
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      width: 100%;
    }

    .login-box {
      background: white;
      padding: 48px;
      border-radius: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4);
      max-width: 480px;
      width: 100%;
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .login-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-icon {
      font-size: 64px;
      margin-bottom: 16px;
    }

    .login-title {
      font-size: 28px;
      font-weight: 900;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0 0 12px 0;
    }

    .login-subtitle {
      color: #6b7280;
      font-size: 14px;
      margin: 0;
      line-height: 1.5;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: 700;
      margin-bottom: 8px;
      color: #374151;
      font-size: 14px;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s ease;
      background: white;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
      line-height: 1.6;
    }

    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }

    .btn-secondary {
      background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      color: white;
    }

    .btn-info {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 13px;
    }

    /* App Layout */
    .app-wrapper {
      display: none;
      min-height: 100%;
      width: 100%;
      background: #f3f4f6;
    }

    .app-wrapper.active {
      display: flex;
      flex-direction: column;
    }

    .header {
      background: white;
      padding: 16px 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      width: 100%;
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .header-title h1 {
      margin: 0;
      font-size: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 900;
    }

    .header-user {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .user-info {
      text-align: right;
    }

    .user-name {
      font-weight: 800;
      color: #1f2937;
      margin: 0;
      font-size: 14px;
    }

    .user-role {
      font-size: 12px;
      color: #6b7280;
      margin: 4px 0 0 0;
    }

    /* Sidebar Navigation */
    .app-body {
      display: flex;
      flex-direction: column;
      flex: 1;
      max-width: 1400px;
      width: 100%;
      margin: 0 auto;
      gap: 0;
    }

    .sidebar {
      width: 100%;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      padding: 0;
      overflow-x: auto;
      overflow-y: hidden;
    }

    .sidebar-menu {
      list-style: none;
      padding: 12px 24px;
      margin: 0;
      display: flex;
      flex-direction: row;
      gap: 8px;
      white-space: nowrap;
    }

    .menu-item {
      margin: 0;
      flex-shrink: 0;
    }

    .menu-link {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px 20px;
      color: #6b7280;
      text-decoration: none;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.2s;
      border-bottom: 3px solid transparent;
      border-radius: 8px 8px 0 0;
      min-width: 100px;
    }

    .menu-link:hover {
      background: #f9fafb;
      color: #667eea;
    }

    .menu-link.active {
      background: #ede9fe;
      color: #667eea;
      border-bottom-color: #667eea;
    }

    .menu-icon {
      font-size: 24px;
      width: auto;
      text-align: center;
    }

    .menu-label {
      display: block;
      text-align: center;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 32px 24px;
      overflow-y: auto;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 24px;
    }

    .card-title {
      font-size: 22px;
      font-weight: 900;
      margin: 0 0 24px 0;
      color: #1f2937;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-admin { background: #dbeafe; color: #1e40af; }
    .badge-guru { background: #d1fae5; color: #065f46; }
    .badge-siswa { background: #fce7f3; color: #9f1239; }
    .badge-success { background: #d1fae5; color: #065f46; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-secondary { background: #e5e7eb; color: #374151; }
    .badge-info { background: #dbeafe; color: #1e40af; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .stat-icon {
      font-size: 48px;
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 16px;
    }

    .stat-content {
      flex: 1;
    }

    .stat-label {
      font-size: 13px;
      font-weight: 700;
      color: #6b7280;
      text-transform: uppercase;
      margin: 0 0 4px 0;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 900;
      color: #1f2937;
      margin: 0;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-text {
      font-weight: 700;
      font-size: 16px;
      margin: 0;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
      overflow-y: auto;
    }

    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 32px;
      max-width: 800px;
      width: 100%;
      max-height: 90%;
      overflow-y: auto;
      animation: modalSlideUp 0.3s ease;
    }

    @keyframes modalSlideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }

    .modal-title {
      font-size: 22px;
      font-weight: 900;
      color: #1f2937;
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #6b7280;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #fee2e2;
      color: #ef4444;
      transform: rotate(90deg);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .login-box {
        padding: 32px 24px;
      }

      .card {
        padding: 20px;
      }

      .stat-card {
        flex-direction: column;
        text-align: center;
      }

      .menu-link {
        padding: 10px 16px;
        font-size: 12px;
        min-width: 80px;
      }
    }

    /* Loading Spinner */
    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Login Screen -->
  <div id="loginScreen" class="login-container">
   <div class="login-box">
    <div class="login-header">
     <div class="login-icon" id="loginIcon">
      üéì
     </div>
     <h1 class="login-title" id="loginTitle">Sistem Ujian Online</h1>
     <p class="login-subtitle" id="loginSubtitle">Silakan masuk dengan akun Anda</p>
    </div>
    <form id="loginForm">
     <div class="form-group"><label class="form-label" for="loginUsername">Username</label> <input type="text" id="loginUsername" class="form-input" required autocomplete="username">
     </div>
     <div class="form-group"><label class="form-label" for="loginPassword">Password</label> <input type="password" id="loginPassword" class="form-input" required autocomplete="current-password">
     </div><button type="submit" class="btn btn-primary" id="loginBtn" style="width: 100%;"> üîë Masuk </button>
    </form>
   </div>
  </div><!-- App Screen -->
  <div id="appScreen" class="app-wrapper">
   <div class="header">
    <div class="header-content">
     <div class="header-title"><span style="font-size: 28px;" id="headerIcon">üéì</span>
      <h1 id="headerTitle">Dashboard</h1>
     </div>
     <div class="header-user">
      <div class="user-info">
       <p class="user-name" id="userName">User</p>
       <p class="user-role" id="userRole">Role</p>
      </div><button onclick="logout()" class="btn btn-secondary btn-sm">üö™ Keluar</button>
     </div>
    </div>
   </div>
   <div class="app-body">
    <nav class="sidebar">
     <ul class="sidebar-menu" id="sidebarMenu"></ul>
    </nav>
    <main class="main-content" id="mainContent">
     <div class="empty-state">
      <div class="empty-icon">
       ‚è≥
      </div>
      <p class="empty-text">Menghubungkan ke Canva Sheet...</p>
     </div>
    </main>
   </div>
  </div>
  <script>
    const defaultConfig = {
      login_title: 'Sistem Ujian Online',
      login_subtitle: 'Silakan masuk dengan akun Anda'
    };

    let appData = [];
    let currentUser = null;
    let currentPage = 'dashboard';
    let isSDKInitialized = false;

    const MENU_STRUCTURE = {
      admin: [
        { id: 'dashboard', icon: 'üìä', label: 'Dashboard', page: 'dashboard' },
        { id: 'users', icon: 'üë•', label: 'Kelola Pengguna', page: 'users' },
        { id: 'questions', icon: 'üìù', label: 'Kelola Soal', page: 'questions' },
        { id: 'schedule', icon: 'üìÖ', label: 'Penjadwalan', page: 'schedule' },
        { id: 'results', icon: 'üìä', label: 'Hasil Tes', page: 'results' },
        { id: 'messages', icon: 'üí¨', label: 'Kelola Pesan', page: 'messages' }
      ],
      guru: [
        { id: 'dashboard', icon: 'üìä', label: 'Dashboard', page: 'dashboard' },
        { id: 'questions', icon: 'üìù', label: 'Kelola Soal', page: 'questions' },
        { id: 'results', icon: 'üìä', label: 'Hasil Tes', page: 'results' }
      ],
      siswa: [
        { id: 'dashboard', icon: 'üìä', label: 'Dashboard', page: 'dashboard' },
        { id: 'exams', icon: 'üìã', label: 'Ujian Saya', page: 'exams' },
        { id: 'results', icon: 'üìä', label: 'Hasil Saya', page: 'results' }
      ]
    };

    const dataHandler = {
      onDataChanged(data) {
        console.log('     Data received from Canva Sheet:', data.length, 'records');
        appData = data;
        
        updateLoginIcon();
        
        if (currentUser) {
          renderCurrentPage();
        }
      }
    };

    async function onConfigChange(config) {
      document.getElementById('loginTitle').textContent = config.login_title || defaultConfig.login_title;
      document.getElementById('loginSubtitle').textContent = config.login_subtitle || defaultConfig.login_subtitle;
      
      updateLoginIcon();
    }

    function updateLoginIcon() {
      const loginImage = appData.find(m => m.type === 'message' && m.message_key === 'login_image');
      const loginIconEl = document.getElementById('loginIcon');
      
      if (!loginIconEl) return;
      
      if (loginImage) {
        if (loginImage.message_text && !loginImage.message_image_url) {
          loginIconEl.innerHTML = loginImage.message_text;
          loginIconEl.style.fontSize = '80px';
          loginIconEl.style.textAlign = 'center';
        } else if (loginImage.message_image_url) {
          loginIconEl.innerHTML = `<img src="${loginImage.message_image_url}" style="max-width: 200px; max-height: 200px; border-radius: 12px; display: block; margin: 0 auto;" onerror="this.parentElement.innerHTML='üéì'; this.parentElement.style.fontSize='64px'; this.parentElement.style.textAlign='center';">`;
          loginIconEl.style.fontSize = 'inherit';
          loginIconEl.style.textAlign = 'center';
        }
      } else {
        loginIconEl.textContent = 'üéì';
        loginIconEl.style.fontSize = '64px';
        loginIconEl.style.textAlign = 'center';
      }
    }

    async function init() {
      try {
        console.log('üöÄ Initializing Sistem Ujian Online...');

        // Initialize Element SDK
        if (window.elementSdk) {
          console.log('   Initializing Element SDK...');
          await window.elementSdk.init({
            defaultConfig: defaultConfig,
            onConfigChange: onConfigChange,
            mapToCapabilities: (config) => ({
              recolorables: [],
              borderables: [],
              fontEditable: undefined,
              fontSizeable: undefined
            }),
            mapToEditPanelValues: (config) => new Map([
              ['login_title', config.login_title || defaultConfig.login_title],
              ['login_subtitle', config.login_subtitle || defaultConfig.login_subtitle]
            ])
          });
          console.log('‚úÖ Element SDK initialized');
        }

        // Initialize Data SDK
        if (!window.dataSdk) {
          showToast('‚ùå Data SDK tidak tersedia', 'error');
          console.error('‚ùå Data SDK not available');
          return;
        }

        console.log('üìä Connecting to Canva Sheet...');
        const result = await window.dataSdk.init(dataHandler);
        
        if (result.isOk) {
          isSDKInitialized = true;
          console.log('‚úÖ Connected to Canva Sheet successfully');
          showToast('‚úÖ Terhubung ke Canva Sheet', 'success');
          
          // Initialize default admin user if no users exist
          await initializeDefaultData();
        } else {
          console.error('‚ùå Failed to connect to Canva Sheet:', result.error);
          showToast('‚ùå Gagal terhubung ke Canva Sheet', 'error');
        }
      } catch (error) {
        console.error('‚ùå Initialization error:', error);
        showToast('‚ùå Error: ' + error.message, 'error');
      }
    }

    let isInitializingAdmin = false;
    let adminCreatedFlag = false;

    async function initializeDefaultData() {
      // If admin was already created in this session, skip
      if (adminCreatedFlag) {
        console.log('‚úÖ Admin already created in this session');
        return;
      }

      const users = appData.filter(u => u.type === 'user');
      
      // Check if admin already exists (strict check)
      const adminExists = users.some(u => u.username === 'admin' && u.role === 'admin');
      
      if (adminExists) {
        console.log('‚úÖ Admin account already exists');
        adminCreatedFlag = true;
        return;
      }
      
      // Only create admin if no users exist at all
      if (users.length === 0) {
        // Prevent multiple simultaneous admin creation
        if (isInitializingAdmin) {
          console.log('‚è≥ Admin creation already in progress...');
          return;
        }
        
        isInitializingAdmin = true;
        adminCreatedFlag = true;
        console.log('üîß Creating default admin...');
        
        const btn = document.getElementById('loginBtn');
        if (btn) {
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner"></span> Mempersiapkan sistem...';
        }

        const result = await window.dataSdk.create({
          type: 'user',
          username: 'admin',
          password: 'admin123',
          name: 'Administrator',
          role: 'admin',
          class: null,
          subject: null,
          nip: null,
          nis: null,
          created_at: new Date().toISOString()
        });

        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'üîë Masuk';
        }
        
        isInitializingAdmin = false;
        
        if (!result.isOk) {
          console.error('‚ùå Failed to create admin:', result.error);
          adminCreatedFlag = false; // Reset flag on failure
        } else {
          console.log('‚úÖ Admin account created successfully');
        }
      } else {
        console.log('‚úÖ Users exist, skipping admin creation');
        adminCreatedFlag = true;
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      const icons = { success: '‚úÖ', error: '‚ùå', warning: '     Ô∏è', info: '‚ÑπÔ∏è' };
      toast.innerHTML = `
        <span style="font-size: 20px;">${icons[type]}</span>
        <span style="flex: 1; font-weight: 700;">${message}</span>
      `;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(400px)';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!isSDKInitialized) {
        showToast('‚è≥ Sistem belum siap, silakan tunggu...', 'warning');
        return;
      }

      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value;

      if (!username || !password) {
        showToast('‚ö†Ô∏è Username dan password harus diisi', 'warning');
        return;
      }

      const btn = document.getElementById('loginBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Memproses...';

      await new Promise(r => setTimeout(r, 500));

      const user = appData.find(u => u.type === 'user' && u.username === username && u.password === password);

      if (user) {
        currentUser = user;
        console.log('‚úÖ User logged in:', user.username, '-', user.role);
        
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('appScreen').classList.add('active');
        
        renderSidebar();
        navigateTo('dashboard');
        
        showToast(`üëã Selamat datang, ${user.name}!`, 'success');
      } else {
        console.warn('‚ùå Login failed for username:', username);
        showToast('‚ùå Username atau password salah', 'error');
      }

      btn.disabled = false;
      btn.innerHTML = 'üîë Masuk';
    });

    function logout() {
      console.log('üëã User logged out:', currentUser ? currentUser.username : 'unknown');
      currentUser = null;
      currentPage = 'dashboard';
      
      document.getElementById('appScreen').classList.remove('active');
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('loginForm').reset();
      showToast('üëã Berhasil keluar', 'info');
    }

    function renderSidebar() {
      const menu = MENU_STRUCTURE[currentUser.role] || [];
      const sidebar = document.getElementById('sidebarMenu');
      
      sidebar.innerHTML = menu.map(item => `
        <li class="menu-item">
          <a href="#" class="menu-link ${currentPage === item.page ? 'active' : ''}" 
             onclick="navigateTo('${item.page}'); return false;">
            <span class="menu-icon">${item.icon}</span>
            <span class="menu-label">${item.label}</span>
          </a>
        </li>
      `).join('');
    }

    function navigateTo(page) {
      console.log('üìÑ Navigating to:', page);
      currentPage = page;
      renderSidebar();
      renderCurrentPage();
    }

    function renderCurrentPage() {
      const roleIcons = {
        admin: 'üë®‚Äçüíº',
        guru: 'üë®‚Äçüè´',
        siswa: 'üë®‚Äçüéì'
      };

      document.getElementById('headerIcon').textContent = roleIcons[currentUser.role] || 'üéì';
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userRole').textContent = currentUser.role === 'admin' ? 'Administrator' : 
                                                        currentUser.role === 'guru' ? currentUser.subject || 'Guru' :
                                                        `Kelas ${currentUser.class || ''}`;

      switch(currentPage) {
        case 'dashboard':
          renderDashboard();
          break;
        case 'users':
          renderUsersPage();
          break;
        case 'questions':
          renderQuestionsPage();
          break;
        case 'schedule':
          renderSchedulePage();
          break;
        case 'exams':
          renderExamsPage();
          break;
        case 'results':
          renderResultsPage();
          break;
        case 'messages':
          renderMessagesPage();
          break;
        default:
          renderDashboard();
      }
    }

    function renderDashboard() {
      const content = document.getElementById('mainContent');
      document.getElementById('headerTitle').textContent = 'Dashboard';

      const users = appData.filter(u => u.type === 'user');
      const exams = appData.filter(e => e.type === 'exam');
      const questions = appData.filter(q => q.type === 'question');
      const results = appData.filter(r => r.type === 'result');

      if (currentUser.role === 'admin') {
        content.innerHTML = `
          <div class="stats-grid">
            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
              <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üë•</div>
              <div class="stat-content">
                <p class="stat-label" style="color: rgba(255,255,255,0.9);">Total Pengguna</p>
                <p class="stat-value" style="color: white;">${users.length}</p>
              </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
              <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üìù</div>
              <div class="stat-content">
                <p class="stat-label" style="color: rgba(255,255,255,0.9);">Total Ujian</p>
                <p class="stat-value" style="color: white;">${exams.length}</p>
              </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
              <div class="stat-icon" style="background: rgba(255,255,255,0.2);">‚ùì</div>
              <div class="stat-content">
                <p class="stat-label" style="color: rgba(255,255,255,0.9);">Total Soal</p>
                <p class="stat-value" style="color: white;">${questions.length}</p>
              </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
              <div class="stat-icon" style="background: rgba(255,255,255,0.2);">      </div>
              <div class="stat-content">
                <p class="stat-label" style="color: rgba(255,255,255,0.9);">Total Hasil</p>
                <p class="stat-value" style="color: white;">${results.length}</p>
              </div>
            </div>
          </div>

          <div class="card">
            <h2 class="card-title">‚úÖ Koneksi Canva Sheet</h2>
            <div style="background: #d1fae5; padding: 20px; border-radius: 12px; border-left: 4px solid #10b981;">
              <p style="margin: 0; color: #065f46; font-weight: 700; font-size: 15px;">
                ‚úÖ Terhubung ke Canva Sheet dengan ${appData.length} record
              </p>
            </div>
          </div>

          <div class="card">
            <h2 class="card-title">üìä Sistem Ujian Online</h2>
            <p>Selamat datang, ${currentUser.name}! Gunakan menu di atas untuk mengelola sistem.</p>
          </div>
        `;
      } else if (currentUser.role === 'guru') {
        const myQuestions = questions.filter(q => q.question_created_by === currentUser.username);
        const myExams = exams.filter(e => e.exam_created_by === currentUser.username);

        content.innerHTML = `
          <div class="stats-grid">
            <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
              <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üìù</div>
              <div class="stat-content">
                <p class="stat-label" style="color: rgba(255,255,255,0.9);">Ujian Saya</p>
                <p class="stat-value" style="color: white;">${myExams.length}</p>
              </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
              <div class="stat-icon" style="background: rgba(255,255,255,0.2);">‚ùì</div>
              <div class="stat-content">
                <p class="stat-label" style="color: rgba(255,255,255,0.9);">Soal Saya</p>
                <p class="stat-value" style="color: white;">${myQuestions.length}</p>
              </div>
            </div>
          </div>

          <div class="card">
            <h2 class="card-title">üë®‚Äçüè´ Selamat Datang, ${currentUser.name}</h2>
            <div style="line-height: 2;">
              <p><strong>Mata Pelajaran:</strong> ${currentUser.subject || '-'}</p>
              <p><strong>NIP:</strong> ${currentUser.nip || '-'}</p>
              <p>Gunakan menu di samping untuk mengelola soal dan melihat hasil tes.</p>
            </div>
          </div>
        `;
      } else if (currentUser.role === 'siswa') {
        const myResults = results.filter(r => r.result_student_id === currentUser.username);
        const avgScore = myResults.length > 0 
          ? (myResults.reduce((sum, r) => sum + r.result_score, 0) / myResults.length).toFixed(1)
          : 0;

        content.innerHTML = `
          <div class="stats-grid">
            <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
              <div class="stat-icon" style="background: rgba(255,255,255,0.2);">‚úÖ</div>
              <div class="stat-content">
                <p class="stat-label" style="color: rgba(255,255,255,0.9);">Ujian Selesai</p>
                <p class="stat-value" style="color: white;">${myResults.length}</p>
              </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
              <div class="stat-icon" style="background: rgba(255,255,255,0.2);">  </div>
              <div class="stat-content">
                <p class="stat-label" style="color: rgba(255,255,255,0.9);">Rata-rata Nilai</p>
                <p class="stat-value" style="color: white;">${avgScore}</p>
              </div>
            </div>
          </div>

          <div class="card">
            <h2 class="card-title">Selamat Datang, ${currentUser.name}</h2>
            <div style="line-height: 2;">
              <p><strong>Kelas:</strong> ${currentUser.class || '-'}</p>
              <p><strong>NIS:</strong> ${currentUser.nis || '-'}</p>
              <p>Gunakan menu di samping untuk mengikuti ujian dan melihat hasil tes Anda.</p>
            </div>
          </div>
        `;
      }
    }

    function renderUsersPage() {
      document.getElementById('headerTitle').textContent = 'Kelola Pengguna';
      const content = document.getElementById('mainContent');

      const users = appData.filter(u => u.type === 'user');
      const admins = users.filter(u => u.role === 'admin');
      const teachers = users.filter(u => u.role === 'guru');
      const students = users.filter(u => u.role === 'siswa');

      content.innerHTML = `
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
          <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üëî</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Admin</p>
              <p class="stat-value" style="color: white;">${admins.length}</p>
            </div>
          </div>

          <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üìö</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Guru</p>
              <p class="stat-value" style="color: white;">${teachers.length}</p>
            </div>
          </div>

          <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üéì</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Siswa</p>
              <p class="stat-value" style="color: white;">${students.length}</p>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 class="card-title">
            <span>üë• Daftar Pengguna</span>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="showAddUserModal()" class="btn btn-success btn-sm">
                ‚ûï Tambah Pengguna
              </button>
              <button onclick="showBulkAddUserModal()" class="btn btn-info btn-sm">
                üìã Import Massal
              </button>
            </div>
          </h2>

          <!-- Filter & Search -->
          <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <div>
                <label class="form-label">Filter Role</label>
                <select id="filterRole" class="form-select" onchange="filterUsers()">
                  <option value="all">Semua Role</option>
                  <option value="admin">Admin</option>
                  <option value="guru">Guru</option>
                  <option value="siswa">Siswa</option>
                </select>
              </div>

              <div>
                <label class="form-label">Filter Kelas</label>
                <select id="filterClass" class="form-select" onchange="filterUsers()">
                  <option value="all">Semua Kelas</option>
                  <option value="7A">7A</option>
                  <option value="7B">7B</option>
                  <option value="7C">7C</option>
                  <option value="7D">7D</option>
                  <option value="8A">8A</option>
                  <option value="8B">8B</option>
                  <option value="8C">8C</option>
                  <option value="8D">8D</option>
                  <option value="9A">9A</option>
                  <option value="9B">9B</option>
                  <option value="9C">9C</option>
                  <option value="9D">9D</option>
                </select>
              </div>

              <div>
                <label class="form-label">Cari Pengguna</label>
                <input type="text" id="searchUser" class="form-input" placeholder="Nama atau username..." oninput="filterUsers()">
              </div>
            </div>

            <div style="margin-top: 16px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
              <button onclick="selectAllUsers()" class="btn btn-secondary btn-sm">
                ‚úÖ Pilih Semua
              </button>
              <button onclick="deselectAllUsers()" class="btn btn-secondary btn-sm">
                ‚ùå Batal Pilih
              </button>
              <button onclick="deleteSelectedUsers()" class="btn btn-danger btn-sm" id="deleteSelectedBtn" style="display: none;">
                üóëÔ∏è Hapus Terpilih (<span id="selectedCount">0</span>)
              </button>
            </div>
          </div>

          <!-- User List -->
          <div id="userListContainer">
            ${renderUserList(users)}
          </div>
        </div>
      `;
    }

    function renderUserList(usersToRender) {
      if (usersToRender.length === 0) {
        return `
          <div class="empty-state">
            <div class="empty-icon">üë•</div>
            <p class="empty-text">Tidak ada pengguna ditemukan</p>
          </div>
        `;
      }

      return `
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                <th style="padding: 12px; text-align: left; font-weight: 800; font-size: 13px; color: #6b7280;">
                  <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)" style="cursor: pointer;">
                </th>
                <th style="padding: 12px; text-align: left; font-weight: 800; font-size: 13px; color: #6b7280;">Nama</th>
                <th style="padding: 12px; text-align: left; font-weight: 800; font-size: 13px; color: #6b7280;">Username</th>
                <th style="padding: 12px; text-align: left; font-weight: 800; font-size: 13px; color: #6b7280;">Role</th>
                <th style="padding: 12px; text-align: left; font-weight: 800; font-size: 13px; color: #6b7280;">Info</th>
                <th style="padding: 12px; text-align: center; font-weight: 800; font-size: 13px; color: #6b7280;">Aksi</th>
              </tr>
            </thead>
            <tbody>
              ${usersToRender.map(user => `
                <tr style="border-bottom: 1px solid #e5e7eb;" class="user-row" data-user-id="${user.__backendId}">
                  <td style="padding: 12px;">
                    <input type="checkbox" class="user-checkbox" data-user-id="${user.__backendId}" 
                           onchange="updateSelectedCount()" style="cursor: pointer;"
                           ${user.role === 'admin' && user.username === currentUser.username ? 'disabled' : ''}>
                  </td>
                  <td style="padding: 12px;">
                    <div style="font-weight: 700; color: #1f2937;">${user.name}</div>
                  </td>
                  <td style="padding: 12px;">
                    <div style="font-family: monospace; color: #6b7280;">${user.username}</div>
                  </td>
                  <td style="padding: 12px;">
                    <span class="badge badge-${user.role}">${user.role.toUpperCase()}</span>
                  </td>
                  <td style="padding: 12px; font-size: 13px; color: #6b7280;">
                    ${user.role === 'siswa' ? `
                      <div><strong>Kelas:</strong> ${user.class || '-'}</div>
                      <div><strong>NIS:</strong> ${user.nis || '-'}</div>
                    ` : user.role === 'guru' ? `
                      <div><strong>Mapel:</strong> ${user.subject || '-'}</div>
                      <div><strong>NIP:</strong> ${user.nip || '-'}</div>
                    ` : '-'}
                  </td>
                  <td style="padding: 12px; text-align: center;">
                    <div style="display: flex; gap: 8px; justify-content: center;">
                      <button onclick="editUser('${user.__backendId}')" class="btn btn-info btn-sm" 
                              ${user.role === 'admin' && user.username === currentUser.username ? 'disabled' : ''}>
                        ‚úèÔ∏è Edit
                      </button>
                      ${user.role === 'admin' && user.username === currentUser.username ? '' : `
                        <button onclick="deleteUser('${user.__backendId}')" class="btn btn-danger btn-sm">
                          üóëÔ∏è
                        </button>
                      `}
                    </div>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function filterUsers() {
      const roleFilter = document.getElementById('filterRole').value;
      const classFilter = document.getElementById('filterClass').value;
      const searchQuery = document.getElementById('searchUser').value.toLowerCase();

      let users = appData.filter(u => u.type === 'user');

      if (roleFilter !== 'all') {
        users = users.filter(u => u.role === roleFilter);
      }

      if (classFilter !== 'all') {
        users = users.filter(u => u.class === classFilter);
      }

      if (searchQuery) {
        users = users.filter(u => 
          u.name.toLowerCase().includes(searchQuery) || 
          u.username.toLowerCase().includes(searchQuery)
        );
      }

      document.getElementById('userListContainer').innerHTML = renderUserList(users);
      updateSelectedCount();
    }

    function toggleSelectAll(checkbox) {
      const checkboxes = document.querySelectorAll('.user-checkbox:not([disabled])');
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
      updateSelectedCount();
    }

    function selectAllUsers() {
      const checkboxes = document.querySelectorAll('.user-checkbox:not([disabled])');
      checkboxes.forEach(cb => cb.checked = true);
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      if (selectAllCheckbox) selectAllCheckbox.checked = true;
      updateSelectedCount();
    }

    function deselectAllUsers() {
      const checkboxes = document.querySelectorAll('.user-checkbox');
      checkboxes.forEach(cb => cb.checked = false);
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');
      if (selectAllCheckbox) selectAllCheckbox.checked = false;
      updateSelectedCount();
    }

    function updateSelectedCount() {
      const selected = document.querySelectorAll('.user-checkbox:checked').length;
      const countEl = document.getElementById('selectedCount');
      const btnEl = document.getElementById('deleteSelectedBtn');
      
      if (countEl) countEl.textContent = selected;
      if (btnEl) btnEl.style.display = selected > 0 ? 'inline-flex' : 'none';
    }

    function showAddUserModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h2 class="modal-title">‚ûï Tambah Pengguna Baru</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>

          <form id="addUserForm">
            <div class="form-group">
              <label class="form-label" for="userRole">Role *</label>
              <select id="userRole" class="form-select" required onchange="toggleRoleFields()">
                <option value="">Pilih Role</option>
                <option value="guru">Guru</option>
                <option value="siswa">Siswa</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="userName">Nama Lengkap *</label>
              <input type="text" id="userName" class="form-input" required placeholder="Contoh: Aldo Wijaya">
            </div>

            <div class="form-group">
              <label class="form-label" for="userUsername">Username *</label>
              <input type="text" id="userUsername" class="form-input" required placeholder="Contoh: aldo.wijaya">
            </div>

            <div class="form-group">
              <label class="form-label" for="userPassword">Password *</label>
              <input type="password" id="userPassword" class="form-input" required placeholder="Minimal 6 karakter">
            </div>

            <!-- Guru Fields -->
            <div id="guruFields" style="display: none;">
              <div class="form-group">
                <label class="form-label" for="userSubject">Mata Pelajaran *</label>
                <select id="userSubject" class="form-select">
                  <option value="">Pilih Mata Pelajaran</option>
                  <option value="Pendidikan Agama dan Budi Pekerti">Pendidikan Agama dan Budi Pekerti</option>
                  <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                  <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                  <option value="Matematika">Matematika</option>
                  <option value="Ilmu Pengetahuan Alam (IPA)">Ilmu Pengetahuan Alam (IPA)</option>
                  <option value="Ilmu Pengetahuan Sosial (IPS)">Ilmu Pengetahuan Sosial (IPS)</option>
                  <option value="Bahasa Inggris">Bahasa Inggris</option>
                  <option value="Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)">Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)</option>
                  <option value="Informatika">Informatika</option>
                  <option value="Seni Budaya dan Prakarya">Seni Budaya dan Prakarya</option>
                  <option value="Bahasa Daerah">Bahasa Daerah</option>
                </select>
                `}
              </div>

              <div class="form-group">
                <label class="form-label" for="userNip">NIP</label>
                <input type="text" id="userNip" class="form-input" placeholder="Nomor Induk Pegawai">
              </div>
            </div>

            <!-- Siswa Fields -->
            <div id="siswaFields" style="display: none;">
              <div class="form-group">
                <label class="form-label" for="userClass">Kelas *</label>
                <select id="userClass" class="form-select">
                  <option value="">Pilih Kelas</option>
                  <option value="7A">7A</option>
                  <option value="7B">7B</option>
                  <option value="7C">7C</option>
                  <option value="7D">7D</option>
                  <option value="8A">8A</option>
                  <option value="8B">8B</option>
                  <option value="8C">8C</option>
                  <option value="8D">8D</option>
                  <option value="9A">9A</option>
                  <option value="9B">9B</option>
                  <option value="9C">9C</option>
                  <option value="9D">9D</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label" for="userNis">NIS</label>
                <input type="text" id="userNis" class="form-input" placeholder="Nomor Induk Siswa">
              </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button type="button" onclick="this.closest('.modal-overlay').remove()" 
                      class="btn btn-secondary" style="flex: 1;">
                Batal
              </button>
              <button type="submit" class="btn btn-success" style="flex: 1;" id="saveUserBtn">
                      Simpan
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('addUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveNewUser();
      });
    }

    function toggleRoleFields() {
      const role = document.getElementById('userRole').value;
      const guruFields = document.getElementById('guruFields');
      const siswaFields = document.getElementById('siswaFields');

      guruFields.style.display = role === 'guru' ? 'block' : 'none';
      siswaFields.style.display = role === 'siswa' ? 'block' : 'none';

      if (role === 'guru') {
        document.getElementById('userSubject').required = true;
        document.getElementById('userClass').required = false;
      } else if (role === 'siswa') {
        document.getElementById('userSubject').required = false;
        document.getElementById('userClass').required = true;
      }
    }

    async function saveNewUser() {
      const btn = document.getElementById('saveUserBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Menyimpan...';

      const role = document.getElementById('userRole').value;
      const name = document.getElementById('userName').value.trim();
      const username = document.getElementById('userUsername').value.trim();
      const password = document.getElementById('userPassword').value;

      // Check duplicate username
      const existingUser = appData.find(u => u.type === 'user' && u.username === username);
      if (existingUser) {
        showToast('Username sudah digunakan', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üíæ Simpan';
        return;
      }

      const userData = {
        type: 'user',
        username: username,
        password: password,
        name: name,
        role: role,
        class: role === 'siswa' ? document.getElementById('userClass').value : null,
        subject: role === 'guru' ? document.getElementById('userSubject').value : null,
        nip: role === 'guru' ? document.getElementById('userNip').value.trim() || null : null,
        nis: role === 'siswa' ? document.getElementById('userNis').value.trim() || null : null,
        created_at: new Date().toISOString()
      };

      const result = await window.dataSdk.create(userData);

      if (result.isOk) {
        showToast('‚úÖ Pengguna berhasil ditambahkan', 'success');
        document.querySelector('.modal-overlay').remove();
      } else {
        showToast('Gagal menambahkan pengguna', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üíæ Simpan';
      }
    }

    function showBulkAddUserModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
          <div class="modal-header">
            <h2 class="modal-title">üìã Import Pengguna Massal</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>

          <div style="background: #fef3c7; padding: 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #f59e0b;">
            <p style="margin: 0; color: #92400e; font-size: 14px; font-weight: 700;">
              üí° <strong>Petunjuk:</strong> Masukkan nama siswa, satu nama per baris.<br>
              Username dan password akan dibuat otomatis.
            </p>
          </div>

          <form id="bulkAddForm">
            <div class="form-group">
              <label class="form-label" for="bulkRole">Role *</label>
              <select id="bulkRole" class="form-select" required onchange="toggleBulkFields()">
                <option value="">Pilih Role</option>
                <option value="siswa">Siswa</option>
                <option value="guru">Guru</option>
              </select>
            </div>

            <!-- Bulk Siswa Fields -->
            <div id="bulkSiswaFields" style="display: none;">
              <div class="form-group">
                <label class="form-label" for="bulkClass">Kelas *</label>
                <select id="bulkClass" class="form-select">
                  <option value="">Pilih Kelas</option>
                  <option value="7A">7A</option>
                  <option value="7B">7B</option>
                  <option value="7C">7C</option>
                  <option value="7D">7D</option>
                  <option value="8A">8A</option>
                  <option value="8B">8B</option>
                  <option value="8C">8C</option>
                  <option value="8D">8D</option>
                  <option value="9A">9A</option>
                  <option value="9B">9B</option>
                  <option value="9C">9C</option>
                  <option value="9D">9D</option>
                </select>
              </div>
            </div>

            <!-- Bulk Guru Fields -->
            <div id="bulkGuruFields" style="display: none;">
              <div class="form-group">
                <label class="form-label" for="bulkSubject">Mata Pelajaran *</label>
                <select id="bulkSubject" class="form-select">
                  <option value="">Pilih Mata Pelajaran</option>
                  <option value="Pendidikan Agama dan Budi Pekerti">Pendidikan Agama dan Budi Pekerti</option>
                  <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                  <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                  <option value="Matematika">Matematika</option>
                  <option value="Ilmu Pengetahuan Alam (IPA)">Ilmu Pengetahuan Alam (IPA)</option>
                  <option value="Ilmu Pengetahuan Sosial (IPS)">Ilmu Pengetahuan Sosial (IPS)</option>
                  <option value="Bahasa Inggris">Bahasa Inggris</option>
                  <option value="Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)">Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)</option>
                  <option value="Informatika">Informatika</option>
                  <option value="Seni Budaya dan Prakarya">Seni Budaya dan Prakarya</option>
                  <option value="Bahasa Daerah">Bahasa Daerah</option>
                </select>
                `}
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="bulkNames">Daftar Nama *</label>
              <textarea id="bulkNames" class="form-textarea" required 
                        placeholder="ALDO WIJAYA&#10;ALMIRA PUSPA DEWI&#10;ANISA MAHARANI&#10;..."
                        style="min-height: 200px;"></textarea>
              <small style="color: #6b7280; display: block; margin-top: 8px;">
                üìù Satu nama per baris. Username akan dibuat otomatis dari nama.
              </small>
            </div>

            <div class="form-group">
              <label class="form-label" for="bulkPassword">Password Default *</label>
              <input type="text" id="bulkPassword" class="form-input" required value="12345678" 
                     placeholder="Password yang sama untuk semua pengguna">
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button type="button" onclick="this.closest('.modal-overlay').remove()" 
                      class="btn btn-secondary" style="flex: 1;">
                Batal
              </button>
              <button type="submit" class="btn btn-success" style="flex: 1;" id="saveBulkBtn">
                üíæ Import Semua
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('bulkAddForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveBulkUsers();
      });
    }

    function toggleBulkFields() {
      const role = document.getElementById('bulkRole').value;
      const siswaFields = document.getElementById('bulkSiswaFields');
      const guruFields = document.getElementById('bulkGuruFields');

      siswaFields.style.display = role === 'siswa' ? 'block' : 'none';
      guruFields.style.display = role === 'guru' ? 'block' : 'none';

      if (role === 'siswa') {
        document.getElementById('bulkClass').required = true;
        document.getElementById('bulkSubject').required = false;
      } else if (role === 'guru') {
        document.getElementById('bulkClass').required = false;
        document.getElementById('bulkSubject').required = true;
      }
    }

    async function saveBulkUsers() {
      const btn = document.getElementById('saveBulkBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Mengimport...';

      const role = document.getElementById('bulkRole').value;
      const names = document.getElementById('bulkNames').value.trim().split('\n').filter(n => n.trim());
      const password = document.getElementById('bulkPassword').value;
      const userClass = role === 'siswa' ? document.getElementById('bulkClass').value : null;
      const subject = role === 'guru' ? document.getElementById('bulkSubject').value : null;

      if (names.length === 0) {
        showToast('Tidak ada nama yang dimasukkan', 'warning');
        btn.disabled = false;
        btn.innerHTML = 'üíæ Import Semua';
        return;
      }

      let successCount = 0;
      let errorCount = 0;

      for (const name of names) {
        const cleanName = name.trim();
        if (!cleanName) continue;

        // Generate username from name
        const username = cleanName.toLowerCase()
          .replace(/\s+/g, '.')
          .replace(/[^a-z0-9.]/g, '');

        // Check duplicate
        const existingUser = appData.find(u => u.type === 'user' && u.username === username);
        if (existingUser) {
          errorCount++;
          continue;
        }

        const userData = {
          type: 'user',
          username: username,
          password: password,
          name: cleanName,
          role: role,
          class: userClass,
          subject: subject,
          nip: null,
          nis: null,
          created_at: new Date().toISOString()
        };

        const result = await window.dataSdk.create(userData);

        if (result.isOk) {
          successCount++;
        } else {
          errorCount++;
        }

        // Small delay to avoid overwhelming the system
        await new Promise(r => setTimeout(r, 100));
      }

      showToast(`‚úÖ Berhasil: ${successCount} | ‚ùå Gagal: ${errorCount}`, successCount > 0 ? 'success' : 'error');
      document.querySelector('.modal-overlay').remove();
    }

    async function editUser(userId) {
      const user = appData.find(u => u.__backendId === userId);
      if (!user) return;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <h2 class="modal-title">‚úè   Edit Pengguna</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>

          <form id="editUserForm">
            <div class="form-group">
              <label class="form-label">Role</label>
              <input type="text" class="form-input" value="${user.role.toUpperCase()}" disabled>
            </div>

            <div class="form-group">
              <label class="form-label" for="editName">Nama Lengkap *</label>
              <input type="text" id="editName" class="form-input" required value="${user.name}">
            </div>

            <div class="form-group">
              <label class="form-label" for="editUsername">Username *</label>
              <input type="text" id="editUsername" class="form-input" required value="${user.username}">
            </div>

            <div class="form-group">
              <label class="form-label" for="editPassword">Password Baru</label>
              <input type="password" id="editPassword" class="form-input" placeholder="Kosongkan jika tidak diubah">
              <small style="color: #6b7280; display: block; margin-top: 8px;">
                Biarkan kosong jika tidak ingin mengubah password
              </small>
            </div>

            ${user.role === 'siswa' ? `
              <div class="form-group">
                <label class="form-label" for="editClass">Kelas *</label>
                <select id="editClass" class="form-select" required>
                  <option value="7A" ${user.class === '7A' ? 'selected' : ''}>7A</option>
                  <option value="7B" ${user.class === '7B' ? 'selected' : ''}>7B</option>
                  <option value="7C" ${user.class === '7C' ? 'selected' : ''}>7C</option>
                  <option value="7D" ${user.class === '7D' ? 'selected' : ''}>7D</option>
                  <option value="8A" ${user.class === '8A' ? 'selected' : ''}>8A</option>
                  <option value="8B" ${user.class === '8B' ? 'selected' : ''}>8B</option>
                  <option value="8C" ${user.class === '8C' ? 'selected' : ''}>8C</option>
                  <option value="8D" ${user.class === '8D' ? 'selected' : ''}>8D</option>
                  <option value="9A" ${user.class === '9A' ? 'selected' : ''}>9A</option>
                  <option value="9B" ${user.class === '9B' ? 'selected' : ''}>9B</option>
                  <option value="9C" ${user.class === '9C' ? 'selected' : ''}>9C</option>
                  <option value="9D" ${user.class === '9D' ? 'selected' : ''}>9D</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label" for="editNis">NIS</label>
                <input type="text" id="editNis" class="form-input" value="${user.nis || ''}">
              </div>
            ` : ''}

            ${user.role === 'guru' ? `
              <div class="form-group">
                <label class="form-label" for="editSubject">Mata Pelajaran *</label>
                <select id="editSubject" class="form-select" required>
                  <option value="Pendidikan Agama dan Budi Pekerti" ${user.subject === 'Pendidikan Agama dan Budi Pekerti' ? 'selected' : ''}>Pendidikan Agama dan Budi Pekerti</option>
                  <option value="Pendidikan Pancasila" ${user.subject === 'Pendidikan Pancasila' ? 'selected' : ''}>Pendidikan Pancasila</option>
                  <option value="Bahasa Indonesia" ${user.subject === 'Bahasa Indonesia' ? 'selected' : ''}>Bahasa Indonesia</option>
                  <option value="Matematika" ${user.subject === 'Matematika' ? 'selected' : ''}>Matematika</option>
                  <option value="Ilmu Pengetahuan Alam (IPA)" ${user.subject === 'Ilmu Pengetahuan Alam (IPA)' ? 'selected' : ''}>Ilmu Pengetahuan Alam (IPA)</option>
                  <option value="Ilmu Pengetahuan Sosial (IPS)" ${user.subject === 'Ilmu Pengetahuan Sosial (IPS)' ? 'selected' : ''}>Ilmu Pengetahuan Sosial (IPS)</option>
                  <option value="Bahasa Inggris" ${user.subject === 'Bahasa Inggris' ? 'selected' : ''}>Bahasa Inggris</option>
                  <option value="Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)" ${user.subject === 'Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)' ? 'selected' : ''}>Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)</option>
                  <option value="Informatika" ${user.subject === 'Informatika' ? 'selected' : ''}>Informatika</option>
                  <option value="Seni Budaya dan Prakarya" ${user.subject === 'Seni Budaya dan Prakarya' ? 'selected' : ''}>Seni Budaya dan Prakarya</option>
                  <option value="Bahasa Daerah" ${user.subject === 'Bahasa Daerah' ? 'selected' : ''}>Bahasa Daerah</option>
                </select>
              </div>

              <div class="form-group">
                <label class="form-label" for="editNip">NIP</label>
                <input type="text" id="editNip" class="form-input" value="${user.nip || ''}">
              </div>
            ` : ''}

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button type="button" onclick="this.closest('.modal-overlay').remove()" 
                      class="btn btn-secondary" style="flex: 1;">
                Batal
              </button>
              <button type="submit" class="btn btn-success" style="flex: 1;" id="updateUserBtn">
                üíæ Update
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('editUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await updateUser(userId);
      });
    }

    async function updateUser(userId) {
      const user = appData.find(u => u.__backendId === userId);
      if (!user) return;

      const btn = document.getElementById('updateUserBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Mengupdate...';

      const newName = document.getElementById('editName').value.trim();
      const newUsername = document.getElementById('editUsername').value.trim();
      const newPassword = document.getElementById('editPassword').value;

      // Check duplicate username (except current user)
      const existingUser = appData.find(u => u.type === 'user' && u.username === newUsername && u.__backendId !== userId);
      if (existingUser) {
        showToast('Username sudah digunakan', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üíæ Update';
        return;
      }

      const updatedUser = {
        ...user,
        name: newName,
        username: newUsername,
        password: newPassword ? newPassword : user.password
      };

      if (user.role === 'siswa') {
        updatedUser.class = document.getElementById('editClass').value;
        updatedUser.nis = document.getElementById('editNis').value.trim() || null;
      } else if (user.role === 'guru') {
        updatedUser.subject = document.getElementById('editSubject').value;
        updatedUser.nip = document.getElementById('editNip').value.trim() || null;
      }

      const result = await window.dataSdk.update(updatedUser);

      if (result.isOk) {
        showToast('‚úÖ Pengguna berhasil diupdate', 'success');
        document.querySelector('.modal-overlay').remove();
      } else {
        showToast('Gagal mengupdate pengguna', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üíæ Update';
      }
    }

    async function deleteUser(userId) {
      const user = appData.find(u => u.__backendId === userId);
      if (!user) return;

      // Prevent deleting current admin
      if (user.role === 'admin' && user.username === currentUser.username) {
        showToast('Tidak dapat menghapus akun admin yang sedang login', 'error');
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; text-align: center;">
          <div style="font-size: 64px; margin-bottom: 16px;">‚ö†Ô∏è</div>
          <h3 style="margin: 0 0 12px;">Hapus Pengguna?</h3>
          <p style="margin: 0 0 8px; color: #1f2937; font-weight: 700;">${user.name}</p>
          <p style="margin: 0 0 24px; color: #6b7280;">
            Yakin ingin menghapus pengguna ini?<br>
            Aksi ini tidak dapat dibatalkan.
          </p>
          <div style="display: flex; gap: 12px;">
            <button onclick="this.closest('.modal-overlay').remove()" 
                    class="btn btn-secondary" style="flex: 1;">
              Batal
            </button>
            <button onclick="confirmDeleteUser('${userId}')" 
                    class="btn btn-danger" style="flex: 1;" id="confirmDeleteUserBtn">
              üóëÔ∏è Hapus
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function confirmDeleteUser(userId) {
      const user = appData.find(u => u.__backendId === userId);
      if (!user) return;

      const btn = document.getElementById('confirmDeleteUserBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Menghapus...';

      const result = await window.dataSdk.delete(user);

      if (result.isOk) {
        showToast('‚úÖ Pengguna berhasil dihapus', 'success');
        document.querySelector('.modal-overlay').remove();
      } else {
        showToast('Gagal menghapus pengguna', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üóë              Hapus';
      }
    }

    async function deleteSelectedUsers() {
      const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
      if (selectedCheckboxes.length === 0) {
        showToast('Tidak ada pengguna yang dipilih', 'warning');
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; text-align: center;">
          <div style="font-size: 64px; margin-bottom: 16px;">‚ö†Ô∏è</div>
          <h3 style="margin: 0 0 12px;">Hapus ${selectedCheckboxes.length} Pengguna?</h3>
          <p style="margin: 0 0 24px; color: #6b7280;">
            Yakin ingin menghapus ${selectedCheckboxes.length} pengguna yang dipilih?<br>
            Aksi ini tidak dapat dibatalkan.
          </p>
          <div style="display: flex; gap: 12px;">
            <button onclick="this.closest('.modal-overlay').remove()" 
                    class="btn btn-secondary" style="flex: 1;">
              Batal
            </button>
            <button onclick="confirmDeleteSelectedUsers()" 
                    class="btn btn-danger" style="flex: 1;" id="confirmDeleteSelectedBtn">
              üóëÔ∏è Hapus Semua
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function confirmDeleteSelectedUsers() {
      const selectedCheckboxes = document.querySelectorAll('.user-checkbox:checked');
      const btn = document.getElementById('confirmDeleteSelectedBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Menghapus...';

      let successCount = 0;
      let errorCount = 0;

      for (const checkbox of selectedCheckboxes) {
        const userId = checkbox.dataset.userId;
        const user = appData.find(u => u.__backendId === userId);
        
        if (user) {
          const result = await window.dataSdk.delete(user);
          if (result.isOk) {
            successCount++;
          } else {
            errorCount++;
          }
          await new Promise(r => setTimeout(r, 100));
        }
      }

      showToast(`‚úÖ Berhasil: ${successCount} | ‚ùå Gagal: ${errorCount}`, successCount > 0 ? 'success' : 'error');
      document.querySelector('.modal-overlay').remove();
    }

    function renderQuestionsPage() {
      document.getElementById('headerTitle').textContent = 'Kelola Soal';
      const content = document.getElementById('mainContent');

      const questions = appData.filter(q => q.type === 'question');
      const myQuestions = currentUser.role === 'guru' 
        ? questions.filter(q => q.question_subject === currentUser.subject)
        : questions;

      content.innerHTML = `
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
          <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üìù</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Total Soal</p>
              <p class="stat-value" style="color: white;">${myQuestions.length}</p>
            </div>
          </div>

          <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">‚úÖ</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Pilihan Ganda</p>
              <p class="stat-value" style="color: white;">${myQuestions.filter(q => q.question_type === 'multiple_choice').length}</p>
            </div>
          </div>

          <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üìÑ</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Essay</p>
              <p class="stat-value" style="color: white;">${myQuestions.filter(q => q.question_type === 'essay').length}</p>
            </div>
          </div>

          <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üîÄ</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Lainnya</p>
              <p class="stat-value" style="color: white;">${myQuestions.filter(q => q.question_type === 'true_false' || q.question_type === 'matching').length}</p>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 class="card-title">
            <span>üìù Kelola Bank Soal</span>
            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
              <button onclick="showAddQuestionModal()" class="btn btn-success btn-sm">
                ‚ûï Buat Soal
              </button>
              <button onclick="showBulkImportModal()" class="btn btn-info btn-sm">
                üìã Import Massal
              </button>
            </div>
          </h2>

          <!-- Filter & Search -->
          <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <div>
                <label class="form-label">Filter Kelas</label>
                <select id="filterQuestionClass" class="form-select" onchange="filterQuestions()">
                  <option value="all">Semua Kelas</option>
                  <option value="7">Kelas 7</option>
                  <option value="8">Kelas 8</option>
                  <option value="9">Kelas 9</option>
                </select>
              </div>

              <div>
                <label class="form-label">Filter Mata Pelajaran</label>
                <select id="filterQuestionSubject" class="form-select" onchange="filterQuestions()">
                  <option value="all">Semua Mapel</option>
                  <option value="Pendidikan Agama dan Budi Pekerti">Pendidikan Agama dan Budi Pekerti</option>
                  <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                  <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                  <option value="Matematika">Matematika</option>
                  <option value="Ilmu Pengetahuan Alam (IPA)">Ilmu Pengetahuan Alam (IPA)</option>
                  <option value="Ilmu Pengetahuan Sosial (IPS)">Ilmu Pengetahuan Sosial (IPS)</option>
                  <option value="Bahasa Inggris">Bahasa Inggris</option>
                  <option value="Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)">Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)</option>
                  <option value="Informatika">Informatika</option>
                  <option value="Seni Budaya dan Prakarya">Seni Budaya dan Prakarya</option>
                  <option value="Bahasa Daerah">Bahasa Daerah</option>
                </select>
                `}
              </div>

              <div>
                <label class="form-label">Filter Jenis Soal</label>
                <select id="filterQuestionType" class="form-select" onchange="filterQuestions()">
                  <option value="all">Semua Jenis</option>
                  <option value="multiple_choice">Pilihan Ganda</option>
                  <option value="essay">Essay</option>
                  <option value="true_false">Benar/Salah</option>
                  <option value="matching">Penjodohan</option>
                </select>
              </div>

              <div>
                <label class="form-label">Cari Soal</label>
                <input type="text" id="searchQuestion" class="form-input" placeholder="Cari pertanyaan..." oninput="filterQuestions()">
              </div>
            </div>

            <div style="margin-top: 16px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
              <button onclick="selectAllQuestions()" class="btn btn-secondary btn-sm">
                ‚òëÔ∏è Pilih Semua
              </button>
              <button onclick="deselectAllQuestions()" class="btn btn-secondary btn-sm">
                ‚òê Batal Pilih
              </button>
              <button onclick="deleteSelectedQuestions()" class="btn btn-danger btn-sm" id="deleteSelectedQuestionsBtn" style="display: none;">
                üóëÔ∏è Hapus Terpilih (<span id="selectedQuestionCount">0</span>)
              </button>
            </div>
          </div>

          <!-- Question List -->
          <div id="questionListContainer">
            ${renderQuestionList(myQuestions)}
          </div>
        </div>
      `;
    }

    function renderQuestionList(questionsToRender) {
      if (questionsToRender.length === 0) {
        return `
          <div class="empty-state">
            <div class="empty-icon">  </div>
            <p class="empty-text">Belum ada soal dibuat</p>
          </div>
        `;
      }

      const typeLabels = {
        multiple_choice: 'Pilihan Ganda',
        essay: 'Essay',
        true_false: 'Benar/Salah',
        matching: 'Penjodohan'
      };

      const typeBadges = {
        multiple_choice: 'success',
        essay: 'info',
        true_false: 'warning',
        matching: 'secondary'
      };

      return `
        <div style="display: grid; gap: 16px;">
          ${questionsToRender.map(q => {
            const questionData = JSON.parse(q.question_data);
            
            return `
              <div style="background: white; border: 2px solid #e5e7eb; border-radius: 16px; padding: 20px;">
                <div style="display: flex; gap: 16px; align-items: start;">
                  <input type="checkbox" class="question-checkbox" data-question-id="${q.__backendId}" 
                         onchange="updateSelectedQuestionCount()" style="cursor: pointer; margin-top: 4px;">
                  
                  <div style="flex: 1;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;">
                      <span class="badge badge-${typeBadges[q.question_type]}">${typeLabels[q.question_type]}</span>
                      <span class="badge badge-info">${q.question_subject}</span>
                      <span class="badge badge-secondary">Kelas ${q.question_class}</span>
                      <span class="badge badge-warning">${q.question_points} Poin</span>
                    </div>

                    <div style="font-weight: 700; color: #1f2937; margin-bottom: 12px; line-height: 1.6;">
                      ${questionData.question_text}
                    </div>

                    ${questionData.question_image_url ? `
                      <div style="margin-bottom: 12px;">
                        <img src="${questionData.question_image_url}" 
                             style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 2px solid #e5e7eb;"
                             onerror="this.style.display='none';">
                      </div>
                    ` : ''}

                    ${q.question_type === 'multiple_choice' ? `
                      <div style="display: grid; gap: 8px; margin-top: 12px;">
                        ${questionData.options.map((opt, idx) => `
                          <div style="display: flex; align-items: start; gap: 8px; padding: 8px; background: ${opt.is_correct ? '#d1fae5' : '#f9fafb'}; border-radius: 8px; border: 2px solid ${opt.is_correct ? '#10b981' : '#e5e7eb'};">
                            <span style="font-weight: 900; color: ${opt.is_correct ? '#065f46' : '#6b7280'};">${String.fromCharCode(65 + idx)}.</span>
                            <span style="flex: 1; color: ${opt.is_correct ? '#065f46' : '#374151'};">${opt.text}</span>
                            ${opt.is_correct ? '<span style="color: #10b981; font-weight: 900;">‚úì</span>' : ''}
                          </div>
                        `).join('')}
                      </div>
                    ` : ''}

                    ${q.question_type === 'essay' ? `
                      <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-top: 12px;">
                        <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">
                          <strong>Metode Penilaian:</strong> ${questionData.grading_method === 'manual' ? 'Manual oleh Guru' : 'Kata Kunci Otomatis'}
                        </div>
                        ${questionData.grading_method === 'keyword' ? `
                          <div style="font-size: 13px; color: #6b7280;">
                            <strong>Kata Kunci:</strong> ${questionData.keywords.join(', ')}
                          </div>
                        ` : ''}
                      </div>
                    ` : ''}

                    ${q.question_type === 'true_false' ? `
                      <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-top: 12px; font-weight: 700;">
                        <span style="color: #6b7280;">Jawaban:</span>
                        <span style="color: ${questionData.correct_answer ? '#10b981' : '#ef4444'}; margin-left: 8px;">
                          ${questionData.correct_answer ? '‚úì BENAR' : '‚úó SALAH'}
                        </span>
                      </div>
                    ` : ''}

                    ${q.question_type === 'matching' ? `
                      <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-top: 12px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                          <div>
                            <div style="font-weight: 700; color: #6b7280; margin-bottom: 8px; font-size: 13px;">KOLOM KIRI:</div>
                            ${questionData.pairs.map((p, i) => `
                              <div style="padding: 8px; background: white; border-radius: 6px; margin-bottom: 4px; font-size: 14px;">
                                ${i + 1}. ${p.left}
                              </div>
                            `).join('')}
                          </div>
                          <div>
                            <div style="font-weight: 700; color: #6b7280; margin-bottom: 8px; font-size: 13px;">KOLOM KANAN:</div>
                            ${questionData.pairs.map((p, i) => `
                              <div style="padding: 8px; background: white; border-radius: 6px; margin-bottom: 4px; font-size: 14px;">
                                ${String.fromCharCode(65 + i)}. ${p.right}
                              </div>
                            `).join('')}
                          </div>
                        </div>
                      </div>
                    ` : ''}

                    <div style="font-size: 12px; color: #9ca3af; margin-top: 12px;">
                      Dibuat oleh: <strong>${q.question_created_by}</strong> ‚Ä¢ 
                      ${new Date(q.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}
                    </div>
                  </div>

                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button onclick="viewQuestion('${q.__backendId}')" class="btn btn-info btn-sm">
                      üëÅÔ∏è
                    </button>
                    <button onclick="editQuestion('${q.__backendId}')" class="btn btn-warning btn-sm">
                      ‚úèÔ∏è
                    </button>
                    <button onclick="deleteQuestion('${q.__backendId}')" class="btn btn-danger btn-sm">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function filterQuestions() {
      const classFilter = document.getElementById('filterQuestionClass').value;
      const subjectFilter = document.getElementById('filterQuestionSubject').value;
      const typeFilter = document.getElementById('filterQuestionType').value;
      const searchQuery = document.getElementById('searchQuestion').value.toLowerCase();

      let questions = appData.filter(q => q.type === 'question');
      
      if (currentUser.role === 'guru') {
        questions = questions.filter(q => q.question_created_by === currentUser.username);
      }

      if (classFilter !== 'all') {
        questions = questions.filter(q => q.question_class === classFilter);
      }

      if (subjectFilter !== 'all') {
        questions = questions.filter(q => q.question_subject === subjectFilter);
      }

      if (typeFilter !== 'all') {
        questions = questions.filter(q => q.question_type === typeFilter);
      }

      if (searchQuery) {
        questions = questions.filter(q => {
          const questionData = JSON.parse(q.question_data);
          return questionData.question_text.toLowerCase().includes(searchQuery);
        });
      }

      document.getElementById('questionListContainer').innerHTML = renderQuestionList(questions);
      updateSelectedQuestionCount();
    }

    function selectAllQuestions() {
      const checkboxes = document.querySelectorAll('.question-checkbox');
      checkboxes.forEach(cb => cb.checked = true);
      updateSelectedQuestionCount();
    }

    function deselectAllQuestions() {
      const checkboxes = document.querySelectorAll('.question-checkbox');
      checkboxes.forEach(cb => cb.checked = false);
      updateSelectedQuestionCount();
    }

    function updateSelectedQuestionCount() {
      const selected = document.querySelectorAll('.question-checkbox:checked').length;
      const countEl = document.getElementById('selectedQuestionCount');
      const btnEl = document.getElementById('deleteSelectedQuestionsBtn');
      
      if (countEl) countEl.textContent = selected;
      if (btnEl) btnEl.style.display = selected > 0 ? 'inline-flex' : 'none';
    }

    function showAddQuestionModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 900px;">
          <div class="modal-header">
            <h2 class="modal-title">‚ûï Buat Soal Baru</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>

          <form id="addQuestionForm">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="questionType">Jenis Soal *</label>
                <select id="questionType" class="form-select" required onchange="toggleQuestionFields()">
                  <option value="">Pilih Jenis</option>
                  <option value="multiple_choice">Pilihan Ganda</option>
                  <option value="essay">Essay</option>
                  <option value="true_false">Benar/Salah</option>
                  <option value="matching">Penjodohan</option>
                </select>
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="questionSubject">Mata Pelajaran *</label>
                ${currentUser.role === 'guru' ? `
                  <input type="text" id="questionSubject" class="form-input" value="${currentUser.subject}" readonly 
                         style="background: #f3f4f6; cursor: not-allowed;">
                ` : `
                  <select id="questionSubject" class="form-select" required>
                    <option value="">Pilih Mapel</option>
                    <option value="Pendidikan Agama dan Budi Pekerti">Pendidikan Agama dan Budi Pekerti</option>
                  <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                  <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                  <option value="Matematika">Matematika</option>
                  <option value="Ilmu Pengetahuan Alam (IPA)">Ilmu Pengetahuan Alam (IPA)</option>
                  <option value="Ilmu Pengetahuan Sosial (IPS)">Ilmu Pengetahuan Sosial (IPS)</option>
                  <option value="Bahasa Inggris">Bahasa Inggris</option>
                  <option value="Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)">Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)</option>
                  <option value="Informatika">Informatika</option>
                  <option value="Seni Budaya dan Prakarya">Seni Budaya dan Prakarya</option>
                  <option value="Bahasa Daerah">Bahasa Daerah</option>
                </select>
                `}
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="questionClass">Kelas *</label>
                <select id="questionClass" class="form-select" required>
                  <option value="">Pilih Kelas</option>
                  <option value="7">Kelas 7 (7A, 7B, 7C, 7D)</option>
                  <option value="8">Kelas 8 (8A, 8B, 8C, 8D)</option>
                  <option value="9">Kelas 9 (9A, 9B, 9C, 9D)</option>
                </select>
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="questionPoints">Poin *</label>
                <input type="number" id="questionPoints" class="form-input" required value="2" min="1" max="100">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="questionText">Pertanyaan *</label>
              <textarea id="questionText" class="form-textarea" required placeholder="Tuliskan pertanyaan di sini..."></textarea>
            </div>

            <div class="form-group">
              <label class="form-label" for="questionImageUrl">URL Gambar Soal (Opsional)</label>
              <input type="url" id="questionImageUrl" class="form-input" placeholder="https://example.com/image.jpg">
            </div>

            <!-- Multiple Choice Fields -->
            <div id="multipleChoiceFields" style="display: none;">
              <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 16px;">
                <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 900;">Pilihan Jawaban</h3>
                
                <div id="optionsContainer">
                  <div class="option-item" style="margin-bottom: 16px;">
                    <div style="display: flex; gap: 12px; align-items: start;">
                      <input type="radio" name="correctAnswer" value="0" style="margin-top: 12px; cursor: pointer;">
                      <div style="flex: 1;">
                        <textarea class="form-textarea option-text" placeholder="Opsi A" style="min-height: 60px;"></textarea>
                        <input type="url" class="form-input option-image" placeholder="URL Gambar untuk opsi A (opsional)" style="margin-top: 8px;">
                      </div>
                    </div>
                  </div>

                  <div class="option-item" style="margin-bottom: 16px;">
                    <div style="display: flex; gap: 12px; align-items: start;">
                      <input type="radio" name="correctAnswer" value="1" style="margin-top: 12px; cursor: pointer;">
                      <div style="flex: 1;">
                        <textarea class="form-textarea option-text" placeholder="Opsi B" style="min-height: 60px;"></textarea>
                        <input type="url" class="form-input option-image" placeholder="URL Gambar untuk opsi B (opsional)" style="margin-top: 8px;">
                      </div>
                    </div>
                  </div>

                  <div class="option-item" style="margin-bottom: 16px;">
                    <div style="display: flex; gap: 12px; align-items: start;">
                      <input type="radio" name="correctAnswer" value="2" style="margin-top: 12px; cursor: pointer;">
                      <div style="flex: 1;">
                        <textarea class="form-textarea option-text" placeholder="Opsi C" style="min-height: 60px;"></textarea>
                        <input type="url" class="form-input option-image" placeholder="URL Gambar untuk opsi C (opsional)" style="margin-top: 8px;">
                      </div>
                    </div>
                  </div>

                  <div class="option-item" style="margin-bottom: 16px;">
                    <div style="display: flex; gap: 12px; align-items: start;">
                      <input type="radio" name="correctAnswer" value="3" style="margin-top: 12px; cursor: pointer;">
                      <div style="flex: 1;">
                        <textarea class="form-textarea option-text" placeholder="Opsi D" style="min-height: 60px;"></textarea>
                        <input type="url" class="form-input option-image" placeholder="URL Gambar untuk opsi D (opsional)" style="margin-top: 8px;">
                      </div>
                    </div>
                  </div>
                </div>

                <button type="button" onclick="addOption()" class="btn btn-secondary btn-sm">
                  ‚ûï Tambah Opsi E
                </button>
              </div>
            </div>

            <!-- Essay Fields -->
            <div id="essayFields" style="display: none;">
              <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                <div class="form-group">
                  <label class="form-label" for="gradingMethod">Metode Penilaian *</label>
                  <select id="gradingMethod" class="form-select" onchange="toggleKeywordField()">
                    <option value="manual">Manual oleh Guru</option>
                    <option value="keyword">Kata Kunci Otomatis</option>
                  </select>
                </div>

                <div id="keywordField" style="display: none;">
                  <label class="form-label" for="keywords">Kata Kunci (pisahkan dengan koma)</label>
                  <input type="text" id="keywords" class="form-input" placeholder="contoh: abstraksi, algoritma, dekomposisi">
                </div>
              </div>
            </div>

            <!-- True/False Fields -->
            <div id="trueFalseFields" style="display: none;">
              <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                <label class="form-label">Jawaban yang Benar *</label>
                <div style="display: flex; gap: 16px;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="trueFalseAnswer" value="true" style="cursor: pointer;">
                    <span style="font-weight: 700; color: #10b981;">‚úì BENAR</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="trueFalseAnswer" value="false" style="cursor: pointer;">
                    <span style="font-weight: 700; color: #ef4444;">   SALAH</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- Matching Fields -->
            <div id="matchingFields" style="display: none;">
              <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 900;">Pasangan (Minimal 3 pasang)</h3>
                
                <div id="pairsContainer">
                  <div class="pair-item" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: start;">
                    <input type="text" class="form-input pair-left" placeholder="Kolom Kiri 1" required>
                    <input type="text" class="form-input pair-right" placeholder="Kolom Kanan 1" required>
                    <div style="width: 40px;"></div>
                  </div>

                  <div class="pair-item" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: start;">
                    <input type="text" class="form-input pair-left" placeholder="Kolom Kiri 2" required>
                    <input type="text" class="form-input pair-right" placeholder="Kolom Kanan 2" required>
                    <div style="width: 40px;"></div>
                  </div>

                  <div class="pair-item" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: start;">
                    <input type="text" class="form-input pair-left" placeholder="Kolom Kiri 3" required>
                    <input type="text" class="form-input pair-right" placeholder="Kolom Kanan 3" required>
                    <div style="width: 40px;"></div>
                  </div>
                </div>

                <button type="button" onclick="addPair()" class="btn btn-secondary btn-sm">
                  ‚ûï Tambah Pasangan
                </button>

                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-top: 16px; border-left: 4px solid #f59e0b;">
                  <p style="margin: 0; color: #92400e; font-size: 13px; font-weight: 700;">
                       Poin maksimal = jumlah pasangan √ó 1 poin per pasangan benar
                  </p>
                </div>
              </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button type="button" onclick="this.closest('.modal-overlay').remove()" 
                      class="btn btn-secondary" style="flex: 1;">
                Batal
              </button>
              <button type="submit" class="btn btn-success" style="flex: 1;" id="saveQuestionBtn">
                üíæ Simpan Soal
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('addQuestionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveNewQuestion();
      });
    }

    function toggleQuestionFields() {
      const type = document.getElementById('questionType').value;
      
      document.getElementById('multipleChoiceFields').style.display = type === 'multiple_choice' ? 'block' : 'none';
      document.getElementById('essayFields').style.display = type === 'essay' ? 'block' : 'none';
      document.getElementById('trueFalseFields').style.display = type === 'true_false' ? 'block' : 'none';
      document.getElementById('matchingFields').style.display = type === 'matching' ? 'block' : 'none';

      // Update points default
      const pointsInput = document.getElementById('questionPoints');
      if (type === 'matching') {
        pointsInput.value = 3;
      } else {
        pointsInput.value = 2;
      }
    }

    function toggleKeywordField() {
      const method = document.getElementById('gradingMethod').value;
      document.getElementById('keywordField').style.display = method === 'keyword' ? 'block' : 'none';
    }

    function addOption() {
      const container = document.getElementById('optionsContainer');
      const currentOptions = container.querySelectorAll('.option-item').length;
      
      if (currentOptions >= 5) {
        showToast('Maksimal 5 opsi jawaban', 'warning');
        return;
      }

      const optionLetter = String.fromCharCode(65 + currentOptions);
      const newOption = document.createElement('div');
      newOption.className = 'option-item';
      newOption.style.marginBottom = '16px';
      newOption.innerHTML = `
        <div style="display: flex; gap: 12px; align-items: start;">
          <input type="radio" name="correctAnswer" value="${currentOptions}" style="margin-top: 12px; cursor: pointer;">
          <div style="flex: 1;">
            <textarea class="form-textarea option-text" placeholder="Opsi ${optionLetter}" style="min-height: 60px;"></textarea>
            <input type="url" class="form-input option-image" placeholder="URL Gambar untuk opsi ${optionLetter} (opsional)" style="margin-top: 8px;">
          </div>
          <button type="button" onclick="this.closest('.option-item').remove()" class="btn btn-danger btn-sm">
            üóëÔ∏è
          </button>
        </div>
      `;
      
      container.appendChild(newOption);
    }

    function addPair() {
      const container = document.getElementById('pairsContainer');
      const currentPairs = container.querySelectorAll('.pair-item').length + 1;
      
      const newPair = document.createElement('div');
      newPair.className = 'pair-item';
      newPair.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: start;';
      newPair.innerHTML = `
        <input type="text" class="form-input pair-left" placeholder="Kolom Kiri ${currentPairs}" required>
        <input type="text" class="form-input pair-right" placeholder="Kolom Kanan ${currentPairs}" required>
        <button type="button" onclick="this.closest('.pair-item').remove()" class="btn btn-danger btn-sm">
          üóëÔ∏è
        </button>
      `;
      
      container.appendChild(newPair);
    }

    async function saveNewQuestion() {
      const btn = document.getElementById('saveQuestionBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Menyimpan...';

      const type = document.getElementById('questionType').value;
      const subjectElement = document.getElementById('questionSubject');
      const subject = subjectElement.tagName === 'INPUT' ? subjectElement.value : subjectElement.value;
      const classLevel = document.getElementById('questionClass').value;
      const points = parseInt(document.getElementById('questionPoints').value);
      const questionText = document.getElementById('questionText').value.trim();
      const questionImageUrl = document.getElementById('questionImageUrl').value.trim();

      let questionData = {
        question_text: questionText,
        question_image_url: questionImageUrl || null
      };

      // Validate based on type
      if (type === 'multiple_choice') {
        const options = [];
        const optionTexts = document.querySelectorAll('.option-text');
        const optionImages = document.querySelectorAll('.option-image');
        const correctAnswer = document.querySelector('input[name="correctAnswer"]:checked');

        if (!correctAnswer) {
          showToast('Pilih jawaban yang benar', 'error');
          btn.disabled = false;
          btn.innerHTML = 'üíæ Simpan Soal';
          return;
        }

        optionTexts.forEach((opt, idx) => {
          const text = opt.value.trim();
          if (text) {
            options.push({
              text: text,
              image_url: optionImages[idx].value.trim() || null,
              is_correct: idx === parseInt(correctAnswer.value)
            });
          }
        });

        if (options.length < 2) {
          showToast('Minimal 2 opsi jawaban', 'error');
          btn.disabled = false;
          btn.innerHTML = 'üíæ Simpan Soal';
          return;
        }

        questionData.options = options;

      } else if (type === 'essay') {
        const method = document.getElementById('gradingMethod').value;
        questionData.grading_method = method;
        
        if (method === 'keyword') {
          const keywords = document.getElementById('keywords').value.trim();
          questionData.keywords = keywords ? keywords.split(',').map(k => k.trim()) : [];
        }

      } else if (type === 'true_false') {
        const answer = document.querySelector('input[name="trueFalseAnswer"]:checked');
        
        if (!answer) {
          showToast('Pilih jawaban yang benar', 'error');
          btn.disabled = false;
          btn.innerHTML = 'üíæ Simpan Soal';
          return;
        }

        questionData.correct_answer = answer.value === 'true';

      } else if (type === 'matching') {
        const pairs = [];
        const pairLefts = document.querySelectorAll('.pair-left');
        const pairRights = document.querySelectorAll('.pair-right');

        pairLefts.forEach((left, idx) => {
          const leftText = left.value.trim();
          const rightText = pairRights[idx].value.trim();
          
          if (leftText && rightText) {
            pairs.push({
              left: leftText,
              right: rightText
            });
          }
        });

        if (pairs.length < 3) {
          showToast('Minimal 3 pasangan untuk soal penjodohan', 'error');
          btn.disabled = false;
          btn.innerHTML = 'üíæ Simpan Soal';
          return;
        }

        questionData.pairs = pairs;
      }

      const result = await window.dataSdk.create({
        type: 'question',
        question_type: type,
        question_subject: subject,
        question_class: classLevel,
        question_points: points,
        question_data: JSON.stringify(questionData),
        question_created_by: currentUser.username,
        created_at: new Date().toISOString()
      });

      if (result.isOk) {
        showToast('‚úÖ Soal berhasil disimpan', 'success');
        document.querySelector('.modal-overlay').remove();
      } else {
        showToast('Gagal menyimpan soal', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üíæ Simpan Soal';
      }
    }

    function showBulkImportModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h2 class="modal-title">    Import Soal Massal (Pilihan Ganda)</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>

          <div style="background: #dbeafe; padding: 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
            <p style="margin: 0 0 12px; color: #1e40af; font-size: 14px; font-weight: 700;">
              üí° <strong>Format Import:</strong>
            </p>
            <pre style="background: white; padding: 12px; border-radius: 8px; overflow-x: auto; margin: 0; font-size: 13px; line-height: 1.6;">17. Saat kita menggambarkan seekor anjing...
A. Anjing berlari dengan cepat
B. Anjing memiliki kuku
C. Anjing memiliki hidung
D. Anjing memiliki telinga
jawaban A

18. Saat kita menggambarkan sebuah mobil...
A. pemilik mobil
B. penjual mobil
C. apakah mobil memiliki rodat
D. besar pajak tahunan mobil
jawaban C</pre>
            <p style="margin: 12px 0 0; color: #1e40af; font-size: 13px;">
                        Bisa dengan nomor atau tanpa nomor<br>
              ‚úì Opsi minimal A-D, bisa sampai E<br>
              ‚úì Tulis "jawaban X" di baris terakhir setiap soal
            </p>
          </div>

          <form id="bulkImportForm">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px;">
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="bulkSubject">Mata Pelajaran *</label>
                ${currentUser.role === 'guru' ? `
                  <input type="text" id="bulkSubject" class="form-input" value="${currentUser.subject}" readonly 
                         style="background: #f3f4f6; cursor: not-allowed;">
                ` : `
                  <select id="bulkSubject" class="form-select" required>
                    <option value="">Pilih Mapel</option>
                    <option value="Pendidikan Agama dan Budi Pekerti">Pendidikan Agama dan Budi Pekerti</option>
                  <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                  <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                  <option value="Matematika">Matematika</option>
                  <option value="Ilmu Pengetahuan Alam (IPA)">Ilmu Pengetahuan Alam (IPA)</option>
                  <option value="Ilmu Pengetahuan Sosial (IPS)">Ilmu Pengetahuan Sosial (IPS)</option>
                  <option value="Bahasa Inggris">Bahasa Inggris</option>
                  <option value="Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)">Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)</option>
                  <option value="Informatika">Informatika</option>
                  <option value="Seni Budaya dan Prakarya">Seni Budaya dan Prakarya</option>
                  <option value="Bahasa Daerah">Bahasa Daerah</option>
                </select>
                `}
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="bulkClass">Kelas *</label>
                <select id="bulkClass" class="form-select" required>
                  <option value="">Pilih Kelas</option>
                  <option value="7">Kelas 7</option>
                  <option value="8">Kelas 8</option>
                  <option value="9">Kelas 9</option>
                </select>
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="bulkPoints">Poin per Soal *</label>
                <input type="number" id="bulkPoints" class="form-input" required value="2" min="1" max="100">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="bulkQuestions">Soal-soal *</label>
              <textarea id="bulkQuestions" class="form-textarea" required 
                        placeholder="Paste soal-soal di sini sesuai format..."
                        style="min-height: 300px; font-family: monospace;"></textarea>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button type="button" onclick="this.closest('.modal-overlay').remove()" 
                      class="btn btn-secondary" style="flex: 1;">
                Batal
              </button>
              <button type="submit" class="btn btn-success" style="flex: 1;" id="importBulkBtn">
                üì• Import Soal
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('bulkImportForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await importBulkQuestions();
      });
    }

    async function importBulkQuestions() {
      const btn = document.getElementById('importBulkBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Mengimport...';

      const subjectElement = document.getElementById('bulkSubject');
      const subject = subjectElement.tagName === 'INPUT' ? subjectElement.value : subjectElement.value;
      const classLevel = document.getElementById('bulkClass').value;
      const points = parseInt(document.getElementById('bulkPoints').value);
      const rawText = document.getElementById('bulkQuestions').value.trim();

      // Split by double line break OR by question numbers
      let questionBlocks = rawText.split(/\n\s*\n/).filter(b => b.trim());
      
      // If no double line breaks, try splitting by question numbers
      if (questionBlocks.length === 1) {
        questionBlocks = rawText.split(/(?=\d+\.\s)/).filter(b => b.trim());
      }
      
      let successCount = 0;
      let errorCount = 0;
      let errorMessages = [];

      for (let blockIndex = 0; blockIndex < questionBlocks.length; blockIndex++) {
        const block = questionBlocks[blockIndex];
        const lines = block.split('\n').map(l => l.trim()).filter(l => l);
        
        if (lines.length < 3) {
          errorCount++;
          errorMessages.push(`Blok ${blockIndex + 1}: Terlalu sedikit baris (min 3)`);
          continue;
        }

        // Find question text (first line, remove number if exists)
        let questionText = lines[0].replace(/^\d+\.\s*/, '').trim();
        
        if (!questionText) {
          errorCount++;
          errorMessages.push(`Blok ${blockIndex + 1}: Pertanyaan kosong`);
          continue;
        }
        
        // Find answer line (could be at the end or mixed with options)
        let answerLine = null;
        let answerLineIndex = -1;
        
        for (let i = lines.length - 1; i >= 0; i--) {
          if (lines[i].toLowerCase().includes('jawaban')) {
            answerLine = lines[i];
            answerLineIndex = i;
            break;
          }
        }
        
        if (!answerLine) {
          errorCount++;
          errorMessages.push(`Blok ${blockIndex + 1}: Tidak ada baris jawaban`);
          continue;
        }

        const answerMatch = answerLine.match(/jawaban\s*[:=]?\s*([A-E])/i);
        
        if (!answerMatch) {
          errorCount++;
          errorMessages.push(`Blok ${blockIndex + 1}: Format jawaban salah (gunakan: jawaban A)`);
          continue;
        }

        const correctAnswerLetter = answerMatch[1].toUpperCase();
        const correctAnswerIndex = correctAnswerLetter.charCodeAt(0) - 65;

        // Parse options (between question and answer line)
        const options = [];
        const startIdx = 1; // Start after question
        const endIdx = answerLineIndex > 0 ? answerLineIndex : lines.length - 1;
        
        for (let i = startIdx; i < endIdx; i++) {
          const line = lines[i];
          
          // Skip if it's the answer line
          if (line.toLowerCase().includes('jawaban')) continue;
          
          const optionMatch = line.match(/^([A-E])\.\s*(.+)/i);
          
          if (optionMatch) {
            const optionLetter = optionMatch[1].toUpperCase();
            const optionText = optionMatch[2].trim();
            const optionIndex = optionLetter.charCodeAt(0) - 65;
            
            if (optionText) {
              options.push({
                text: optionText,
                image_url: null,
                is_correct: optionIndex === correctAnswerIndex
              });
            }
          }
        }

        if (options.length < 2) {
          errorCount++;
          errorMessages.push(`Blok ${blockIndex + 1}: Minimal 2 opsi (hanya ${options.length} ditemukan)`);
          continue;
        }

        // Check if correct answer exists in options
        const hasCorrectAnswer = options.some(opt => opt.is_correct);
        if (!hasCorrectAnswer) {
          errorCount++;
          errorMessages.push(`Blok ${blockIndex + 1}: Jawaban ${correctAnswerLetter} tidak ada dalam opsi`);
          continue;
        }

        const questionData = {
          question_text: questionText,
          question_image_url: null,
          options: options
        };

        const result = await window.dataSdk.create({
          type: 'question',
          question_type: 'multiple_choice',
          question_subject: subject,
          question_class: classLevel,
          question_points: points,
          question_data: JSON.stringify(questionData),
          question_created_by: currentUser.username,
          created_at: new Date().toISOString()
        });

        if (result.isOk) {
          successCount++;
        } else {
          errorCount++;
          errorMessages.push(`Blok ${blockIndex + 1}: Gagal menyimpan ke database`);
        }

        await new Promise(r => setTimeout(r, 100));
      }

      // Show detailed results
      if (errorCount > 0 && errorMessages.length > 0) {
        console.log('Import Errors:', errorMessages);
      }

      if (successCount > 0) {
        showToast(`‚úÖ Berhasil: ${successCount} soal | ‚ùå Gagal: ${errorCount} soal`, 'success');
      } else {
        showToast(`‚ùå Import gagal! ${errorCount} soal gagal diimport. Periksa format soal.`, 'error');
      }
      
      document.querySelector('.modal-overlay').remove();
    }

    function viewQuestion(questionId) {
      const question = appData.find(q => q.__backendId === questionId);
      if (!question) return;

      const questionData = JSON.parse(question.question_data);
      const typeLabels = {
        multiple_choice: 'Pilihan Ganda',
        essay: 'Essay',
        true_false: 'Benar/Salah',
        matching: 'Penjodohan'
      };

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h2 class="modal-title">üëÅÔ∏è Detail Soal</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>

          <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
              <span class="badge badge-info">${typeLabels[question.question_type]}</span>
              <span class="badge badge-success">${question.question_subject}</span>
              <span class="badge badge-secondary">Kelas ${question.question_class}</span>
              <span class="badge badge-warning">${question.question_points} Poin</span>
            </div>

            <div style="font-weight: 700; font-size: 18px; color: #1f2937; margin-bottom: 16px; line-height: 1.6;">
              ${questionData.question_text}
            </div>

            ${questionData.question_image_url ? `
              <div style="margin-bottom: 16px;">
                <img src="${questionData.question_image_url}" 
                     style="max-width: 100%; max-height: 400px; border-radius: 12px; border: 2px solid #e5e7eb;"
                     onerror="this.style.display='none';">
              </div>
            ` : ''}

            ${question.question_type === 'multiple_choice' ? `
              <div style="margin-top: 24px;">
                <h3 style="font-size: 16px; font-weight: 900; margin-bottom: 12px;">Pilihan Jawaban:</h3>
                ${questionData.options.map((opt, idx) => `
                  <div style="display: flex; align-items: start; gap: 12px; padding: 16px; background: ${opt.is_correct ? '#d1fae5' : 'white'}; border-radius: 12px; border: 2px solid ${opt.is_correct ? '#10b981' : '#e5e7eb'}; margin-bottom: 12px;">
                    <span style="font-weight: 900; font-size: 18px; color: ${opt.is_correct ? '#065f46' : '#6b7280'};">
                      ${String.fromCharCode(65 + idx)}.
                    </span>
                    <div style="flex: 1;">
                      <div style="color: ${opt.is_correct ? '#065f46' : '#374151'}; line-height: 1.6;">
                        ${opt.text}
                      </div>
                      ${opt.image_url ? `
                        <img src="${opt.image_url}" 
                             style="max-width: 300px; max-height: 200px; border-radius: 8px; margin-top: 8px;"
                             onerror="this.style.display='none';">
                      ` : ''}
                    </div>
                    ${opt.is_correct ? '<span style="color: #10b981; font-size: 24px; font-weight: 900;">‚úì</span>' : ''}
                  </div>
                `).join('')}
              </div>
            ` : ''}

            ${question.question_type === 'essay' ? `
              <div style="background: white; padding: 16px; border-radius: 12px; margin-top: 20px; border: 2px solid #e5e7eb;">
                <div style="margin-bottom: 12px;">
                  <strong style="color: #6b7280;">Metode Penilaian:</strong>
                  <span style="color: #1f2937; margin-left: 8px;">
                    ${questionData.grading_method === 'manual' ? 'Manual oleh Guru' : 'Kata Kunci Otomatis'}
                  </span>
                </div>
                ${questionData.grading_method === 'keyword' ? `
                  <div>
                    <strong style="color: #6b7280;">Kata Kunci:</strong>
                    <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;">
                      ${questionData.keywords.map(k => `
                        <span class="badge badge-info">${k}</span>
                      `).join('')}
                    </div>
                  </div>
                ` : ''}
              </div>
            ` : ''}

            ${question.question_type === 'true_false' ? `
              <div style="background: white; padding: 20px; border-radius: 12px; margin-top: 20px; border: 2px solid #e5e7eb; text-align: center;">
                <div style="font-size: 16px; color: #6b7280; margin-bottom: 12px;">Jawaban yang Benar:</div>
                <div style="font-size: 32px; font-weight: 900; color: ${questionData.correct_answer ? '#10b981' : '#ef4444'};">
                  ${questionData.correct_answer ? '‚úì BENAR' : '‚úó SALAH'}
                </div>
              </div>
            ` : ''}

            ${question.question_type === 'matching' ? `
              <div style="margin-top: 24px;">
                <h3 style="font-size: 16px; font-weight: 900; margin-bottom: 12px;">Pasangan yang Benar:</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div>
                    <div style="font-weight: 700; color: #6b7280; margin-bottom: 12px; font-size: 14px;">KOLOM KIRI:</div>
                    ${questionData.pairs.map((p, i) => `
                      <div style="padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; border: 2px solid #e5e7eb;">
                        <strong>${i + 1}.</strong> ${p.left}
                      </div>
                    `).join('')}
                  </div>
                  <div>
                    <div style="font-weight: 700; color: #6b7280; margin-bottom: 12px; font-size: 14px;">KOLOM KANAN:</div>
                    ${questionData.pairs.map((p, i) => `
                      <div style="padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; border: 2px solid #e5e7eb;">
                        <strong>${String.fromCharCode(65 + i)}.</strong> ${p.right}
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
            ` : ''}
          </div>

          <div style="font-size: 14px; color: #6b7280; padding: 16px; background: #f9fafb; border-radius: 12px;">
            <div><strong>Dibuat oleh:</strong> ${question.question_created_by}</div>
            <div><strong>Tanggal:</strong> ${new Date(question.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}</div>
          </div>

          <div style="margin-top: 24px;">
            <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-primary" style="width: 100%;">
              Tutup
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function editQuestion(questionId) {
      const question = appData.find(q => q.__backendId === questionId);
      if (!question) return;

      const questionData = JSON.parse(question.question_data);

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 900px;">
          <div class="modal-header">
            <h2 class="modal-title">‚úèÔ∏è Edit Soal</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>

          <form id="editQuestionForm">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label">Jenis Soal</label>
                <input type="text" class="form-input" value="${question.question_type === 'multiple_choice' ? 'Pilihan Ganda' : question.question_type === 'essay' ? 'Essay' : question.question_type === 'true_false' ? 'Benar/Salah' : 'Penjodohan'}" disabled>
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="editQuestionSubject">Mata Pelajaran *</label>
                ${currentUser.role === 'guru' ? `
                  <input type="text" id="editQuestionSubject" class="form-input" value="${currentUser.subject}" readonly 
                         style="background: #f3f4f6; cursor: not-allowed;">
                ` : `
                  <select id="editQuestionSubject" class="form-select" required>
                    <option value="Pendidikan Agama dan Budi Pekerti" ${question.question_subject === 'Pendidikan Agama dan Budi Pekerti' ? 'selected' : ''}>Pendidikan Agama dan Budi Pekerti</option>
                  <option value="Pendidikan Pancasila" ${question.question_subject === 'Pendidikan Pancasila' ? 'selected' : ''}>Pendidikan Pancasila</option>
                  <option value="Bahasa Indonesia" ${question.question_subject === 'Bahasa Indonesia' ? 'selected' : ''}>Bahasa Indonesia</option>
                  <option value="Matematika" ${question.question_subject === 'Matematika' ? 'selected' : ''}>Matematika</option>
                  <option value="Ilmu Pengetahuan Alam (IPA)" ${question.question_subject === 'Ilmu Pengetahuan Alam (IPA)' ? 'selected' : ''}>Ilmu Pengetahuan Alam (IPA)</option>
                  <option value="Ilmu Pengetahuan Sosial (IPS)" ${question.question_subject === 'Ilmu Pengetahuan Sosial (IPS)' ? 'selected' : ''}>Ilmu Pengetahuan Sosial (IPS)</option>
                  <option value="Bahasa Inggris" ${question.question_subject === 'Bahasa Inggris' ? 'selected' : ''}>Bahasa Inggris</option>
                  <option value="Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)" ${question.question_subject === 'Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)' ? 'selected' : ''}>Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)</option>
                  <option value="Informatika" ${question.question_subject === 'Informatika' ? 'selected' : ''}>Informatika</option>
                  <option value="Seni Budaya dan Prakarya" ${question.question_subject === 'Seni Budaya dan Prakarya' ? 'selected' : ''}>Seni Budaya dan Prakarya</option>
                  <option value="Bahasa Daerah" ${question.question_subject === 'Bahasa Daerah' ? 'selected' : ''}>Bahasa Daerah</option>
                </select>
                `}
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="editQuestionClass">Kelas *</label>
                <select id="editQuestionClass" class="form-select" required>
                  <option value="7" ${question.question_class === '7' ? 'selected' : ''}>Kelas 7</option>
                  <option value="8" ${question.question_class === '8' ? 'selected' : ''}>Kelas 8</option>
                  <option value="9" ${question.question_class === '9' ? 'selected' : ''}>Kelas 9</option>
                </select>
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="editQuestionPoints">Poin *</label>
                <input type="number" id="editQuestionPoints" class="form-input" required value="${question.question_points}" min="1" max="100">
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="editQuestionText">Pertanyaan *</label>
              <textarea id="editQuestionText" class="form-textarea" required>${questionData.question_text}</textarea>
            </div>

            <div class="form-group">
              <label class="form-label" for="editQuestionImageUrl">URL Gambar Soal (Opsional)</label>
              <input type="url" id="editQuestionImageUrl" class="form-input" value="${questionData.question_image_url || ''}" placeholder="https://example.com/image.jpg">
            </div>

            ${question.question_type === 'multiple_choice' ? `
              <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 16px;">
                <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 900;">Pilihan Jawaban</h3>
                
                <div id="editOptionsContainer">
                  ${questionData.options.map((opt, idx) => `
                    <div class="option-item" style="margin-bottom: 16px;">
                      <div style="display: flex; gap: 12px; align-items: start;">
                        <input type="radio" name="editCorrectAnswer" value="${idx}" ${opt.is_correct ? 'checked' : ''} style="margin-top: 12px; cursor: pointer;">
                        <div style="flex: 1;">
                          <textarea class="form-textarea edit-option-text" placeholder="Opsi ${String.fromCharCode(65 + idx)}" style="min-height: 60px;">${opt.text}</textarea>
                          <input type="url" class="form-input edit-option-image" placeholder="URL Gambar (opsional)" style="margin-top: 8px;" value="${opt.image_url || ''}">
                        </div>
                        ${idx >= 4 ? `
                          <button type="button" onclick="this.closest('.option-item').remove()" class="btn btn-danger btn-sm">
                            üóëÔ∏è
                          </button>
                        ` : '<div style="width: 40px;"></div>'}
                      </div>
                    </div>
                  `).join('')}
                </div>

                ${questionData.options.length < 5 ? `
                  <button type="button" onclick="addEditOption()" class="btn btn-secondary btn-sm">
                    ‚ûï Tambah Opsi
                  </button>
                ` : ''}
              </div>
            ` : question.question_type === 'essay' ? `
              <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                <div class="form-group">
                  <label class="form-label" for="editGradingMethod">Metode Penilaian *</label>
                  <select id="editGradingMethod" class="form-select" onchange="toggleEditKeywordField()">
                    <option value="manual" ${questionData.grading_method === 'manual' ? 'selected' : ''}>Manual oleh Guru</option>
                    <option value="keyword" ${questionData.grading_method === 'keyword' ? 'selected' : ''}>Kata Kunci Otomatis</option>
                  </select>
                </div>

                <div id="editKeywordField" style="display: ${questionData.grading_method === 'keyword' ? 'block' : 'none'};">
                  <label class="form-label" for="editKeywords">Kata Kunci (pisahkan dengan koma)</label>
                  <input type="text" id="editKeywords" class="form-input" value="${questionData.keywords ? questionData.keywords.join(', ') : ''}" placeholder="contoh: abstraksi, algoritma, dekomposisi">
                </div>
              </div>
            ` : question.question_type === 'true_false' ? `
              <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                <label class="form-label">Jawaban yang Benar *</label>
                <div style="display: flex; gap: 16px;">
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="editTrueFalseAnswer" value="true" ${questionData.correct_answer === true ? 'checked' : ''} style="cursor: pointer;">
                    <span style="font-weight: 700; color: #10b981;">‚úì BENAR</span>
                  </label>
                  <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="editTrueFalseAnswer" value="false" ${questionData.correct_answer === false ? 'checked' : ''} style="cursor: pointer;">
                    <span style="font-weight: 700; color: #ef4444;">‚úó SALAH</span>
                  </label>
                </div>
              </div>
            ` : question.question_type === 'matching' ? `
              <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 900;">Pasangan</h3>
                
                <div id="editPairsContainer">
                  ${questionData.pairs.map((pair, idx) => `
                    <div class="pair-item" style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: start;">
                      <input type="text" class="form-input edit-pair-left" placeholder="Kolom Kiri ${idx + 1}" required value="${pair.left}">
                      <input type="text" class="form-input edit-pair-right" placeholder="Kolom Kanan ${idx + 1}" required value="${pair.right}">
                      ${idx >= 3 ? `
                        <button type="button" onclick="this.closest('.pair-item').remove()" class="btn btn-danger btn-sm">
                          üóë   
                        </button>
                      ` : '<div style="width: 40px;"></div>'}
                    </div>
                  `).join('')}
                </div>

                <button type="button" onclick="addEditPair()" class="btn btn-secondary btn-sm">
                  ‚ûï Tambah Pasangan
                </button>
              </div>
            ` : ''}

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button type="button" onclick="this.closest('.modal-overlay').remove()" 
                      class="btn btn-secondary" style="flex: 1;">
                Batal
              </button>
              <button type="submit" class="btn btn-success" style="flex: 1;" id="updateQuestionBtn">
                üíæ Update Soal
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('editQuestionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await updateQuestion(questionId);
      });
    }

    function toggleEditKeywordField() {
      const method = document.getElementById('editGradingMethod').value;
      document.getElementById('editKeywordField').style.display = method === 'keyword' ? 'block' : 'none';
    }

    function addEditOption() {
      const container = document.getElementById('editOptionsContainer');
      const currentOptions = container.querySelectorAll('.option-item').length;
      
      if (currentOptions >= 5) {
        showToast('Maksimal 5 opsi jawaban', 'warning');
        return;
      }

      const optionLetter = String.fromCharCode(65 + currentOptions);
      const newOption = document.createElement('div');
      newOption.className = 'option-item';
      newOption.style.marginBottom = '16px';
      newOption.innerHTML = `
        <div style="display: flex; gap: 12px; align-items: start;">
          <input type="radio" name="editCorrectAnswer" value="${currentOptions}" style="margin-top: 12px; cursor: pointer;">
          <div style="flex: 1;">
            <textarea class="form-textarea edit-option-text" placeholder="Opsi ${optionLetter}" style="min-height: 60px;"></textarea>
            <input type="url" class="form-input edit-option-image" placeholder="URL Gambar (opsional)" style="margin-top: 8px;">
          </div>
          <button type="button" onclick="this.closest('.option-item').remove()" class="btn btn-danger btn-sm">
            üóëÔ∏è
          </button>
        </div>
      `;
      
      container.appendChild(newOption);
    }

    function addEditPair() {
      const container = document.getElementById('editPairsContainer');
      const currentPairs = container.querySelectorAll('.pair-item').length + 1;
      
      const newPair = document.createElement('div');
      newPair.className = 'pair-item';
      newPair.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin-bottom: 12px; align-items: start;';
      newPair.innerHTML = `
        <input type="text" class="form-input edit-pair-left" placeholder="Kolom Kiri ${currentPairs}" required>
        <input type="text" class="form-input edit-pair-right" placeholder="Kolom Kanan ${currentPairs}" required>
        <button type="button" onclick="this.closest('.pair-item').remove()" class="btn btn-danger btn-sm">
          üóëÔ∏è
        </button>
      `;
      
      container.appendChild(newPair);
    }

    async function updateQuestion(questionId) {
      const question = appData.find(q => q.__backendId === questionId);
      if (!question) return;

      const btn = document.getElementById('updateQuestionBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Mengupdate...';

      const subjectElement = document.getElementById('editQuestionSubject');
      const subject = subjectElement.tagName === 'INPUT' ? subjectElement.value : subjectElement.value;
      const classLevel = document.getElementById('editQuestionClass').value;
      const points = parseInt(document.getElementById('editQuestionPoints').value);
      const questionText = document.getElementById('editQuestionText').value.trim();
      const questionImageUrl = document.getElementById('editQuestionImageUrl').value.trim();

      let questionData = {
        question_text: questionText,
        question_image_url: questionImageUrl || null
      };

      // Build question data based on type
      if (question.question_type === 'multiple_choice') {
        const options = [];
        const optionTexts = document.querySelectorAll('.edit-option-text');
        const optionImages = document.querySelectorAll('.edit-option-image');
        const correctAnswer = document.querySelector('input[name="editCorrectAnswer"]:checked');

        if (!correctAnswer) {
          showToast('Pilih jawaban yang benar', 'error');
          btn.disabled = false;
          btn.innerHTML = 'üíæ Update Soal';
          return;
        }

        optionTexts.forEach((opt, idx) => {
          const text = opt.value.trim();
          if (text) {
            options.push({
              text: text,
              image_url: optionImages[idx].value.trim() || null,
              is_correct: idx === parseInt(correctAnswer.value)
            });
          }
        });

        if (options.length < 2) {
          showToast('Minimal 2 opsi jawaban', 'error');
          btn.disabled = false;
          btn.innerHTML = 'üíæ Update Soal';
          return;
        }

        questionData.options = options;

      } else if (question.question_type === 'essay') {
        const method = document.getElementById('editGradingMethod').value;
        questionData.grading_method = method;
        
        if (method === 'keyword') {
          const keywords = document.getElementById('editKeywords').value.trim();
          questionData.keywords = keywords ? keywords.split(',').map(k => k.trim()) : [];
        }

      } else if (question.question_type === 'true_false') {
        const answer = document.querySelector('input[name="editTrueFalseAnswer"]:checked');
        
        if (!answer) {
          showToast('Pilih jawaban yang benar', 'error');
          btn.disabled = false;
          btn.innerHTML = 'üíæ Update Soal';
          return;
        }

        questionData.correct_answer = answer.value === 'true';

      } else if (question.question_type === 'matching') {
        const pairs = [];
        const pairLefts = document.querySelectorAll('.edit-pair-left');
        const pairRights = document.querySelectorAll('.edit-pair-right');

        pairLefts.forEach((left, idx) => {
          const leftText = left.value.trim();
          const rightText = pairRights[idx].value.trim();
          
          if (leftText && rightText) {
            pairs.push({
              left: leftText,
              right: rightText
            });
          }
        });

        if (pairs.length < 3) {
          showToast('Minimal 3 pasangan untuk soal penjodohan', 'error');
          btn.disabled = false;
          btn.innerHTML = 'üíæ Update Soal';
          return;
        }

        questionData.pairs = pairs;
      }

      const updatedQuestion = {
        ...question,
        question_subject: subject,
        question_class: classLevel,
        question_points: points,
        question_data: JSON.stringify(questionData)
      };

      const result = await window.dataSdk.update(updatedQuestion);

      if (result.isOk) {
        showToast('‚úÖ Soal berhasil diupdate', 'success');
        document.querySelector('.modal-overlay').remove();
      } else {
        showToast('Gagal mengupdate soal', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üíæ Update Soal';
      }
    }

    async function deleteQuestion(questionId) {
      const question = appData.find(q => q.__backendId === questionId);
      if (!question) return;

      const questionData = JSON.parse(question.question_data);
      const preview = questionData.question_text.substring(0, 80) + (questionData.question_text.length > 80 ? '...' : '');

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; text-align: center;">
          <div style="font-size: 64px; margin-bottom: 16px;">‚ö†    </div>
          <h3 style="margin: 0 0 12px;">Hapus Soal?</h3>
          <p style="margin: 0 0 24px; color: #6b7280; line-height: 1.6;">
            ${preview}
          </p>
          <div style="display: flex; gap: 12px;">
            <button onclick="this.closest('.modal-overlay').remove()" 
                    class="btn btn-secondary" style="flex: 1;">
              Batal
            </button>
            <button onclick="confirmDeleteQuestion('${questionId}')" 
                    class="btn btn-danger" style="flex: 1;" id="confirmDeleteQuestionBtn">
              üóëÔ∏è Hapus
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function confirmDeleteQuestion(questionId) {
      const question = appData.find(q => q.__backendId === questionId);
      if (!question) return;

      const btn = document.getElementById('confirmDeleteQuestionBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Menghapus...';

      const result = await window.dataSdk.delete(question);

      if (result.isOk) {
        showToast('‚úÖ Soal berhasil dihapus', 'success');
        document.querySelector('.modal-overlay').remove();
      } else {
        showToast('Gagal menghapus soal', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üóëÔ∏è Hapus';
      }
    }

    async function deleteSelectedQuestions() {
      const selectedCheckboxes = document.querySelectorAll('.question-checkbox:checked');
      if (selectedCheckboxes.length === 0) {
        showToast('Tidak ada soal yang dipilih', 'warning');
        return;
      }

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; text-align: center;">
          <div style="font-size: 64px; margin-bottom: 16px;">‚ö†Ô∏è</div>
          <h3 style="margin: 0 0 12px;">Hapus ${selectedCheckboxes.length} Soal?</h3>
          <p style="margin: 0 0 24px; color: #6b7280;">
            Yakin ingin menghapus ${selectedCheckboxes.length} soal yang dipilih?
          </p>
          <div style="display: flex; gap: 12px;">
            <button onclick="this.closest('.modal-overlay').remove()" 
                    class="btn btn-secondary" style="flex: 1;">
              Batal
            </button>
            <button onclick="confirmDeleteSelectedQuestions()" 
                    class="btn btn-danger" style="flex: 1;" id="confirmDeleteSelectedQuestionsBtn">
              üóëÔ∏è Hapus Semua
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function confirmDeleteSelectedQuestions() {
      const selectedCheckboxes = document.querySelectorAll('.question-checkbox:checked');
      const btn = document.getElementById('confirmDeleteSelectedQuestionsBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Menghapus...';

      let successCount = 0;
      let errorCount = 0;

      for (const checkbox of selectedCheckboxes) {
        const questionId = checkbox.dataset.questionId;
        const question = appData.find(q => q.__backendId === questionId);
        
        if (question) {
          const result = await window.dataSdk.delete(question);
          if (result.isOk) {
            successCount++;
          } else {
            errorCount++;
          }
          await new Promise(r => setTimeout(r, 100));
        }
      }

      showToast(`‚úÖ Berhasil: ${successCount} | ‚ùå Gagal: ${errorCount}`, successCount > 0 ? 'success' : 'error');
      document.querySelector('.modal-overlay').remove();
    }

    function renderSchedulePage() {
      document.getElementById('headerTitle').textContent = 'Penjadwalan Ujian';
      const content = document.getElementById('mainContent');

      const exams = appData.filter(e => e.type === 'exam');
      const questions = appData.filter(q => q.type === 'question');

      const activeExams = exams.filter(e => e.exam_is_active);
      const inactiveExams = exams.filter(e => !e.exam_is_active);

      content.innerHTML = `
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
          <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">‚úÖ</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Ujian Aktif</p>
              <p class="stat-value" style="color: white;">${activeExams.length}</p>
            </div>
          </div>

          <div class="stat-card" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">‚è∏Ô∏è</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Ujian Nonaktif</p>
              <p class="stat-value" style="color: white;">${inactiveExams.length}</p>
            </div>
          </div>

          <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üìù</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Total Ujian</p>
              <p class="stat-value" style="color: white;">${exams.length}</p>
            </div>
          </div>

          <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">  </div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Bank Soal</p>
              <p class="stat-value" style="color: white;">${questions.length}</p>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 class="card-title">
            <span>üìÖ Jadwal Ujian</span>
            <button onclick="showCreateExamModal()" class="btn btn-success btn-sm">
              ‚ûï Buat Ujian Baru
            </button>
          </h2>

          <!-- Filter Section -->
          <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <div>
                <label class="form-label">Filter Status</label>
                <select id="filterExamStatus" class="form-select" onchange="filterExams()">
                  <option value="all">Semua Status</option>
                  <option value="active">Aktif</option>
                  <option value="inactive">Nonaktif</option>
                </select>
              </div>

              <div>
                <label class="form-label">Filter Mata Pelajaran</label>
                <select id="filterExamSubject" class="form-select" onchange="filterExams()">
                  <option value="all">Semua Mapel</option>
                  <option value="Pendidikan Agama dan Budi Pekerti">Pendidikan Agama dan Budi Pekerti</option>
                  <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                  <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                  <option value="Matematika">Matematika</option>
                  <option value="Ilmu Pengetahuan Alam (IPA)">Ilmu Pengetahuan Alam (IPA)</option>
                  <option value="Ilmu Pengetahuan Sosial (IPS)">Ilmu Pengetahuan Sosial (IPS)</option>
                  <option value="Bahasa Inggris">Bahasa Inggris</option>
                  <option value="Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)">Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)</option>
                  <option value="Informatika">Informatika</option>
                  <option value="Seni Budaya dan Prakarya">Seni Budaya dan Prakarya</option>
                  <option value="Bahasa Daerah">Bahasa Daerah</option>
                </select>
                `}
              </div>

              <div>
                <label class="form-label">Filter Kelas</label>
                <select id="filterExamClass" class="form-select" onchange="filterExams()">
                  <option value="all">Semua Kelas</option>
                  <option value="7">Kelas 7</option>
                  <option value="8">Kelas 8</option>
                  <option value="9">Kelas 9</option>
                </select>
              </div>

              <div>
                <label class="form-label">Cari Ujian</label>
                <input type="text" id="searchExam" class="form-input" placeholder="Cari judul ujian..." oninput="filterExams()">
              </div>
            </div>
          </div>

          <!-- Exam List -->
          <div id="examListContainer">
            ${renderExamList(exams)}
          </div>
        </div>
      `;
    }

    function renderExamList(examsToRender) {
      if (examsToRender.length === 0) {
        return `
          <div class="empty-state">
            <div class="empty-icon">üìÖ</div>
            <p class="empty-text">Belum ada ujian dijadwalkan</p>
          </div>
        `;
      }

      return `
        <div style="display: grid; gap: 16px;">
          ${examsToRender.map(exam => {
            const examConfig = JSON.parse(exam.exam_config);
            const startDate = new Date(exam.exam_start_date);
            const endDate = new Date(exam.exam_end_date);
            const now = new Date();
            
            let statusBadge = '';
            let statusColor = '';
            
            if (!exam.exam_is_active) {
              statusBadge = 'Nonaktif';
              statusColor = '#6b7280';
            } else if (now < startDate) {
              statusBadge = 'Belum Dimulai';
              statusColor = '#3b82f6';
            } else if (now > endDate) {
              statusBadge = 'Selesai';
              statusColor = '#ef4444';
            } else {
              statusBadge = 'Berlangsung';
              statusColor = '#10b981';
            }

            const results = appData.filter(r => r.type === 'result' && r.result_exam_id === exam.__backendId);
            const avgScore = results.length > 0 
              ? (results.reduce((sum, r) => sum + r.result_score, 0) / results.length).toFixed(1)
              : 0;

            return `
              <div style="background: white; border: 2px solid #e5e7eb; border-radius: 16px; padding: 24px;">
                <div style="display: flex; gap: 20px; align-items: start;">
                  <div style="flex: 1;">
                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; align-items: center;">
                      <h3 style="margin: 0; font-size: 20px; font-weight: 900; color: #1f2937; flex: 1;">
                        ${exam.exam_title}
                      </h3>
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: ${statusColor}; color: white; padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 800;">
                          ${statusBadge}
                        </span>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                          <input type="checkbox" ${exam.exam_is_active ? 'checked' : ''} 
                                 onchange="toggleExamStatus('${exam.__backendId}')"
                                 style="width: 20px; height: 20px; cursor: pointer;">
                          <span style="font-size: 13px; font-weight: 700; color: #6b7280;">Aktif</span>
                        </label>
                      </div>
                    </div>

                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                      <span class="badge badge-info">${exam.exam_subject}</span>
                      <span class="badge badge-secondary">Kelas ${exam.exam_class}</span>
                      <span class="badge badge-warning">${exam.exam_duration} menit</span>
                      ${examConfig.use_token ? '<span class="badge badge-success">üîí Token</span>' : ''}
                      ${examConfig.shuffle_questions ? '<span class="badge badge-info">üîÄ Acak Soal</span>' : ''}
                      ${examConfig.shuffle_answers ? '<span class="badge badge-info">üîÄ Acak Jawaban</span>' : ''}
                    </div>

                    <div style="background: #f9fafb; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; font-size: 14px;">
                        <div>
                          <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">üìÖ Mulai</div>
                          <div style="font-weight: 700; color: #1f2937;">
                            ${startDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}
                          </div>
                          <div style="font-size: 12px; color: #6b7280;">
                            ${startDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                          </div>
                        </div>

                        <div>
                          <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">üìÖ Selesai</div>
                          <div style="font-weight: 700; color: #1f2937;">
                            ${endDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}
                          </div>
                          <div style="font-size: 12px; color: #6b7280;">
                            ${endDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                          </div>
                        </div>

                        ${examConfig.use_token ? `
                          <div>
                            <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">        Token</div>
                            <div style="font-family: monospace; font-weight: 900; color: #1f2937; font-size: 16px;">
                              ${examConfig.token}
                            </div>
                          </div>
                        ` : ''}

                        <div>
                          <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">‚ùì Jumlah Soal</div>
                          <div style="font-weight: 700; color: #1f2937;">
                            ${examConfig.question_limit || 'Semua'}
                          </div>
                        </div>

                        <div>
                          <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">üë• Peserta</div>
                          <div style="font-weight: 700; color: #1f2937;">
                            ${results.length} siswa
                          </div>
                        </div>

                        <div>
                          <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">     Rata-rata</div>
                          <div style="font-weight: 700; color: #1f2937;">
                            ${avgScore}
                          </div>
                        </div>
                      </div>
                    </div>

                    <div style="font-size: 12px; color: #9ca3af;">
                      Dibuat oleh: <strong>${exam.exam_created_by}</strong>    
                      ${new Date(exam.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}
                    </div>
                  </div>

                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    <button onclick="viewExam('${exam.__backendId}')" class="btn btn-info btn-sm">
                      üëÅÔ∏è Detail
                    </button>
                    <button onclick="editExam('${exam.__backendId}')" class="btn btn-warning btn-sm">
                      ‚úèÔ∏è Edit
                    </button>
                    <button onclick="deleteExam('${exam.__backendId}')" class="btn btn-danger btn-sm">
                      üóëÔ∏è Hapus
                    </button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function filterExams() {
      const statusFilter = document.getElementById('filterExamStatus').value;
      const subjectFilter = document.getElementById('filterExamSubject').value;
      const classFilter = document.getElementById('filterExamClass').value;
      const searchQuery = document.getElementById('searchExam').value.toLowerCase();

      let exams = appData.filter(e => e.type === 'exam');

      if (statusFilter === 'active') {
        exams = exams.filter(e => e.exam_is_active);
      } else if (statusFilter === 'inactive') {
        exams = exams.filter(e => !e.exam_is_active);
      }

      if (subjectFilter !== 'all') {
        exams = exams.filter(e => e.exam_subject === subjectFilter);
      }

      if (classFilter !== 'all') {
        exams = exams.filter(e => e.exam_class === classFilter);
      }

      if (searchQuery) {
        exams = exams.filter(e => e.exam_title.toLowerCase().includes(searchQuery));
      }

      document.getElementById('examListContainer').innerHTML = renderExamList(exams);
    }

    function showCreateExamModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h2 class="modal-title">‚ûï Buat Ujian Baru</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>

          <form id="createExamForm">
            <div style="background: #dbeafe; padding: 16px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
              <p style="margin: 0; color: #1e40af; font-size: 14px; font-weight: 700;">
                üí° Pastikan sudah ada soal di bank soal untuk mata pelajaran dan kelas yang dipilih
              </p>
            </div>

            <div class="form-group">
              <label class="form-label" for="examTitle">Judul Ujian *</label>
              <input type="text" id="examTitle" class="form-input" required placeholder="Contoh: Ujian Tengah Semester Matematika">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="examSubject">Mata Pelajaran *</label>
                <select id="examSubject" class="form-select" required onchange="updateAvailableQuestions()">
                  <option value="">Pilih Mapel</option>
                  <option value="Pendidikan Agama dan Budi Pekerti">Pendidikan Agama dan Budi Pekerti</option>
                  <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                  <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                  <option value="Matematika">Matematika</option>
                  <option value="Ilmu Pengetahuan Alam (IPA)">Ilmu Pengetahuan Alam (IPA)</option>
                  <option value="Ilmu Pengetahuan Sosial (IPS)">Ilmu Pengetahuan Sosial (IPS)</option>
                  <option value="Bahasa Inggris">Bahasa Inggris</option>
                  <option value="Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)">Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)</option>
                  <option value="Informatika">Informatika</option>
                  <option value="Seni Budaya dan Prakarya">Seni Budaya dan Prakarya</option>
                  <option value="Bahasa Daerah">Bahasa Daerah</option>
                </select>
                `}
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="examClass">Kelas *</label>
                <select id="examClass" class="form-select" required onchange="updateAvailableQuestions()">
                  <option value="">Pilih Kelas</option>
                  <option value="7">Kelas 7 (7A, 7B, 7C, 7D)</option>
                  <option value="8">Kelas 8 (8A, 8B, 8C, 8D)</option>
                  <option value="9">Kelas 9 (9A, 9B, 9C, 9D)</option>
                </select>
              </div>
            </div>

            <div id="availableQuestionsInfo" style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f59e0b; display: none;">
              <p style="margin: 0; color: #92400e; font-size: 13px; font-weight: 700;">
                üìä Soal tersedia: <span id="availableQuestionsCount">0</span> soal
              </p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; margin-bottom: 20px;">
              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="examDuration">Durasi (menit) *</label>
                <input type="number" id="examDuration" class="form-input" required value="90" min="5" max="300">
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="examStartDate">Tanggal Mulai *</label>
                <input type="datetime-local" id="examStartDate" class="form-input" required>
              </div>

              <div class="form-group" style="margin-bottom: 0;">
                <label class="form-label" for="examEndDate">Tanggal Selesai *</label>
                <input type="datetime-local" id="examEndDate" class="form-input" required>
              </div>
            </div>

            <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 900;">‚öô    Pengaturan Ujian</h3>

              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                  <input type="checkbox" id="useToken" style="width: 20px; height: 20px; cursor: pointer;">
                  <div>
                    <div style="font-weight: 700; color: #1f2937;">Gunakan Token Ujian</div>
                    <div style="font-size: 13px; color: #6b7280;">Siswa harus memasukkan token untuk mengakses ujian</div>
                  </div>
                </label>
              </div>

              <div id="tokenField" style="display: none; margin-top: 16px;">
                <label class="form-label" for="examToken">Token Ujian (6 karakter)</label>
                <div style="display: flex; gap: 12px;">
                  <input type="text" id="examToken" class="form-input" placeholder="Contoh: UTS001" maxlength="10" style="flex: 1;">
                  <button type="button" onclick="generateToken()" class="btn btn-secondary">
                    üé≤ Generate
                  </button>
                </div>
              </div>

              <div class="form-group" style="margin-top: 16px;">
                <label class="form-label" for="questionLimit">Jumlah Soal yang Ditampilkan (Opsional)</label>
                <input type="number" id="questionLimit" class="form-input" placeholder="Kosongkan untuk menampilkan semua soal" min="1">
                <small style="color: #6b7280; display: block; margin-top: 8px;">
                  Biarkan kosong untuk menampilkan semua soal yang tersedia
                </small>
              </div>

              <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                <div class="form-group">
                  <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                    <input type="checkbox" id="shuffleQuestions" style="width: 20px; height: 20px; cursor: pointer;">
                    <div>
                      <div style="font-weight: 700; color: #1f2937;">üîÄ Acak Urutan Soal</div>
                      <div style="font-size: 13px; color: #6b7280;">Setiap siswa mendapat urutan soal yang berbeda</div>
                    </div>
                  </label>
                </div>

                <div class="form-group" style="margin-top: 16px;">
                  <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                    <input type="checkbox" id="shuffleAnswers" style="width: 20px; height: 20px; cursor: pointer;">
                    <div>
                      <div style="font-weight: 700; color: #1f2937;">üîÄ Acak Urutan Jawaban</div>
                      <div style="font-size: 13px; color: #6b7280;">Opsi jawaban diacak untuk soal pilihan ganda</div>
                    </div>
                  </label>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                <input type="checkbox" id="isActive" checked style="width: 20px; height: 20px; cursor: pointer;">
                <div>
                  <div style="font-weight: 700; color: #1f2937;">‚úÖ Aktifkan Ujian Sekarang</div>
                  <div style="font-size: 13px; color: #6b7280;">Ujian dapat diakses siswa sesuai jadwal</div>
                </div>
              </label>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button type="button" onclick="this.closest('.modal-overlay').remove()" 
                      class="btn btn-secondary" style="flex: 1;">
                Batal
              </button>
              <button type="submit" class="btn btn-success" style="flex: 1;" id="createExamBtn">
                üíæ Buat Ujian
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      // Set default datetime to now
      const now = new Date();
      const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
      const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
      
      document.getElementById('examStartDate').value = tomorrow.toISOString().slice(0, 16);
      document.getElementById('examEndDate').value = nextWeek.toISOString().slice(0, 16);

      // Toggle token field
      document.getElementById('useToken').addEventListener('change', function() {
        document.getElementById('tokenField').style.display = this.checked ? 'block' : 'none';
      });

      document.getElementById('createExamForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await createNewExam();
      });
    }

    function updateAvailableQuestions() {
      const subject = document.getElementById('examSubject').value;
      const classLevel = document.getElementById('examClass').value;

      if (!subject || !classLevel) {
        document.getElementById('availableQuestionsInfo').style.display = 'none';
        return;
      }

      const availableQuestions = appData.filter(q => 
        q.type === 'question' && 
        q.question_subject === subject && 
        q.question_class === classLevel
      );

      const infoEl = document.getElementById('availableQuestionsInfo');
      const countEl = document.getElementById('availableQuestionsCount');
      
      countEl.textContent = availableQuestions.length;
      infoEl.style.display = 'block';

      if (availableQuestions.length === 0) {
        infoEl.style.background = '#fee2e2';
        infoEl.style.borderLeftColor = '#ef4444';
        countEl.parentElement.innerHTML = `‚ö†Ô∏è <strong>Tidak ada soal tersedia!</strong> Buat soal terlebih dahulu di menu Kelola Soal.`;
        countEl.parentElement.style.color = '#991b1b';
      } else {
        infoEl.style.background = '#fef3c7';
        infoEl.style.borderLeftColor = '#f59e0b';
        countEl.parentElement.innerHTML = `üìä Soal tersedia: <span id="availableQuestionsCount">${availableQuestions.length}</span> soal`;
        countEl.parentElement.style.color = '#92400e';
      }
    }

    function generateToken() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let token = '';
      for (let i = 0; i < 6; i++) {
        token += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      document.getElementById('examToken').value = token;
    }

    async function createNewExam() {
      const btn = document.getElementById('createExamBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Membuat...';

      const title = document.getElementById('examTitle').value.trim();
      const subject = document.getElementById('examSubject').value;
      const classLevel = document.getElementById('examClass').value;
      const duration = parseInt(document.getElementById('examDuration').value);
      const startDate = document.getElementById('examStartDate').value;
      const endDate = document.getElementById('examEndDate').value;
      const useToken = document.getElementById('useToken').checked;
      const token = useToken ? document.getElementById('examToken').value.trim() : null;
      const questionLimit = document.getElementById('questionLimit').value;
      const shuffleQuestions = document.getElementById('shuffleQuestions').checked;
      const shuffleAnswers = document.getElementById('shuffleAnswers').checked;
      const isActive = document.getElementById('isActive').checked;

      // Validation
      if (useToken && (!token || token.length < 3)) {
        showToast('Token minimal 3 karakter', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üíæ Buat Ujian';
        return;
      }

      // Check available questions
      const availableQuestions = appData.filter(q => 
        q.type === 'question' && 
        q.question_subject === subject && 
        q.question_class === classLevel
      );

      if (availableQuestions.length === 0) {
        showToast('Tidak ada soal tersedia untuk mapel dan kelas ini', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üíæ Buat Ujian';
        return;
      }

      if (questionLimit && parseInt(questionLimit) > availableQuestions.length) {
        showToast(`Jumlah soal tidak boleh lebih dari ${availableQuestions.length}`, 'error');
        btn.disabled = false;
        btn.innerHTML = 'üíæ Buat Ujian';
        return;
      }

      // Check date validation
      if (new Date(startDate) >= new Date(endDate)) {
        showToast('Tanggal selesai harus setelah tanggal mulai', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üíæ Buat Ujian';
        return;
      }

      const examConfig = {
        use_token: useToken,
        token: token,
        question_limit: questionLimit ? parseInt(questionLimit) : null,
        shuffle_questions: shuffleQuestions,
        shuffle_answers: shuffleAnswers
      };

      const result = await window.dataSdk.create({
        type: 'exam',
        exam_title: title,
        exam_subject: subject,
        exam_class: classLevel,
        exam_duration: duration,
        exam_start_date: new Date(startDate).toISOString(),
        exam_end_date: new Date(endDate).toISOString(),
        exam_config: JSON.stringify(examConfig),
        exam_is_active: isActive,
        exam_created_by: currentUser.username,
        created_at: new Date().toISOString()
      });

      if (result.isOk) {
        showToast('‚úÖ Ujian berhasil dibuat', 'success');
        document.querySelector('.modal-overlay').remove();
      } else {
        showToast('Gagal membuat ujian', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üíæ Buat Ujian';
      }
    }

    async function toggleExamStatus(examId) {
      const exam = appData.find(e => e.__backendId === examId);
      if (!exam) return;

      const updatedExam = {
        ...exam,
        exam_is_active: !exam.exam_is_active
      };

      const result = await window.dataSdk.update(updatedExam);

      if (result.isOk) {
        showToast(updatedExam.exam_is_active ? '‚úÖ Ujian diaktifkan' : '‚è∏Ô∏è Ujian dinonaktifkan', 'success');
      } else {
        showToast('Gagal mengubah status ujian', 'error');
      }
    }

    function viewExam(examId) {
      const exam = appData.find(e => e.__backendId === examId);
      if (!exam) return;

      const examConfig = JSON.parse(exam.exam_config);
      const startDate = new Date(exam.exam_start_date);
      const endDate = new Date(exam.exam_end_date);
      const results = appData.filter(r => r.type === 'result' && r.result_exam_id === examId);
      
      const availableQuestions = appData.filter(q => 
        q.type === 'question' && 
        q.question_subject === exam.exam_subject && 
        q.question_class === exam.exam_class
      );

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
          <div class="modal-header">
            <h2 class="modal-title">üëÅÔ∏è Detail Ujian</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>

          <div style="background: #f9fafb; padding: 24px; border-radius: 12px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
              <h3 style="margin: 0; font-size: 24px; font-weight: 900; color: #1f2937;">
                ${exam.exam_title}
              </h3>
              <span class="badge ${exam.exam_is_active ? 'badge-success' : 'badge-secondary'}" style="font-size: 13px;">
                ${exam.exam_is_active ? '‚úÖ AKTIF' : '‚è∏Ô∏è NONAKTIF'}
              </span>
            </div>

            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px;">
              <span class="badge badge-info">${exam.exam_subject}</span>
              <span class="badge badge-secondary">Kelas ${exam.exam_class}</span>
              <span class="badge badge-warning">${exam.exam_duration} menit</span>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
              <div style="background: white; padding: 16px; border-radius: 12px; border: 2px solid #e5e7eb;">
                <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">üìÖ Tanggal Mulai</div>
                <div style="font-weight: 900; color: #1f2937; font-size: 16px;">
                  ${startDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}
                </div>
                <div style="color: #6b7280; font-size: 14px;">
                  ${startDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                </div>
              </div>

              <div style="background: white; padding: 16px; border-radius: 12px; border: 2px solid #e5e7eb;">
                <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">üìÖ Tanggal Selesai</div>
                <div style="font-weight: 900; color: #1f2937; font-size: 16px;">
                  ${endDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}
                </div>
                <div style="color: #6b7280; font-size: 14px;">
                  ${endDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                </div>
              </div>
            </div>
          </div>

          <div style="background: white; border: 2px solid #e5e7eb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 16px; font-size: 16px; font-weight: 900;">‚öôÔ∏è Pengaturan Ujian</h4>

            <div style="display: grid; gap: 12px;">
              ${examConfig.use_token ? `
                <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px;">
                  <span style="font-weight: 700; color: #6b7280;">üîë Token Ujian</span>
                  <span style="font-family: monospace; font-weight: 900; color: #1f2937; font-size: 16px;">${examConfig.token}</span>
                </div>
              ` : `
                <div style="padding: 12px; background: #f9fafb; border-radius: 8px; color: #6b7280;">
                  üîì Tidak menggunakan token
                </div>
              `}

              <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px;">
                <span style="font-weight: 700; color: #6b7280;">‚ùì Jumlah Soal</span>
                <span style="font-weight: 900; color: #1f2937;">
                  ${examConfig.question_limit || availableQuestions.length} / ${availableQuestions.length} soal
                </span>
              </div>

              <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px;">
                <span style="font-weight: 700; color: #6b7280;">üîÄ Acak Soal</span>
                <span style="font-weight: 900; color: ${examConfig.shuffle_questions ? '#10b981' : '#6b7280'};">
                  ${examConfig.shuffle_questions ? '‚úÖ Ya' : '‚ùå Tidak'}
                </span>
              </div>

              <div style="display: flex; justify-content: space-between; padding: 12px; background: #f9fafb; border-radius: 8px;">
                <span style="font-weight: 700; color: #6b7280;">üîÄ Acak Jawaban</span>
                <span style="font-weight: 900; color: ${examConfig.shuffle_answers ? '#10b981' : '#6b7280'};">
                  ${examConfig.shuffle_answers ? '‚úÖ Ya' : '‚ùå Tidak'}
                </span>
              </div>
            </div>
          </div>

          <div style="background: white; border: 2px solid #e5e7eb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 16px; font-size: 16px; font-weight: 900;">üìä Statistik</h4>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
              <div style="text-align: center; padding: 16px; background: #f9fafb; border-radius: 12px;">
                <div style="font-size: 32px; font-weight: 900; color: #3b82f6;">${results.length}</div>
                <div style="font-size: 12px; color: #6b7280; font-weight: 700; margin-top: 4px;">PESERTA</div>
              </div>

              <div style="text-align: center; padding: 16px; background: #f9fafb; border-radius: 12px;">
                <div style="font-size: 32px; font-weight: 900; color: #10b981;">
                  ${results.length > 0 ? (results.reduce((sum, r) => sum + r.result_score, 0) / results.length).toFixed(1) : 0}
                </div>
                <div style="font-size: 12px; color: #6b7280; font-weight: 700; margin-top: 4px;">RATA-RATA</div>
              </div>

              <div style="text-align: center; padding: 16px; background: #f9fafb; border-radius: 12px;">
                <div style="font-size: 32px; font-weight: 900; color: #f59e0b;">
                  ${results.length > 0 ? Math.max(...results.map(r => r.result_score)).toFixed(0) : 0}
                </div>
                <div style="font-size: 12px; color: #6b7280; font-weight: 700; margin-top: 4px;">TERTINGGI</div>
              </div>

              <div style="text-align: center; padding: 16px; background: #f9fafb; border-radius: 12px;">
                <div style="font-size: 32px; font-weight: 900; color: #ef4444;">
                  ${results.length > 0 ? Math.min(...results.map(r => r.result_score)).toFixed(0) : 0}
                </div>
                <div style="font-size: 12px; color: #6b7280; font-weight: 700; margin-top: 4px;">TERENDAH</div>
              </div>
            </div>
          </div>

          <div style="font-size: 14px; color: #6b7280; padding: 16px; background: #f9fafb; border-radius: 12px;">
            <div><strong>Dibuat oleh:</strong> ${exam.exam_created_by}</div>
            <div><strong>Tanggal dibuat:</strong> ${new Date(exam.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}</div>
          </div>

          <div style="margin-top: 24px;">
            <button onclick="this.closest('.modal-overlay').remove()" class="btn btn-primary" style="width: 100%;">
              Tutup
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function editExam(examId) {
      showToast('  Ô∏è Fitur Edit Ujian dalam pengembangan', 'info');
    }

    async function deleteExam(examId) {
      const exam = appData.find(e => e.__backendId === examId);
      if (!exam) return;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; text-align: center;">
          <div style="font-size: 64px; margin-bottom: 16px;">  Ô∏è</div>
          <h3 style="margin: 0 0 12px;">Hapus Ujian?</h3>
          <p style="margin: 0 0 8px; color: #1f2937; font-weight: 700; line-height: 1.6;">
            ${exam.exam_title}
          </p>
          <p style="margin: 0 0 24px; color: #6b7280;">
            Yakin ingin menghapus ujian ini?<br>
            Semua hasil tes terkait akan tetap tersimpan.
          </p>
          <div style="display: flex; gap: 12px;">
            <button onclick="this.closest('.modal-overlay').remove()" 
                    class="btn btn-secondary" style="flex: 1;">
              Batal
            </button>
            <button onclick="confirmDeleteExam('${examId}')" 
                    class="btn btn-danger" style="flex: 1;" id="confirmDeleteExamBtn">
              üóëÔ∏è Hapus
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function confirmDeleteExam(examId) {
      const exam = appData.find(e => e.__backendId === examId);
      if (!exam) return;

      const btn = document.getElementById('confirmDeleteExamBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Menghapus...';

      const result = await window.dataSdk.delete(exam);

      if (result.isOk) {
        showToast('    Ujian berhasil dihapus', 'success');
        document.querySelector('.modal-overlay').remove();
      } else {
        showToast('Gagal menghapus ujian', 'error');
        btn.disabled = false;
        btn.innerHTML = '     Ô∏è Hapus';
      }
    }

    function renderExamsPage() {
      document.getElementById('headerTitle').textContent = 'Ujian Saya';
      const content = document.getElementById('mainContent');

      const exams = appData.filter(e => e.type === 'exam' && e.exam_is_active);
      const now = new Date();

      // Get student's class level (extract first character from class like "7A" -> "7")
      const studentClassLevel = currentUser.class ? currentUser.class.toString().charAt(0) : null;

      // Filter exams available for current student's class
      const availableExams = exams.filter(e => {
        const startDate = new Date(e.exam_start_date);
        const endDate = new Date(e.exam_end_date);
        
        return now >= startDate && 
               now <= endDate && 
               e.exam_class === studentClassLevel;
      });

      // Check if student already took the exam
      const myResults = appData.filter(r => r.type === 'result' && r.result_student_id === currentUser.username);
      const completedExamIds = myResults.map(r => r.result_exam_id);

      const upcomingExams = availableExams.filter(e => !completedExamIds.includes(e.__backendId));

      content.innerHTML = `
        <div class="card">
          <h2 class="card-title">
            <span>Ujian Tersedia (${upcomingExams.length})</span>
          </h2>

          ${upcomingExams.length === 0 ? `
            <div class="empty-state">
              <div class="empty-icon">üì≠</div>
              <p class="empty-text">Tidak ada ujian yang tersedia saat ini</p>
            </div>
          ` : `
            <div style="display: grid; gap: 20px;">
              ${upcomingExams.map(exam => {
                const startDate = new Date(exam.exam_start_date);
                const endDate = new Date(exam.exam_end_date);
                const examConfig = JSON.parse(exam.exam_config);

                return `
                  <div style="background: white; border: 2px solid #e5e7eb; border-radius: 16px; padding: 24px;">
                    <div style="display: flex; gap: 20px; align-items: start;">
                      <div style="font-size: 56px; line-height: 1;">üìù</div>
                      
                      <div style="flex: 1;">
                        <h3 style="margin: 0 0 12px; font-size: 20px; font-weight: 900; color: #1f2937;">
                          ${exam.exam_title}
                        </h3>

                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
                          <span class="badge badge-info">${exam.exam_subject}</span>
                          <span class="badge badge-warning">‚è±Ô∏è ${exam.exam_duration} menit</span>
                          <span class="badge badge-success">Kelas ${exam.exam_class}</span>
                        </div>

                        <div style="background: #f9fafb; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; font-size: 14px;">
                            <div>
                              <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">‚è∞ Waktu Mulai</div>
                              <div style="font-weight: 700; color: #1f2937;">
                                ${startDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}
                              </div>
                              <div style="font-size: 12px; color: #6b7280;">
                                ${startDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                              </div>
                            </div>

                            <div>
                              <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">‚è∞ Waktu Selesai</div>
                              <div style="font-weight: 700; color: #1f2937;">
                                ${endDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}
                              </div>
                              <div style="font-size: 12px; color: #6b7280;">
                                ${endDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                              </div>
                            </div>

                            <div>
                              <div style="color: #6b7280; font-size: 12px; margin-bottom: 4px;">üìä Mata Pelajaran</div>
                              <div style="font-weight: 700; color: #1f2937;">
                                ${exam.exam_subject}
                              </div>
                            </div>
                          </div>
                        </div>

                        <button onclick="startExam('${exam.__backendId}', ${examConfig.use_token})" 
                                class="btn btn-success" style="width: 100%;">
                          Mulai Tes
                        </button>
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `}
        </div>
      `;
    }

    let examState = {
      examId: null,
      questions: [],
      currentQuestionIndex: 0,
      answers: {},
      violations: 0,
      startTime: null,
      timerInterval: null,
      duration: 0
    };

    function startExam(examId, useToken) {
      const exam = appData.find(e => e.__backendId === examId);
      if (!exam) return;

      const examConfig = JSON.parse(exam.exam_config);

      if (useToken) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 500px; text-align: center;">
            <div style="font-size: 64px; margin-bottom: 16px;">üîë</div>
            <h3 style="margin: 0 0 12px;">Masukkan Token Ujian</h3>
            <p style="margin: 0 0 24px; color: #6b7280;">
              ${exam.exam_title}
            </p>

            <form id="tokenForm">
              <div class="form-group">
                <input type="text" id="examToken" class="form-input" required 
                       placeholder="Masukkan token..." style="text-align: center; font-size: 18px; font-weight: 700;">
              </div>

              <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button type="button" onclick="this.closest('.modal-overlay').remove()" 
                        class="btn btn-secondary" style="flex: 1;">
                  Batal
                </button>
                <button type="submit" class="btn btn-success" style="flex: 1;" id="verifyTokenBtn">
                  ‚úÖ Verifikasi
                </button>
              </div>
            </form>
          </div>
        `;

        document.body.appendChild(modal);

        document.getElementById('tokenForm').addEventListener('submit', (e) => {
          e.preventDefault();
          const token = document.getElementById('examToken').value.trim();
          
          if (token === examConfig.token) {
            document.querySelector('.modal-overlay').remove();
            loadExamQuestions(examId);
          } else {
            showToast('‚ùå Token salah!', 'error');
            document.getElementById('examToken').value = '';
            document.getElementById('examToken').focus();
          }
        });
      } else {
        loadExamQuestions(examId);
      }
    }

    function loadExamQuestions(examId) {
      const exam = appData.find(e => e.__backendId === examId);
      if (!exam) return;

      const examConfig = JSON.parse(exam.exam_config);

      // Get questions for this exam
      let questions = appData.filter(q => 
        q.type === 'question' && 
        q.question_subject === exam.exam_subject && 
        q.question_class === exam.exam_class
      );

      if (questions.length === 0) {
        showToast('‚ùå Tidak ada soal tersedia untuk ujian ini', 'error');
        return;
      }

      // Shuffle questions if enabled
      if (examConfig.shuffle_questions) {
        questions = shuffleArray([...questions]);
      }

      // Limit questions if specified
      if (examConfig.question_limit && examConfig.question_limit < questions.length) {
        questions = questions.slice(0, examConfig.question_limit);
      }

      // Initialize exam state
      examState = {
        examId: examId,
        questions: questions,
        currentQuestionIndex: 0,
        answers: {},
        violations: 0,
        startTime: Date.now(),
        timerInterval: null,
        duration: exam.exam_duration * 60, // Convert to seconds
        shuffleAnswers: examConfig.shuffle_answers
      };

      renderExamInterface();
      startExamTimer();
      setupVisibilityListener();
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function renderExamInterface() {
      const exam = appData.find(e => e.__backendId === examState.examId);
      const content = document.getElementById('mainContent');

      content.innerHTML = `
        <div style="position: sticky; top: 0; z-index: 100; background: white; padding: 20px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 24px;">
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
            <div>
              <h2 style="margin: 0 0 8px; font-size: 20px; font-weight: 900; color: #1f2937;">
                ${exam.exam_title}
              </h2>
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                <span class="badge badge-info">${exam.exam_subject}</span>
                <span class="badge badge-secondary">Soal ${examState.currentQuestionIndex + 1}/${examState.questions.length}</span>
              </div>
            </div>

            <div style="display: flex; gap: 16px; align-items: center;">
              <div style="text-align: center;">
                <div style="font-size: 12px; color: #6b7280; font-weight: 700; margin-bottom: 4px;">‚è±Ô∏è WAKTU</div>
                <div id="examTimer" style="font-size: 24px; font-weight: 900; color: #ef4444; font-family: monospace;">
                  --:--
                </div>
              </div>

              <div style="text-align: center;">
                <div style="font-size: 12px; color: #6b7280; font-weight: 700; margin-bottom: 4px;">   Ô∏è PELANGGARAN</div>
                <div id="violationCounter" style="font-size: 24px; font-weight: 900; color: #f59e0b; font-family: monospace;">
                  ${examState.violations}
                </div>
              </div>
            </div>
          </div>

          <!-- Navigation Buttons -->
          <div style="display: flex; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 2px solid #e5e7eb; overflow-x: auto;">
            ${examState.questions.map((q, idx) => `
              <button onclick="navigateToQuestion(${idx})" 
                      class="btn btn-sm ${idx === examState.currentQuestionIndex ? 'btn-primary' : examState.answers[idx] !== undefined ? 'btn-success' : 'btn-secondary'}"
                      style="min-width: 50px; padding: 8px 12px;">
                ${idx + 1}
              </button>
            `).join('')}
          </div>
        </div>

        <div class="card">
          <div id="questionContainer"></div>

          <div style="display: flex; gap: 12px; margin-top: 32px; padding-top: 24px; border-top: 2px solid #e5e7eb;">
            <button onclick="previousQuestion()" 
                    class="btn btn-secondary" 
                    style="flex: 1;"
                    ${examState.currentQuestionIndex === 0 ? 'disabled' : ''}>
              ‚¨ÖÔ∏è Sebelumnya
            </button>
            
            ${examState.currentQuestionIndex === examState.questions.length - 1 ? `
              <button onclick="finishExam()" class="btn btn-success" style="flex: 2;">
                ‚úÖ Selesai & Kirim
              </button>
            ` : `
              <button onclick="nextQuestion()" class="btn btn-primary" style="flex: 1;">
                Selanjutnya ‚û°Ô∏è
              </button>
            `}
          </div>
        </div>
      `;

      renderCurrentQuestion();
    }

    function renderCurrentQuestion() {
      const question = examState.questions[examState.currentQuestionIndex];
      const questionData = JSON.parse(question.question_data);
      const container = document.getElementById('questionContainer');

      let optionsToShow = questionData.options;
      if (question.question_type === 'multiple_choice' && examState.shuffleAnswers && !examState.shuffledOptions) {
        // Shuffle once and store
        if (!examState.shuffledOptionsCache) {
          examState.shuffledOptionsCache = {};
        }
        if (!examState.shuffledOptionsCache[examState.currentQuestionIndex]) {
          examState.shuffledOptionsCache[examState.currentQuestionIndex] = shuffleArray([...questionData.options]);
        }
        optionsToShow = examState.shuffledOptionsCache[examState.currentQuestionIndex];
      }

      container.innerHTML = `
        <div style="background: #f9fafb; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
          <div style="display: flex; align-items: start; gap: 16px; margin-bottom: 16px;">
            <span style="background: #667eea; color: white; padding: 8px 16px; border-radius: 8px; font-weight: 900; font-size: 18px;">
              ${examState.currentQuestionIndex + 1}
            </span>
            <div style="flex: 1;">
              <div style="font-size: 18px; font-weight: 700; color: #1f2937; line-height: 1.6; margin-bottom: 8px;">
                ${questionData.question_text}
              </div>
              <span class="badge badge-warning">${question.question_points} Poin</span>
            </div>
          </div>

          ${questionData.question_image_url ? `
            <div style="margin-top: 16px; text-align: center;">
              <img src="${questionData.question_image_url}" 
                   style="max-width: 100%; max-height: 400px; border-radius: 12px; border: 2px solid #e5e7eb;"
                   onerror="this.style.display='none';">
            </div>
          ` : ''}
        </div>

        <div id="answerSection">
          ${question.question_type === 'multiple_choice' ? `
            <div style="display: grid; gap: 12px;">
              ${optionsToShow.map((opt, idx) => {
                const originalIdx = questionData.options.indexOf(opt);
                const isSelected = examState.answers[examState.currentQuestionIndex] === originalIdx;
                
                return `
                  <div onclick="selectAnswer(${originalIdx})" 
                       class="option-choice option-choice-${originalIdx}"
                       style="padding: 16px; background: ${isSelected ? '#dbeafe' : 'white'}; border: 3px solid ${isSelected ? '#3b82f6' : '#e5e7eb'}; border-radius: 12px; cursor: pointer; transition: all 0.2s;"
                       onmouseover="if(${examState.answers[examState.currentQuestionIndex]} !== ${originalIdx}) this.style.background='#f9fafb'"
                       onmouseout="if(${examState.answers[examState.currentQuestionIndex]} !== ${originalIdx}) this.style.background='white'">
                    <div style="display: flex; align-items: start; gap: 12px;">
                      <div class="option-radio" style="width: 24px; height: 24px; border-radius: 50%; background: ${isSelected ? '#3b82f6' : 'white'}; border: 3px solid ${isSelected ? '#3b82f6' : '#d1d5db'}; flex-shrink: 0; margin-top: 2px;"></div>
                      <div style="flex: 1;">
                        <div style="font-weight: 700; color: ${isSelected ? '#1e40af' : '#374151'}; line-height: 1.6;">
                          ${String.fromCharCode(65 + idx)}. ${opt.text}
                        </div>
                        ${opt.image_url ? `
                          <img src="${opt.image_url}" 
                               style="max-width: 300px; max-height: 200px; border-radius: 8px; margin-top: 8px;"
                               onerror="this.style.display='none';">
                        ` : ''}
                      </div>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          ` : question.question_type === 'essay' ? `
            <div class="form-group">
              <label class="form-label">Jawaban Anda:</label>
              <textarea id="essayAnswer" class="form-textarea" 
                        style="min-height: 200px;"
                        placeholder="Tulis jawaban Anda di sini..."
                        onchange="saveEssayAnswer()">${examState.answers[examState.currentQuestionIndex] || ''}</textarea>
            </div>
          ` : question.question_type === 'true_false' ? `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div onclick="selectAnswer(true)" 
                   style="padding: 32px; background: ${examState.answers[examState.currentQuestionIndex] === true ? '#d1fae5' : 'white'}; border: 3px solid ${examState.answers[examState.currentQuestionIndex] === true ? '#10b981' : '#e5e7eb'}; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s;"
                   onmouseover="if(${examState.answers[examState.currentQuestionIndex] !== true}) this.style.background='#f9fafb'"
                   onmouseout="if(${examState.answers[examState.currentQuestionIndex] !== true}) this.style.background='white'">
                <div style="font-size: 48px; margin-bottom: 12px;">‚úì</div>
                <div style="font-size: 20px; font-weight: 900; color: #10b981;">BENAR</div>
              </div>

              <div onclick="selectAnswer(false)" 
                   style="padding: 32px; background: ${examState.answers[examState.currentQuestionIndex] === false ? '#fee2e2' : 'white'}; border: 3px solid ${examState.answers[examState.currentQuestionIndex] === false ? '#ef4444' : '#e5e7eb'}; border-radius: 12px; cursor: pointer; text-align: center; transition: all 0.2s;"
                   onmouseover="if(${examState.answers[examState.currentQuestionIndex] !== false}) this.style.background='#f9fafb'"
                   onmouseout="if(${examState.answers[examState.currentQuestionIndex] !== false}) this.style.background='white'">
                <div style="font-size: 48px; margin-bottom: 12px;">‚úó</div>
                <div style="font-size: 20px; font-weight: 900; color: #ef4444;">SALAH</div>
              </div>
            </div>
          ` : question.question_type === 'matching' ? `
            <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
              <p style="margin: 0 0 16px; font-weight: 700; color: #6b7280;">
                Cocokkan pasangan yang sesuai:
              </p>
              <div style="display: grid; gap: 12px;">
                ${questionData.pairs.map((pair, idx) => `
                  <div style="background: white; padding: 16px; border-radius: 12px; border: 2px solid #e5e7eb;">
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 16px; align-items: center;">
                      <div style="font-weight: 700; color: #1f2937;">
                        ${idx + 1}. ${pair.left}
                      </div>
                      <div style="font-size: 24px; color: #6b7280;">‚ü∑</div>
                      <select class="form-select matching-select" data-pair-index="${idx}" onchange="saveMatchingAnswer(${idx}, this.value)">
                        <option value="">Pilih pasangan...</option>
                        ${questionData.pairs.map((p, pIdx) => `
                          <option value="${pIdx}" ${examState.answers[examState.currentQuestionIndex] && examState.answers[examState.currentQuestionIndex][idx] === pIdx ? 'selected' : ''}>
                            ${String.fromCharCode(65 + pIdx)}. ${p.right}
                          </option>
                        `).join('')}
                      </select>
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    function selectAnswer(answer) {
      examState.answers[examState.currentQuestionIndex] = answer;
      
      // Update UI untuk pilihan ganda saja
      const question = examState.questions[examState.currentQuestionIndex];
      if (question.question_type === 'multiple_choice') {
        const questionData = JSON.parse(question.question_data);
        
        // Reset semua pilihan
        const allChoices = document.querySelectorAll('.option-choice');
        allChoices.forEach((choice, idx) => {
          const choiceDiv = choice;
          const radio = choice.querySelector('.option-radio');
          const textDiv = choice.querySelector('div[style*="font-weight: 700"]');
          
          // Dapatkan originalIdx dari class
          const classList = choice.className.split(' ');
          const choiceClass = classList.find(c => c.startsWith('option-choice-'));
          const originalIdx = parseInt(choiceClass.replace('option-choice-', ''));
          
          if (originalIdx === answer) {
            // Pilihan yang dipilih
            choiceDiv.style.background = '#dbeafe';
            choiceDiv.style.borderColor = '#3b82f6';
            radio.style.background = '#3b82f6';
            radio.style.borderColor = '#3b82f6';
            textDiv.style.color = '#1e40af';
          } else {
            // Pilihan yang tidak dipilih
            choiceDiv.style.background = 'white';
            choiceDiv.style.borderColor = '#e5e7eb';
            radio.style.background = 'white';
            radio.style.borderColor = '#d1d5db';
            textDiv.style.color = '#374151';
          }
        });
      }
      
      updateNavigationButtons();
    }

    function saveEssayAnswer() {
      const answer = document.getElementById('essayAnswer').value.trim();
      examState.answers[examState.currentQuestionIndex] = answer;
      updateNavigationButtons();
    }

    function saveMatchingAnswer(pairIndex, selectedIndex) {
      if (!examState.answers[examState.currentQuestionIndex]) {
        examState.answers[examState.currentQuestionIndex] = {};
      }
      examState.answers[examState.currentQuestionIndex][pairIndex] = parseInt(selectedIndex);
      updateNavigationButtons();
    }

    function updateNavigationButtons() {
      const navButtons = document.querySelectorAll('.btn-sm');
      navButtons.forEach((btn, idx) => {
        if (idx < examState.questions.length) {
          if (idx === examState.currentQuestionIndex) {
            btn.className = 'btn btn-sm btn-primary';
          } else if (examState.answers[idx] !== undefined) {
            btn.className = 'btn btn-sm btn-success';
          } else {
            btn.className = 'btn btn-sm btn-secondary';
          }
        }
      });
    }

    function navigateToQuestion(index) {
      examState.currentQuestionIndex = index;
      renderExamInterface();
    }

    function previousQuestion() {
      if (examState.currentQuestionIndex > 0) {
        examState.currentQuestionIndex--;
        renderExamInterface();
      }
    }

    function nextQuestion() {
      if (examState.currentQuestionIndex < examState.questions.length - 1) {
        examState.currentQuestionIndex++;
        renderExamInterface();
      }
    }

    function startExamTimer() {
      examState.timerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - examState.startTime) / 1000);
        const remaining = examState.duration - elapsed;

        if (remaining <= 0) {
          clearInterval(examState.timerInterval);
          showToast('‚è∞ Waktu habis! Ujian otomatis dikumpulkan.', 'warning');
          setTimeout(() => submitExam(), 2000);
          return;
        }

        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        const timerEl = document.getElementById('examTimer');
        if (timerEl) {
          timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
          
          // Change color when time is running out
          if (remaining <= 60) {
            timerEl.style.color = '#ef4444';
            timerEl.style.animation = 'pulse 1s infinite';
          } else if (remaining <= 300) {
            timerEl.style.color = '#f59e0b';
          }
        }
      }, 1000);
    }

    function setupVisibilityListener() {
      document.addEventListener('visibilitychange', handleVisibilityChange);
    }

    function handleVisibilityChange() {
      if (document.hidden && examState.examId) {
        examState.violations++;
        
        const violationEl = document.getElementById('violationCounter');
        if (violationEl) {
          violationEl.textContent = examState.violations;
          violationEl.style.animation = 'shake 0.5s';
          setTimeout(() => {
            if (violationEl) violationEl.style.animation = '';
          }, 500);
        }

        showViolationWarning();
      }
    }

    function showViolationWarning() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.backgroundColor = 'rgba(239, 68, 68, 0.95)';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px; text-align: center; border: 4px solid #dc2626;">
          <div style="font-size: 120px; margin-bottom: 16px; animation: shake 0.5s infinite;">‚ö†Ô∏è</div>
          <h2 style="margin: 0 0 16px; font-size: 32px; font-weight: 900; color: #991b1b;">
            PERINGATAN PELANGGARAN!
          </h2>
          <p style="margin: 0 0 24px; color: #7f1d1d; font-size: 18px; font-weight: 700; line-height: 1.6;">
            Anda terdeteksi keluar dari tab ujian!<br>
            Pelanggaran: <span style="font-size: 32px; color: #dc2626;">${examState.violations}</span>
          </p>
          <div style="background: #fef2f2; padding: 20px; border-radius: 12px; margin-bottom: 24px; border-left: 4px solid #dc2626;">
            <p style="margin: 0; color: #991b1b; font-weight: 700; line-height: 1.6;">
              ‚ö†Ô∏è Jangan keluar dari halaman ujian!<br>
              Pelanggaran berulang akan dilaporkan ke guru.
            </p>
          </div>
          <button onclick="this.closest('.modal-overlay').remove()" 
                  class="btn btn-danger" style="width: 100%; font-size: 18px; padding: 16px;">
            Saya Mengerti
          </button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function finishExam() {
      const unansweredCount = examState.questions.length - Object.keys(examState.answers).length;

      if (unansweredCount > 0) {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 500px; text-align: center;">
            <div style="font-size: 64px; margin-bottom: 16px;">‚ö†Ô∏è</div>
            <h3 style="margin: 0 0 12px;">Ada ${unansweredCount} Soal Belum Dijawab</h3>
            <p style="margin: 0 0 24px; color: #6b7280;">
              Yakin ingin mengirim jawaban sekarang?<br>
              Soal yang belum dijawab akan mendapat nilai 0.
            </p>
            <div style="display: flex; gap: 12px;">
              <button onclick="this.closest('.modal-overlay').remove()" 
                      class="btn btn-secondary" style="flex: 1;">
                Cek Lagi
              </button>
              <button onclick="this.closest('.modal-overlay').remove(); submitExam();" 
                      class="btn btn-success" style="flex: 1;">
                ‚úÖ Kirim Sekarang
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } else {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.innerHTML = `
          <div class="modal-content" style="max-width: 500px; text-align: center;">
            <div style="font-size: 64px; margin-bottom: 16px;">‚úÖ</div>
            <h3 style="margin: 0 0 12px;">Kirim Jawaban?</h3>
            <p style="margin: 0 0 8px; color: #1f2937; font-weight: 700;">
              Semua soal sudah dijawab!
            </p>
            <p style="margin: 0 0 24px; color: #6b7280;">
              Yakin ingin mengirim jawaban sekarang?<br>
              Jawaban tidak dapat diubah setelah dikirim.
            </p>
            <div style="display: flex; gap: 12px;">
              <button onclick="this.closest('.modal-overlay').remove()" 
                      class="btn btn-secondary" style="flex: 1;">
                Cek Lagi
              </button>
              <button onclick="this.closest('.modal-overlay').remove(); submitExam();" 
                      class="btn btn-success" style="flex: 1;">
                ‚úÖ Kirim Jawaban
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      }
    }

    async function submitExam() {
      clearInterval(examState.timerInterval);
      document.removeEventListener('visibilitychange', handleVisibilityChange);

      const exam = appData.find(e => e.__backendId === examState.examId);
      
      // Calculate score
      let totalPoints = 0;
      let earnedPoints = 0;

      examState.questions.forEach((question, idx) => {
        const questionData = JSON.parse(question.question_data);
        totalPoints += question.question_points;

        const studentAnswer = examState.answers[idx];

        if (question.question_type === 'multiple_choice') {
          const correctOption = questionData.options.find(opt => opt.is_correct);
          const correctIdx = questionData.options.indexOf(correctOption);
          
          if (studentAnswer === correctIdx) {
            earnedPoints += question.question_points;
          }
        } else if (question.question_type === 'true_false') {
          if (studentAnswer === questionData.correct_answer) {
            earnedPoints += question.question_points;
          }
        } else if (question.question_type === 'matching') {
          if (studentAnswer) {
            let correctPairs = 0;
            questionData.pairs.forEach((pair, pairIdx) => {
              if (studentAnswer[pairIdx] === pairIdx) {
                correctPairs++;
              }
            });
            const pairPoints = question.question_points / questionData.pairs.length;
            earnedPoints += correctPairs * pairPoints;
          }
        }
        // Essay questions are not auto-graded, get 0 for now
      });

      const finalScore = totalPoints > 0 ? (earnedPoints / totalPoints) * 100 : 0;
      const elapsedTime = Math.floor((Date.now() - examState.startTime) / 1000);

      // Prepare answers data for storage
      const answersData = {
        questions: examState.questions.map((question, idx) => ({
          question_id: question.__backendId,
          question_text: JSON.parse(question.question_data).question_text,
          question_type: question.question_type,
          question_points: question.question_points,
          student_answer: examState.answers[idx],
          question_data: question.question_data
        }))
      };

      // Save result
      const result = await window.dataSdk.create({
        type: 'result',
        result_exam_id: examState.examId,
        result_student_id: currentUser.username,
        result_student_name: currentUser.name,
        result_score: finalScore,
        result_duration: elapsedTime,
        result_violations: examState.violations,
        result_answers_data: JSON.stringify(answersData),
        result_submitted_at: new Date().toISOString(),
        created_at: new Date().toISOString()
      });

      if (result.isOk) {
        // Reset exam state
        examState = {
          examId: null,
          questions: [],
          currentQuestionIndex: 0,
          answers: {},
          violations: 0,
          startTime: null,
          timerInterval: null,
          duration: 0
        };

        // Show success message
        showSuccessModal(finalScore, exam.exam_title);
      } else {
        showToast('‚ùå Gagal menyimpan hasil ujian', 'error');
      }
    }

    function showSuccessModal(score, examTitle) {
      let emoji = '   ';
      let message = 'Tetap semangat!';
      let bgColor = '#fee2e2';
      let textColor = '#991b1b';

      if (score > 60) {
        emoji = 'üòÑ';
        message = 'Kerja bagus!';
        bgColor = '#d1fae5';
        textColor = '#065f46';
      } else if (score > 40) {
        emoji = 'üòê';
        message = 'Cukup baik!';
        bgColor = '#fef3c7';
        textColor = '#92400e';
      }

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px; text-align: center;">
          <div style="font-size: 120px; margin-bottom: 16px;">${emoji}</div>
          <h2 style="margin: 0 0 16px; font-size: 32px; font-weight: 900; color: #1f2937;">
            ${message}
          </h2>
          
          <div style="background: ${bgColor}; padding: 24px; border-radius: 16px; margin-bottom: 24px;">
            <div style="font-size: 18px; color: ${textColor}; font-weight: 700; margin-bottom: 8px;">
              ${examTitle}
            </div>
            <div style="font-size: 64px; font-weight: 900; color: ${textColor};">
              ${score.toFixed(0)}
            </div>
            <div style="font-size: 18px; color: ${textColor}; font-weight: 700;">
              NILAI AKHIR
            </div>
          </div>

          <div style="background: #f9fafb; padding: 16px; border-radius: 12px; margin-bottom: 24px; text-align: left;">
            <div style="display: grid; gap: 12px;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: #6b7280; font-weight: 700;">Pelanggaran:</span>
                <span style="color: #1f2937; font-weight: 900;">${examState.violations}x</span>
              </div>
            </div>
          </div>

          <button onclick="this.closest('.modal-overlay').remove(); navigateTo('results');" 
                  class="btn btn-primary" style="width: 100%; font-size: 18px; padding: 16px;">
            Lihat Hasil Saya
          </button>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function renderResultsPage() {
      document.getElementById('headerTitle').textContent = currentUser.role === 'siswa' ? 'Hasil Saya' : 'Hasil Tes';
      const content = document.getElementById('mainContent');
      
      let results = appData.filter(r => r.type === 'result');
      
      if (currentUser.role === 'guru') {
        const teacherExams = appData.filter(e => 
          e.type === 'exam' && 
          e.exam_subject === currentUser.subject
        ).map(e => e.__backendId);
        
        results = results.filter(r => teacherExams.includes(r.result_exam_id));
      }
      
      if (currentUser.role === 'siswa') {
        results = results.filter(r => r.result_student_id === currentUser.username);

        const avgScore = results.length > 0 
          ? (results.reduce((sum, r) => sum + r.result_score, 0) / results.length).toFixed(1)
          : 0;
        
        const highestScore = results.length > 0 ? Math.max(...results.map(r => r.result_score)).toFixed(0) : 0;

        // Student view - table layout
        content.innerHTML = `
          <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
              <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üìä</div>
              <div class="stat-content">
                <p class="stat-label" style="color: rgba(255,255,255,0.9);">Total Tes</p>
                <p class="stat-value" style="color: white;">${results.length}</p>
              </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
              <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üìà</div>
              <div class="stat-content">
                <p class="stat-label" style="color: rgba(255,255,255,0.9);">Rata-rata</p>
                <p class="stat-value" style="color: white;">${avgScore}</p>
              </div>
            </div>

            <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
              <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üîù</div>
              <div class="stat-content">
                <p class="stat-label" style="color: rgba(255,255,255,0.9);">Tertinggi</p>
                <p class="stat-value" style="color: white;">${highestScore}</p>
              </div>
            </div>
          </div>

          <div class="card">
            <h2 class="card-title">
              <span>üìä Riwayat Hasil Tes Saya</span>
            </h2>

            ${results.length === 0 ? `
              <div class="empty-state">
                <div class="empty-icon">üì≠</div>
                <p class="empty-text">Belum ada hasil tes</p>
              </div>
            ` : `
              <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                  <thead>
                    <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                      <th style="padding: 12px 8px; text-align: left; font-weight: 800; font-size: 12px; color: #6b7280; white-space: nowrap;">NO</th>
                      <th style="padding: 12px 8px; text-align: left; font-weight: 800; font-size: 12px; color: #6b7280; min-width: 200px;">UJIAN</th>
                      <th style="padding: 12px 8px; text-align: left; font-weight: 800; font-size: 12px; color: #6b7280; white-space: nowrap;">MAPEL</th>
                      <th style="padding: 12px 8px; text-align: center; font-weight: 800; font-size: 12px; color: #6b7280; white-space: nowrap;">NILAI</th>
                      <th style="padding: 12px 8px; text-align: center; font-weight: 800; font-size: 12px; color: #6b7280; white-space: nowrap;">DURASI</th>
                      <th style="padding: 12px 8px; text-align: center; font-weight: 800; font-size: 12px; color: #6b7280; white-space: nowrap;">PELANGGARAN</th>
                      <th style="padding: 12px 8px; text-align: center; font-weight: 800; font-size: 12px; color: #6b7280; white-space: nowrap;">TANGGAL</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${results.map((result, index) => {
                      const exam = appData.find(e => e.__backendId === result.result_exam_id);
                      if (!exam) return '';

                      const durationMinutes = Math.floor(result.result_duration / 60);
                      const durationSeconds = result.result_duration % 60;
                      const submittedDate = new Date(result.result_submitted_at);

                      let scoreColor = '#ef4444';
                      let scoreBg = '#fee2e2';
                      let scoreEmoji = 'üò¢';
                      if (result.result_score >= 80) {
                        scoreColor = '#10b981';
                        scoreBg = '#d1fae5';
                        scoreEmoji = 'üéâ';
                      } else if (result.result_score >= 60) {
                        scoreColor = '#f59e0b';
                        scoreBg = '#fef3c7';
                        scoreEmoji = '   ';
                      }

                      return `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                          <td style="padding: 12px 8px; color: #6b7280; font-weight: 700;">${index + 1}</td>
                          <td style="padding: 12px 8px;">
                            <div style="font-weight: 700; color: #1f2937; margin-bottom: 4px;">${exam.exam_title}</div>
                            <div style="font-size: 11px; color: #6b7280;">
                              ${exam.exam_duration} menit ‚Ä¢ Kelas ${exam.exam_class}
                            </div>
                          </td>
                          <td style="padding: 12px 8px;">
                            <span class="badge badge-info" style="font-size: 11px;">${exam.exam_subject}</span>
                          </td>
                          <td style="padding: 12px 8px; text-align: center;">
                            <div style="background: ${scoreBg}; color: ${scoreColor}; padding: 8px 12px; border-radius: 8px; font-weight: 900; font-size: 16px; display: inline-flex; align-items: center; gap: 6px;">
                              <span style="font-size: 18px;">${scoreEmoji}</span>
                              ${result.result_score.toFixed(0)}
                            </div>
                          </td>
                          <td style="padding: 12px 8px; text-align: center; color: #6b7280; font-weight: 700; white-space: nowrap;">
                            ${durationMinutes}m ${durationSeconds}s
                          </td>
                          <td style="padding: 12px 8px; text-align: center;">
                            ${result.result_violations > 0 ? `
                              <span class="badge badge-danger">${result.result_violations}x</span>
                            ` : `
                              <span style="color: #10b981; font-weight: 900; font-size: 18px;">‚úì</span>
                            `}
                          </td>
                          <td style="padding: 12px 8px; text-align: center; font-size: 12px; color: #6b7280; white-space: nowrap;">
                            ${submittedDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}
                            <div style="font-size: 11px;">
                              ${submittedDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                            </div>
                          </td>
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            `}
          </div>
        `;
        return;
      }

      // Teacher/Admin view - table layout with filters
      const exams = appData.filter(e => e.type === 'exam');
      const students = appData.filter(u => u.type === 'user' && u.role === 'siswa');

      // Get unique values for filters
      const uniqueClasses = [...new Set(results.map(r => {
        const exam = exams.find(e => e.__backendId === r.result_exam_id);
        return exam ? exam.exam_class : null;
      }).filter(c => c))].sort();

      const uniqueSubjects = [...new Set(results.map(r => {
        const exam = exams.find(e => e.__backendId === r.result_exam_id);
        return exam ? exam.exam_subject : null;
      }).filter(s => s))].sort();

      const avgScore = results.length > 0 
        ? (results.reduce((sum, r) => sum + r.result_score, 0) / results.length).toFixed(1)
        : 0;
      
      const highestScore = results.length > 0 ? Math.max(...results.map(r => r.result_score)).toFixed(0) : 0;
      const lowestScore = results.length > 0 ? Math.min(...results.map(r => r.result_score)).toFixed(0) : 0;

      content.innerHTML = `
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
          <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">   </div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Total Hasil</p>
              <p class="stat-value" style="color: white;">${results.length}</p>
            </div>
          </div>

          <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üìà</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Rata-rata</p>
              <p class="stat-value" style="color: white;">${avgScore}</p>
            </div>
          </div>

          <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üîù</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Tertinggi</p>
              <p class="stat-value" style="color: white;">${highestScore}</p>
            </div>
          </div>

          <div class="stat-card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üìâ</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Terendah</p>
              <p class="stat-value" style="color: white;">${lowestScore}</p>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 class="card-title">
            <span>üìä Hasil Tes Siswa</span>
            <button onclick="exportResults()" class="btn btn-success btn-sm">
              üì• Export Excel
            </button>
          </h2>

          <!-- Filter Section -->
          <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 24px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <div>
                <label class="form-label">Filter Ujian</label>
                <select id="filterResultExam" class="form-select" onchange="filterResults()">
                  <option value="all">Semua Ujian</option>
                  ${exams.map(e => `<option value="${e.__backendId}">${e.exam_title}</option>`).join('')}
                </select>
              </div>

              <div>
                <label class="form-label">Filter Kelas</label>
                <select id="filterResultClass" class="form-select" onchange="filterResults()">
                  <option value="all">Semua Kelas</option>
                  ${uniqueClasses.map(c => `<option value="${c}">Kelas ${c}</option>`).join('')}
                </select>
              </div>

              <div>
                <label class="form-label">Filter Mata Pelajaran</label>
                <select id="filterResultSubject" class="form-select" onchange="filterResults()">
                  <option value="all">Semua Mapel</option>
                  <option value="Pendidikan Agama dan Budi Pekerti">Pendidikan Agama dan Budi Pekerti</option>
                  <option value="Pendidikan Pancasila">Pendidikan Pancasila</option>
                  <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                  <option value="Matematika">Matematika</option>
                  <option value="Ilmu Pengetahuan Alam (IPA)">Ilmu Pengetahuan Alam (IPA)</option>
                  <option value="Ilmu Pengetahuan Sosial (IPS)">Ilmu Pengetahuan Sosial (IPS)</option>
                  <option value="Bahasa Inggris">Bahasa Inggris</option>
                  <option value="Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)">Pendidikan Jasmani, Olahraga, dan Kesehatan (PJOK)</option>
                  <option value="Informatika">Informatika</option>
                  <option value="Seni Budaya dan Prakarya">Seni Budaya dan Prakarya</option>
                  <option value="Bahasa Daerah">Bahasa Daerah</option>
                </select>
                `}
              </div>

              <div>
                <label class="form-label">Cari Siswa</label>
                <input type="text" id="searchResultStudent" class="form-input" placeholder="Nama siswa..." oninput="filterResults()">
              </div>

              <div>
                <label class="form-label">Urutkan Nilai</label>
                <select id="sortResultScore" class="form-select" onchange="filterResults()">
                  <option value="desc">Tertinggi ke Terendah</option>
                  <option value="asc">Terendah ke Tertinggi</option>
                  <option value="date_desc">Terbaru</option>
                  <option value="date_asc">Terlama</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Results Table -->
          <div id="resultsTableContainer">
            ${renderResultsTable(results, exams)}
          </div>
        </div>
      `;
    }

    function renderResultsTable(results, exams) {
      if (results.length === 0) {
        return `
          <div class="empty-state">
            <div class="empty-icon">üì≠</div>
            <p class="empty-text">Belum ada data hasil tes</p>
          </div>
        `;
      }

      return `
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
            <thead>
              <tr style="background: #f9fafb; border-bottom: 2px solid #e5e7eb;">
                <th style="padding: 12px 8px; text-align: left; font-weight: 800; font-size: 12px; color: #6b7280; white-space: nowrap;">NO</th>
                <th style="padding: 12px 8px; text-align: left; font-weight: 800; font-size: 12px; color: #6b7280; min-width: 180px;">NAMA SISWA</th>
                <th style="padding: 12px 8px; text-align: left; font-weight: 800; font-size: 12px; color: #6b7280; min-width: 200px;">UJIAN</th>
                <th style="padding: 12px 8px; text-align: center; font-weight: 800; font-size: 12px; color: #6b7280; white-space: nowrap;">KELAS</th>
                <th style="padding: 12px 8px; text-align: left; font-weight: 800; font-size: 12px; color: #6b7280; white-space: nowrap;">MAPEL</th>
                <th style="padding: 12px 8px; text-align: center; font-weight: 800; font-size: 12px; color: #6b7280; white-space: nowrap;">NILAI</th>
                <th style="padding: 12px 8px; text-align: center; font-weight: 800; font-size: 12px; color: #6b7280; white-space: nowrap;">DURASI</th>
                <th style="padding: 12px 8px; text-align: center; font-weight: 800; font-size: 12px; color: #6b7280; white-space: nowrap;">PELANGGARAN</th>
                <th style="padding: 12px 8px; text-align: center; font-weight: 800; font-size: 12px; color: #6b7280; white-space: nowrap;">TANGGAL</th>
                <th style="padding: 12px 8px; text-align: center; font-weight: 800; font-size: 12px; color: #6b7280; white-space: nowrap;">AKSI</th>
              </tr>
            </thead>
            <tbody>
              ${results.map((result, index) => {
                const exam = exams.find(e => e.__backendId === result.result_exam_id);
                if (!exam) return '';

                const durationMinutes = Math.floor(result.result_duration / 60);
                const durationSeconds = result.result_duration % 60;
                const submittedDate = new Date(result.result_submitted_at);

                let scoreColor = '#ef4444';
                let scoreBg = '#fee2e2';
                if (result.result_score >= 80) {
                  scoreColor = '#10b981';
                  scoreBg = '#d1fae5';
                } else if (result.result_score >= 60) {
                  scoreColor = '#f59e0b';
                  scoreBg = '#fef3c7';
                }

                return `
                  <tr style="border-bottom: 1px solid #e5e7eb;" class="result-row" data-result-id="${result.__backendId}">
                    <td style="padding: 12px 8px; color: #6b7280; font-weight: 700;">${index + 1}</td>
                    <td style="padding: 12px 8px;">
                      <div style="font-weight: 700; color: #1f2937;">${result.result_student_name}</div>
                      <div style="font-size: 12px; color: #6b7280;">${result.result_student_id}</div>
                    </td>
                    <td style="padding: 12px 8px;">
                      <div style="font-weight: 700; color: #1f2937; margin-bottom: 4px;">${exam.exam_title}</div>
                      <div style="font-size: 11px; color: #6b7280;">
                        ${exam.exam_duration} menit
                      </div>
                    </td>
                    <td style="padding: 12px 8px; text-align: center;">
                      <span class="badge badge-secondary">${exam.exam_class}</span>
                    </td>
                    <td style="padding: 12px 8px;">
                      <span class="badge badge-info" style="font-size: 11px;">${exam.exam_subject}</span>
                    </td>
                    <td style="padding: 12px 8px; text-align: center;">
                      <div style="background: ${scoreBg}; color: ${scoreColor}; padding: 8px 12px; border-radius: 8px; font-weight: 900; font-size: 16px; display: inline-block;">
                        ${result.result_score.toFixed(0)}
                      </div>
                    </td>
                    <td style="padding: 12px 8px; text-align: center; color: #6b7280; font-weight: 700; white-space: nowrap;">
                      ${durationMinutes}m ${durationSeconds}s
                    </td>
                    <td style="padding: 12px 8px; text-align: center;">
                      ${result.result_violations > 0 ? `
                        <span class="badge badge-danger">${result.result_violations}x</span>
                      ` : `
                        <span style="color: #10b981; font-weight: 900;">‚úì</span>
                      `}
                    </td>
                    <td style="padding: 12px 8px; text-align: center; font-size: 12px; color: #6b7280; white-space: nowrap;">
                      ${submittedDate.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}
                      <div style="font-size: 11px;">
                        ${submittedDate.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })}
                      </div>
                    </td>
                    <td style="padding: 12px 8px;">
                      <div style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="viewAnswers('${result.__backendId}')" class="btn btn-info btn-sm" 
                                title="Lihat Jawaban" style="padding: 6px 12px;">
                          üëÅ   
                        </button>
                        <button onclick="resetResult('${result.__backendId}')" class="btn btn-warning btn-sm" 
                                title="Reset - Izinkan mengikuti tes lagi" style="padding: 6px 12px;">
                          üîÑ
                        </button>
                        <button onclick="deleteResult('${result.__backendId}')" class="btn btn-danger btn-sm" 
                                title="Hapus Hasil" style="padding: 6px 12px;">
                          üóëÔ∏è
                        </button>
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    function filterResults() {
      const examFilter = document.getElementById('filterResultExam').value;
      const classFilter = document.getElementById('filterResultClass').value;
      const subjectFilter = document.getElementById('filterResultSubject').value;
      const searchQuery = document.getElementById('searchResultStudent').value.toLowerCase();
      const sortOrder = document.getElementById('sortResultScore').value;

      let results = appData.filter(r => r.type === 'result');
      const exams = appData.filter(e => e.type === 'exam');

      if (currentUser.role === 'guru') {
        const teacherExams = exams.filter(e => e.exam_subject === currentUser.subject).map(e => e.__backendId);
        results = results.filter(r => teacherExams.includes(r.result_exam_id));
      }

      // Apply filters
      if (examFilter !== 'all') {
        results = results.filter(r => r.result_exam_id === examFilter);
      }

      if (classFilter !== 'all') {
        results = results.filter(r => {
          const exam = exams.find(e => e.__backendId === r.result_exam_id);
          return exam && exam.exam_class === classFilter;
        });
      }

      if (subjectFilter !== 'all') {
        results = results.filter(r => {
          const exam = exams.find(e => e.__backendId === r.result_exam_id);
          return exam && exam.exam_subject === subjectFilter;
        });
      }

      if (searchQuery) {
        results = results.filter(r => 
          r.result_student_name.toLowerCase().includes(searchQuery) ||
          r.result_student_id.toLowerCase().includes(searchQuery)
        );
      }

      // Apply sorting
      if (sortOrder === 'desc') {
        results.sort((a, b) => b.result_score - a.result_score);
      } else if (sortOrder === 'asc') {
        results.sort((a, b) => a.result_score - b.result_score);
      } else if (sortOrder === 'date_desc') {
        results.sort((a, b) => new Date(b.result_submitted_at) - new Date(a.result_submitted_at));
      } else if (sortOrder === 'date_asc') {
        results.sort((a, b) => new Date(a.result_submitted_at) - new Date(b.result_submitted_at));
      }

      document.getElementById('resultsTableContainer').innerHTML = renderResultsTable(results, exams);
    }

    function viewAnswers(resultId) {
      const result = appData.find(r => r.__backendId === resultId);
      if (!result) return;

      const exam = appData.find(e => e.__backendId === result.result_exam_id);
      if (!exam) return;

      const examConfig = JSON.parse(exam.exam_config);

      // Parse student answers
      let studentAnswersData = null;
      let questions = [];
      
      if (result.result_answers_data) {
        try {
          studentAnswersData = JSON.parse(result.result_answers_data);
          questions = studentAnswersData.questions || [];
        } catch (e) {
          console.error('Failed to parse answers data:', e);
        }
      }

      // Fallback: Get questions from database if no answers data
      if (questions.length === 0) {
        questions = appData.filter(q => 
          q.type === 'question' && 
          q.question_subject === exam.exam_subject && 
          q.question_class === exam.exam_class
        );

        if (examConfig.question_limit && examConfig.question_limit < questions.length) {
          questions = questions.slice(0, examConfig.question_limit);
        }

        // Convert to format compatible with rendering
        questions = questions.map(q => ({
          question_id: q.__backendId,
          question_text: JSON.parse(q.question_data).question_text,
          question_type: q.question_type,
          question_points: q.question_points,
          student_answer: null,
          question_data: q.question_data
        }));
      }

      const durationMinutes = Math.floor(result.result_duration / 60);
      const durationSeconds = result.result_duration % 60;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.overflowY = 'auto';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 1000px; margin: 40px auto;">
          <div class="modal-header">
            <h2 class="modal-title">üëÅÔ∏è Detail Jawaban Siswa</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>

          <div style="background: #f9fafb; padding: 24px; border-radius: 12px; margin-bottom: 24px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 20px;">
              <div>
                <div style="font-size: 12px; color: #6b7280; font-weight: 700; margin-bottom: 4px;">üë§ SISWA</div>
                <div style="font-size: 18px; font-weight: 900; color: #1f2937;">${result.result_student_name}</div>
                <div style="font-size: 14px; color: #6b7280;">${result.result_student_id}</div>
              </div>

              <div>
                <div style="font-size: 12px; color: #6b7280; font-weight: 700; margin-bottom: 4px;">üìù UJIAN</div>
                <div style="font-size: 18px; font-weight: 900; color: #1f2937;">${exam.exam_title}</div>
                <div style="font-size: 14px; color: #6b7280;">${exam.exam_subject} ‚Ä¢ Kelas ${exam.exam_class}</div>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
              <div style="text-align: center; padding: 16px; background: white; border-radius: 12px;">
                <div style="font-size: 32px; font-weight: 900; color: ${result.result_score >= 80 ? '#10b981' : result.result_score >= 60 ? '#f59e0b' : '#ef4444'};">
                  ${result.result_score.toFixed(0)}
                </div>
                <div style="font-size: 12px; color: #6b7280; font-weight: 700;">NILAI</div>
              </div>

              <div style="text-align: center; padding: 16px; background: white; border-radius: 12px;">
                <div style="font-size: 32px; font-weight: 900; color: #3b82f6;">
                  ${questions.length}
                </div>
                <div style="font-size: 12px; color: #6b7280; font-weight: 700;">SOAL</div>
              </div>

              <div style="text-align: center; padding: 16px; background: white; border-radius: 12px;">
                <div style="font-size: 24px; font-weight: 900; color: #667eea;">
                  ${durationMinutes}m ${durationSeconds}s
                </div>
                <div style="font-size: 12px; color: #6b7280; font-weight: 700;">DURASI</div>
              </div>

              <div style="text-align: center; padding: 16px; background: white; border-radius: 12px;">
                <div style="font-size: 32px; font-weight: 900; color: ${result.result_violations > 0 ? '#ef4444' : '#10b981'};">
                  ${result.result_violations}x
                </div>
                <div style="font-size: 12px; color: #6b7280; font-weight: 700;">PELANGGARAN</div>
              </div>
            </div>
          </div>

          ${!studentAnswersData ? `
            <div style="background: #fef3c7; padding: 16px; border-radius: 12px; margin-bottom: 24px; border-left: 4px solid #f59e0b;">
              <p style="margin: 0; color: #92400e; font-size: 14px; font-weight: 700;">
                ‚ö†Ô∏è <strong>Catatan:</strong> Jawaban siswa tidak tersimpan (hasil tes lama). 
                Hanya menampilkan soal dan kunci jawaban.
              </p>
            </div>
          ` : ''}

          <div style="display: grid; gap: 24px;">
            ${questions.map((question, idx) => {
              const questionData = JSON.parse(question.question_data);
              const studentAnswer = question.student_answer;
              
              const typeLabels = {
                multiple_choice: 'Pilihan Ganda',
                essay: 'Essay',
                true_false: 'Benar/Salah',
                matching: 'Penjodohan'
              };

              return `
                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 16px; padding: 24px;">
                  <div style="display: flex; align-items: start; gap: 16px; margin-bottom: 16px;">
                    <span style="background: #667eea; color: white; padding: 8px 16px; border-radius: 8px; font-weight: 900; font-size: 18px;">
                      ${idx + 1}
                    </span>
                    <div style="flex: 1;">
                      <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center; margin-bottom: 12px;">
                        <span class="badge badge-info">${typeLabels[question.question_type]}</span>
                        <span class="badge badge-warning">${question.question_points} Poin</span>
                      </div>
                      
                      <div style="font-size: 16px; font-weight: 700; color: #1f2937; line-height: 1.6;">
                        ${questionData.question_text}
                      </div>

                      ${questionData.question_image_url ? `
                        <div style="margin-top: 16px;">
                          <img src="${questionData.question_image_url}" 
                               style="max-width: 100%; max-height: 300px; border-radius: 12px; border: 2px solid #e5e7eb;"
                               onerror="this.style.display='none';">
                        </div>
                      ` : ''}
                    </div>
                  </div>

                  ${question.question_type === 'multiple_choice' ? `
                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                      <div style="font-size: 14px; font-weight: 900; color: #6b7280; margin-bottom: 12px;">PILIHAN JAWABAN:</div>
                      
                      ${studentAnswer !== null && studentAnswer !== undefined ? `
                        <div style="background: ${questionData.options[studentAnswer] && questionData.options[studentAnswer].is_correct ? '#d1fae5' : '#fee2e2'}; padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid ${questionData.options[studentAnswer] && questionData.options[studentAnswer].is_correct ? '#10b981' : '#ef4444'};">
                          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <span style="font-size: 32px;">${questionData.options[studentAnswer] && questionData.options[studentAnswer].is_correct ? '‚úÖ' : '‚ùå'}</span>
                            <div style="flex: 1;">
                              <div style="font-size: 12px; font-weight: 700; color: ${questionData.options[studentAnswer] && questionData.options[studentAnswer].is_correct ? '#065f46' : '#991b1b'}; margin-bottom: 4px;">
                                JAWABAN SISWA:
                              </div>
                              <div style="font-weight: 900; font-size: 16px; color: ${questionData.options[studentAnswer] && questionData.options[studentAnswer].is_correct ? '#065f46' : '#991b1b'};">
                                ${String.fromCharCode(65 + studentAnswer)}. ${questionData.options[studentAnswer] ? questionData.options[studentAnswer].text : 'Tidak valid'}
                              </div>
                            </div>
                            <span style="background: ${questionData.options[studentAnswer] && questionData.options[studentAnswer].is_correct ? '#10b981' : '#ef4444'}; color: white; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 900;">
                              ${questionData.options[studentAnswer] && questionData.options[studentAnswer].is_correct ? 'BENAR' : 'SALAH'}
                            </span>
                          </div>
                        </div>
                      ` : `
                        <div style="background: #f3f4f6; padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #6b7280;">
                          <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">‚äò</span>
                            <div style="font-weight: 700; color: #6b7280;">
                              Siswa tidak menjawab soal ini
                            </div>
                          </div>
                        </div>
                      `}

                      <div style="display: grid; gap: 12px;">
                        ${questionData.options.map((opt, optIdx) => {
                          const isStudentAnswer = studentAnswer === optIdx;
                          const isCorrectAnswer = opt.is_correct;
                          
                          let bgColor = 'white';
                          let borderColor = '#e5e7eb';
                          let textColor = '#374151';
                          
                          if (isCorrectAnswer) {
                            bgColor = '#d1fae5';
                            borderColor = '#10b981';
                            textColor = '#065f46';
                          } else if (isStudentAnswer) {
                            bgColor = '#fee2e2';
                            borderColor = '#ef4444';
                            textColor = '#991b1b';
                          }
                          
                          return `
                          <div style="display: flex; align-items: start; gap: 12px; padding: 16px; background: ${bgColor}; border-radius: 12px; border: 3px solid ${borderColor};">
                            <span style="font-weight: 900; font-size: 18px; color: ${textColor}; min-width: 30px;">
                              ${String.fromCharCode(65 + optIdx)}.
                            </span>
                            <div style="flex: 1;">
                              <div style="color: ${textColor}; line-height: 1.6; font-weight: ${isStudentAnswer || isCorrectAnswer ? '700' : '400'};">
                                ${opt.text}
                              </div>
                              ${opt.image_url ? `
                                <img src="${opt.image_url}" 
                                     style="max-width: 300px; max-height: 200px; border-radius: 8px; margin-top: 8px;"
                                     onerror="this.style.display='none';">
                              ` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                              ${isCorrectAnswer ? `
                                <span style="color: #10b981; font-size: 32px; font-weight: 900;">‚úì</span>
                                <span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 900;">KUNCI JAWABAN</span>
                              ` : isStudentAnswer ? `
                                <span style="color: #ef4444; font-size: 32px; font-weight: 900;">‚úó</span>
                                <span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 900;">JAWABAN SISWA</span>
                              ` : ''}
                            </div>
                          </div>
                        `;
                        }).join('')}
                      </div>
                    </div>
                  ` : question.question_type === 'essay' ? `
                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                      <div style="font-size: 14px; font-weight: 900; color: #6b7280; margin-bottom: 8px;">
                        METODE PENILAIAN: ${questionData.grading_method === 'manual' ? 'Manual oleh Guru' : 'Kata Kunci Otomatis'}
                      </div>
                      ${questionData.grading_method === 'keyword' && questionData.keywords ? `
                        <div style="margin-bottom: 12px;">
                          <div style="font-size: 12px; font-weight: 700; color: #6b7280; margin-bottom: 8px;">KATA KUNCI:</div>
                          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${questionData.keywords.map(k => `
                              <span class="badge badge-info">${k}</span>
                            `).join('')}
                          </div>
                        </div>
                      ` : ''}
                      
                      ${studentAnswer ? `
                        <div style="background: white; padding: 20px; border-radius: 12px; margin-top: 16px; border: 2px solid #3b82f6;">
                          <div style="font-size: 12px; font-weight: 700; color: #6b7280; margin-bottom: 12px;">üìù JAWABAN SISWA:</div>
                          <div style="background: #f9fafb; padding: 16px; border-radius: 8px; line-height: 1.8; color: #1f2937; white-space: pre-wrap;">
                            ${studentAnswer}
                          </div>
                        </div>
                      ` : `
                        <div style="background: #f3f4f6; padding: 16px; border-radius: 12px; margin-top: 16px; border-left: 4px solid #6b7280;">
                          <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">‚äò</span>
                            <div style="font-weight: 700; color: #6b7280;">
                              Siswa tidak menjawab soal essay ini
                            </div>
                          </div>
                        </div>
                      `}
                    </div>
                  ` : question.question_type === 'true_false' ? `
                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                      ${studentAnswer !== null && studentAnswer !== undefined ? `
                        <div style="background: ${studentAnswer === questionData.correct_answer ? '#d1fae5' : '#fee2e2'}; padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid ${studentAnswer === questionData.correct_answer ? '#10b981' : '#ef4444'};">
                          <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 32px;">${studentAnswer === questionData.correct_answer ? '‚úÖ' : '‚ùå'}</span>
                            <div style="flex: 1;">
                              <div style="font-size: 12px; font-weight: 700; color: ${studentAnswer === questionData.correct_answer ? '#065f46' : '#991b1b'}; margin-bottom: 4px;">
                                JAWABAN SISWA:
                              </div>
                              <div style="font-weight: 900; font-size: 18px; color: ${studentAnswer === questionData.correct_answer ? '#065f46' : '#991b1b'};">
                                ${studentAnswer === true ? '‚úì BENAR' : '‚úó SALAH'}
                              </div>
                            </div>
                            <span style="background: ${studentAnswer === questionData.correct_answer ? '#10b981' : '#ef4444'}; color: white; padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 900;">
                              ${studentAnswer === questionData.correct_answer ? 'BENAR' : 'SALAH'}
                            </span>
                          </div>
                        </div>
                      ` : `
                        <div style="background: #f3f4f6; padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #6b7280;">
                          <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">‚äò</span>
                            <div style="font-weight: 700; color: #6b7280;">
                              Siswa tidak menjawab soal ini
                            </div>
                          </div>
                        </div>
                      `}
                      
                      <div style="font-size: 14px; font-weight: 900; color: #6b7280; margin-bottom: 12px;">KUNCI JAWABAN:</div>
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div style="padding: 24px; background: ${questionData.correct_answer === true ? '#d1fae5' : studentAnswer === true ? '#fee2e2' : 'white'}; border: 3px solid ${questionData.correct_answer === true ? '#10b981' : studentAnswer === true ? '#ef4444' : '#e5e7eb'}; border-radius: 12px; text-align: center;">
                          <div style="font-size: 48px; margin-bottom: 8px;">‚úì</div>
                          <div style="font-size: 18px; font-weight: 900; color: ${questionData.correct_answer === true ? '#10b981' : studentAnswer === true ? '#ef4444' : '#6b7280'};">
                            BENAR
                          </div>
                          ${questionData.correct_answer === true ? `
                            <div style="margin-top: 8px;">
                              <span style="background: #10b981; color: white; padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 900;">KUNCI JAWABAN</span>
                            </div>
                          ` : studentAnswer === true ? `
                            <div style="margin-top: 8px;">
                              <span style="background: #ef4444; color: white; padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 900;">JAWABAN SISWA</span>
                            </div>
                          ` : ''}
                        </div>

                        <div style="padding: 24px; background: ${questionData.correct_answer === false ? '#fee2e2' : studentAnswer === false ? '#fee2e2' : 'white'}; border: 3px solid ${questionData.correct_answer === false ? '#ef4444' : studentAnswer === false ? '#ef4444' : '#e5e7eb'}; border-radius: 12px; text-align: center;">
                          <div style="font-size: 48px; margin-bottom: 8px;">‚úó</div>
                          <div style="font-size: 18px; font-weight: 900; color: ${questionData.correct_answer === false || studentAnswer === false ? '#ef4444' : '#6b7280'};">
                            SALAH
                          </div>
                          ${questionData.correct_answer === false ? `
                            <div style="margin-top: 8px;">
                              <span style="background: #ef4444; color: white; padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 900;">KUNCI JAWABAN</span>
                            </div>
                          ` : studentAnswer === false ? `
                            <div style="margin-top: 8px;">
                              <span style="background: #ef4444; color: white; padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 900;">JAWABAN SISWA</span>
                            </div>
                          ` : ''}
                        </div>
                      </div>
                    </div>
                  ` : question.question_type === 'matching' ? `
                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                      ${studentAnswer ? `
                        <div style="margin-bottom: 20px;">
                          <div style="font-size: 14px; font-weight: 900; color: #6b7280; margin-bottom: 12px;">JAWABAN SISWA:</div>
                          ${Object.keys(studentAnswer).map(leftIdx => {
                            const rightIdx = studentAnswer[leftIdx];
                            const isCorrect = parseInt(leftIdx) === parseInt(rightIdx);
                            return `
                              <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: ${isCorrect ? '#d1fae5' : '#fee2e2'}; border-radius: 8px; margin-bottom: 8px; border: 2px solid ${isCorrect ? '#10b981' : '#ef4444'};">
                                <span style="font-size: 24px;">${isCorrect ? '‚úÖ' : '‚ùå'}</span>
                                <div style="flex: 1; display: flex; align-items: center; gap: 12px;">
                                  <div style="font-weight: 700; color: ${isCorrect ? '#065f46' : '#991b1b'};">
                                    ${parseInt(leftIdx) + 1}. ${questionData.pairs[leftIdx].left}
                                  </div>
                                  <div style="font-size: 20px; color: ${isCorrect ? '#10b981' : '#ef4444'};">‚ü∑</div>
                                  <div style="font-weight: 700; color: ${isCorrect ? '#065f46' : '#991b1b'};">
                                    ${String.fromCharCode(65 + rightIdx)}. ${questionData.pairs[rightIdx].right}
                                  </div>
                                </div>
                                <span style="background: ${isCorrect ? '#10b981' : '#ef4444'}; color: white; padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 900;">
                                  ${isCorrect ? 'BENAR' : 'SALAH'}
                                </span>
                              </div>
                            `;
                          }).join('')}
                        </div>
                      ` : `
                        <div style="background: #f3f4f6; padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #6b7280;">
                          <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 24px;">‚äò</span>
                            <div style="font-weight: 700; color: #6b7280;">
                              Siswa tidak menjawab soal penjodohan ini
                            </div>
                          </div>
                        </div>
                      `}
                      
                      <div style="font-size: 14px; font-weight: 900; color: #6b7280; margin-bottom: 12px;">KUNCI JAWABAN:</div>
                      <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: start;">
                        <div>
                          <div style="font-weight: 700; color: #6b7280; margin-bottom: 12px; font-size: 13px;">KOLOM KIRI</div>
                          ${questionData.pairs.map((p, pIdx) => `
                            <div style="padding: 12px; background: white; border-radius: 8px; margin-bottom: 8px; border: 2px solid #e5e7eb;">
                              <strong style="color: #667eea;">${pIdx + 1}.</strong> ${p.left}
                            </div>
                          `).join('')}
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 24px; padding-top: 40px;">
                          ${questionData.pairs.map(() => `
                            <div style="font-size: 24px; color: #10b981; text-align: center;">‚ü∑</div>
                          `).join('')}
                        </div>

                        <div>
                          <div style="font-weight: 700; color: #6b7280; margin-bottom: 12px; font-size: 13px;">KOLOM KANAN</div>
                          ${questionData.pairs.map((p, pIdx) => `
                            <div style="padding: 12px; background: #d1fae5; border-radius: 8px; margin-bottom: 8px; border: 2px solid #10b981;">
                              <strong style="color: #065f46;">${String.fromCharCode(65 + pIdx)}.</strong> ${p.right}
                            </div>
                          `).join('')}
                        </div>
                      </div>
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>

          <div style="margin-top: 32px; padding-top: 24px; border-top: 2px solid #e5e7eb;">
            <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <div style="font-size: 14px; color: #6b7280; line-height: 1.8;">
                <div><strong>Dikumpulkan:</strong> ${new Date(result.result_submitted_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                <div><strong>Durasi:</strong> ${durationMinutes} menit ${durationSeconds} detik</div>
                <div><strong>Pelanggaran:</strong> ${result.result_violations > 0 ? `<span style="color: #ef4444; font-weight: 900;">${result.result_violations}x keluar dari tab</span>` : '<span style="color: #10b981; font-weight: 900;">Tidak ada</span>'}</div>
              </div>
            </div>

            <button onclick="this.closest('.modal-overlay').remove()" 
                    class="btn btn-primary" style="width: 100%;">
              Tutup
            </button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function viewStudentAnswers(resultId) {
      viewAnswers(resultId);
    }

    async function resetResult(resultId) {
      const result = appData.find(r => r.__backendId === resultId);
      if (!result) return;

      const exam = appData.find(e => e.__backendId === result.result_exam_id);
      if (!exam) return;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; text-align: center;">
          <div style="font-size: 64px; margin-bottom: 16px;">üîÑ</div>
          <h3 style="margin: 0 0 12px;">Reset Hasil Tes?</h3>
          <p style="margin: 0 0 8px; color: #1f2937; font-weight: 700;">
            ${result.result_student_name}
          </p>
          <p style="margin: 0 0 8px; color: #6b7280; font-weight: 700;">
            ${exam.exam_title}
          </p>
          <div style="background: #fef3c7; padding: 16px; border-radius: 12px; margin: 20px 0; border-left: 4px solid #f59e0b; text-align: left;">
            <p style="margin: 0; color: #92400e; font-size: 14px; font-weight: 700;">
              ‚ö†Ô∏è <strong>Peringatan:</strong><br>
              Hasil tes saat ini (nilai: <strong>${result.result_score.toFixed(0)}</strong>) akan dihapus permanen.<br><br>
              Siswa dapat mengikuti ujian ini lagi dari awal.
            </p>
          </div>
          <div style="display: flex; gap: 12px;">
            <button onclick="this.closest('.modal-overlay').remove()" 
                    class="btn btn-secondary" style="flex: 1;">
              Batal
            </button>
            <button onclick="confirmResetResult('${resultId}')" 
                    class="btn btn-warning" style="flex: 1;" id="confirmResetBtn">
              üîÑ Reset
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function confirmResetResult(resultId) {
      const result = appData.find(r => r.__backendId === resultId);
      if (!result) return;

      const btn = document.getElementById('confirmResetBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Mereset...';

      const deleteResult = await window.dataSdk.delete(result);

      if (deleteResult.isOk) {
        showToast('‚úÖ Hasil tes berhasil direset. Siswa dapat mengikuti ujian lagi.', 'success');
        document.querySelector('.modal-overlay').remove();
      } else {
        showToast('Gagal mereset hasil tes', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üîÑ Reset';
      }
    }

    async function deleteResult(resultId) {
      const result = appData.find(r => r.__backendId === resultId);
      if (!result) return;

      const exam = appData.find(e => e.__backendId === result.result_exam_id);
      if (!exam) return;

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; text-align: center;">
          <div style="font-size: 64px; margin-bottom: 16px;">‚ö†Ô∏è</div>
          <h3 style="margin: 0 0 12px;">Hapus Hasil Tes?</h3>
          <p style="margin: 0 0 8px; color: #1f2937; font-weight: 700;">
            ${result.result_student_name}
          </p>
          <p style="margin: 0 0 8px; color: #6b7280; font-weight: 700;">
            ${exam.exam_title}
          </p>
          <p style="margin: 0 0 24px; color: #6b7280;">
            Nilai: <strong>${result.result_score.toFixed(0)}</strong>
          </p>
          <p style="margin: 0 0 24px; color: #ef4444; font-size: 14px;">
            Aksi ini tidak dapat dibatalkan!
          </p>
          <div style="display: flex; gap: 12px;">
            <button onclick="this.closest('.modal-overlay').remove()" 
                    class="btn btn-secondary" style="flex: 1;">
              Batal
            </button>
            <button onclick="confirmDeleteResult('${resultId}')" 
                    class="btn btn-danger" style="flex: 1;" id="confirmDeleteResultBtn">
              üóëÔ∏è Hapus
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function confirmDeleteResult(resultId) {
      const result = appData.find(r => r.__backendId === resultId);
      if (!result) return;

      const btn = document.getElementById('confirmDeleteResultBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Menghapus...';

      const deleteResult = await window.dataSdk.delete(result);

      if (deleteResult.isOk) {
        showToast('‚úÖ Hasil tes berhasil dihapus', 'success');
        document.querySelector('.modal-overlay').remove();
      } else {
        showToast('Gagal menghapus hasil tes', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üóëÔ∏è Hapus';
      }
    }

    function exportResults() {
      showToast('‚ÑπÔ∏è Fitur Export Excel dalam pengembangan', 'info');
    }

    function renderMessagesPage() {
      document.getElementById('headerTitle').textContent = 'Kelola Pesan';
      const content = document.getElementById('mainContent');

      const messages = appData.filter(m => m.type === 'message');

      // Define message types
      const messageTypes = [
        { 
          key: 'login_image', 
          label: 'üé® Gambar/Emoji Login', 
          description: 'Gambar atau emoji yang ditampilkan di halaman login (ditengah)',
          type: 'image_or_text',
          preview: true
        },
        { 
          key: 'violation_warning', 
          label: '‚ö†      Gambar Peringatan Pelanggaran', 
          description: 'Gambar yang muncul saat siswa melakukan pelanggaran',
          type: 'image',
          preview: true
        },
        { 
          key: 'dashboard_announcement', 
          label: 'üì¢ Pengumuman Dashboard', 
          description: 'Pesan yang ditampilkan di dashboard siswa',
          type: 'text',
          preview: false
        },
        { 
          key: 'exam_info', 
          label: '   Ô∏è Informasi Ujian', 
          description: 'Pesan informasi sebelum memulai ujian',
          type: 'text',
          preview: false
        },
        { 
          key: 'success_message', 
          label: '‚úÖ Pesan Berhasil Submit', 
          description: 'Pesan yang muncul setelah berhasil submit ujian',
          type: 'text',
          preview: false
        }
      ];

      content.innerHTML = `
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
          <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üí¨</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Total Pesan</p>
              <p class="stat-value" style="color: white;">${messages.length}</p>
            </div>
          </div>

          <div class="stat-card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üé®</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Gambar</p>
              <p class="stat-value" style="color: white;">${messages.filter(m => m.message_image_url).length}</p>
            </div>
          </div>

          <div class="stat-card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
            <div class="stat-icon" style="background: rgba(255,255,255,0.2);">üìù</div>
            <div class="stat-content">
              <p class="stat-label" style="color: rgba(255,255,255,0.9);">Teks</p>
              <p class="stat-value" style="color: white;">${messages.filter(m => m.message_text && !m.message_image_url).length}</p>
            </div>
          </div>
        </div>

        <div class="card">
          <h2 class="card-title">
            <span>üí¨ Kelola Pesan & Media</span>
            <button onclick="showAddMessageModal()" class="btn btn-success btn-sm">
              ‚ûï Tambah Pesan
            </button>
          </h2>

          <div style="background: #dbeafe; padding: 16px; border-radius: 12px; margin-bottom: 24px; border-left: 4px solid #3b82f6;">
            <p style="margin: 0; color: #1e40af; font-size: 14px; font-weight: 700;">
              üí° <strong>Tentang Pesan:</strong><br>
              Kelola pesan pengumuman, informasi, dan gambar yang ditampilkan di berbagai bagian sistem.
            </p>
          </div>

          <div style="display: grid; gap: 20px;">
            ${messageTypes.map(msgType => {
              const existingMessage = messages.find(m => m.message_key === msgType.key);
              
              return `
                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 16px; padding: 24px;">
                  <div style="display: flex; gap: 20px; align-items: start;">
                    <div style="flex: 1;">
                      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                        <h3 style="margin: 0; font-size: 18px; font-weight: 900; color: #1f2937;">
                          ${msgType.label}
                        </h3>
                        ${existingMessage ? `
                          <span class="badge badge-success">‚úì Terisi</span>
                        ` : `
                          <span class="badge badge-secondary">Kosong</span>
                        `}
                      </div>

                      <p style="margin: 0 0 16px; color: #6b7280; font-size: 14px; line-height: 1.6;">
                        ${msgType.description}
                      </p>

                      ${existingMessage ? `
                        <div style="background: #f9fafb; padding: 16px; border-radius: 12px; margin-bottom: 16px;">
                          ${existingMessage.message_image_url ? `
                            <div style="margin-bottom: 12px;">
                              <div style="font-size: 12px; font-weight: 700; color: #6b7280; margin-bottom: 8px;">üñºÔ∏è GAMBAR:</div>
                              <img src="${existingMessage.message_image_url}" 
                                   style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid #e5e7eb; display: block; margin: 0 auto;"
                                   onerror="this.parentElement.innerHTML='<div style=\\'padding: 20px; text-align: center; color: #ef4444;\\'>‚ùå Gambar gagal dimuat</div>'">
                            </div>
                          ` : ''}
                          
                          ${existingMessage.message_text ? `
                            <div>
                              <div style="font-size: 12px; font-weight: 700; color: #6b7280; margin-bottom: 8px;">
                                ${msgType.type === 'image_or_text' ? 'üé® EMOJI/TEKS:' : 'üìù TEKS:'}
                              </div>
                              <div style="padding: 12px; background: white; border-radius: 8px; border: 2px solid #e5e7eb; line-height: 1.6; ${msgType.type === 'image_or_text' ? 'text-align: center; font-size: 48px;' : ''}">
                                ${existingMessage.message_text}
                              </div>
                            </div>
                          ` : ''}

                          <div style="margin-top: 12px; font-size: 12px; color: #9ca3af;">
                            Terakhir diupdate: ${new Date(existingMessage.created_at).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
                          </div>
                        </div>
                      ` : `
                        <div style="background: #fef3c7; padding: 16px; border-radius: 12px; margin-bottom: 16px; border-left: 4px solid #f59e0b;">
                          <p style="margin: 0; color: #92400e; font-size: 13px; font-weight: 700;">
                            ‚ö†Ô∏è Belum ada konten untuk bagian ini
                          </p>
                        </div>
                      `}

                      <div style="display: flex; gap: 8px;">
                        <button onclick="editMessage('${msgType.key}', '${msgType.type}')" 
                                class="btn ${existingMessage ? 'btn-warning' : 'btn-success'} btn-sm">
                          ${existingMessage ? '‚úèÔ∏è Edit' : '‚ûï Tambah'}
                        </button>
                        ${existingMessage ? `
                          <button onclick="deleteMessage('${msgType.key}')" class="btn btn-danger btn-sm">
                            üóëÔ∏è Hapus
                          </button>
                        ` : ''}
                      </div>
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function showAddMessageModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
          <div class="modal-header">
            <h2 class="modal-title">‚ûï Tambah Pesan</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>

          <form id="addMessageForm">
            <div class="form-group">
              <label class="form-label" for="messageKey">Jenis Pesan *</label>
              <select id="messageKey" class="form-select" required onchange="toggleMessageFields()">
                <option value="">Pilih Jenis Pesan</option>
                <option value="login_image">üé® Gambar/Emoji Login</option>
                <option value="violation_warning">‚ö†Ô∏è Gambar Peringatan Pelanggaran</option>
                <option value="dashboard_announcement">üì¢ Pengumuman Dashboard</option>
                <option value="exam_info">‚ÑπÔ∏è Informasi Ujian</option>
                <option value="success_message">      Pesan Berhasil Submit</option>
              </select>
            </div>

            <div id="messageFieldsContainer"></div>

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button type="button" onclick="this.closest('.modal-overlay').remove()" 
                      class="btn btn-secondary" style="flex: 1;">
                Batal
              </button>
              <button type="submit" class="btn btn-success" style="flex: 1;" id="saveMessageBtn">
                   Simpan
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('addMessageForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await saveMessage();
      });
    }

    function toggleMessageFields() {
      const messageKey = document.getElementById('messageKey').value;
      const container = document.getElementById('messageFieldsContainer');

      if (!messageKey) {
        container.innerHTML = '';
        return;
      }

      const messageTypes = {
        login_image: { type: 'image_or_text', label: 'Gambar/Emoji Login' },
        violation_warning: { type: 'image', label: 'Gambar Peringatan Pelanggaran' },
        dashboard_announcement: { type: 'text', label: 'Pengumuman Dashboard' },
        exam_info: { type: 'text', label: 'Informasi Ujian' },
        success_message: { type: 'text', label: 'Pesan Berhasil Submit' }
      };

      const msgType = messageTypes[messageKey];

      if (msgType.type === 'image_or_text') {
        container.innerHTML = `
          <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-top: 20px;">
            <div style="background: #dbeafe; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #3b82f6;">
              <p style="margin: 0; color: #1e40af; font-size: 13px; font-weight: 700;">
                üí° Pilih salah satu: <strong>Emoji/Teks ATAU URL Gambar</strong>
              </p>
            </div>

            <div class="form-group">
              <label class="form-label" for="messageText">Emoji atau Teks (ditampilkan di tengah)</label>
              <textarea id="messageText" class="form-textarea" placeholder="Contoh: üéì atau    " 
                        style="min-height: 100px; text-align: center; font-size: 48px;"></textarea>
              <small style="color: #6b7280; display: block; margin-top: 8px;">
                Gunakan emoji besar atau teks pendek yang akan ditampilkan di tengah halaman login
              </small>
            </div>

            <div style="text-align: center; margin: 16px 0; font-weight: 700; color: #6b7280;">
              - ATAU -
            </div>

            <div class="form-group">
              <label class="form-label" for="messageImageUrl">URL Gambar</label>
              <input type="url" id="messageImageUrl" class="form-input" 
                     placeholder="https://example.com/image.jpg">
              <small style="color: #6b7280; display: block; margin-top: 8px;">
                Gambar akan ditampilkan di tengah dengan ukuran maksimal 200x200px
              </small>
            </div>
          </div>
        `;
      } else if (msgType.type === 'image') {
        container.innerHTML = `
          <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-top: 20px;">
            <div class="form-group">
              <label class="form-label" for="messageImageUrl">URL Gambar *</label>
              <input type="url" id="messageImageUrl" class="form-input" required
                     placeholder="https://example.com/warning.jpg">
              <small style="color: #6b7280; display: block; margin-top: 8px;">
                Masukkan URL gambar peringatan yang akan ditampilkan saat pelanggaran
              </small>
            </div>

            <div class="form-group">
              <label class="form-label" for="messageText">Teks Peringatan (Opsional)</label>
              <textarea id="messageText" class="form-textarea" 
                        placeholder="Contoh: Anda terdeteksi melakukan pelanggaran!"
                        style="min-height: 80px;"></textarea>
            </div>
          </div>
        `;
      } else if (msgType.type === 'text') {
        container.innerHTML = `
          <div style="background: #f9fafb; padding: 20px; border-radius: 12px; margin-top: 20px;">
            <div class="form-group">
              <label class="form-label" for="messageText">Teks Pesan *</label>
              <textarea id="messageText" class="form-textarea" required
                        placeholder="Tulis pesan di sini..."
                        style="min-height: 150px;"></textarea>
              <small style="color: #6b7280; display: block; margin-top: 8px;">
                Tulis pesan yang ingin ditampilkan. Mendukung baris baru.
              </small>
            </div>

            <div style="background: #dbeafe; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6;">
              <p style="margin: 0; color: #1e40af; font-size: 13px; font-weight: 700;">
                üí° <strong>Tips:</strong> Gunakan enter untuk membuat paragraf baru
              </p>
            </div>
          </div>
        `;
      }
    }

    async function saveMessage() {
      const btn = document.getElementById('saveMessageBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Menyimpan...';

      const messageKey = document.getElementById('messageKey').value;
      const messageText = document.getElementById('messageText') ? document.getElementById('messageText').value.trim() : '';
      const messageImageUrl = document.getElementById('messageImageUrl') ? document.getElementById('messageImageUrl').value.trim() : '';

      // Validation
      if (!messageKey) {
        showToast('Pilih jenis pesan', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üíæ Simpan';
        return;
      }

      if (!messageText && !messageImageUrl) {
        showToast('Isi minimal teks atau URL gambar', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üíæ Simpan';
        return;
      }

      // Check if message already exists
      const existingMessage = appData.find(m => m.type === 'message' && m.message_key === messageKey);
      
      if (existingMessage) {
        // Update existing message
        const updatedMessage = {
          ...existingMessage,
          message_text: messageText || null,
          message_image_url: messageImageUrl || null,
          created_at: new Date().toISOString()
        };

        const result = await window.dataSdk.update(updatedMessage);

        if (result.isOk) {
          showToast('‚úÖ Pesan berhasil diupdate', 'success');
          document.querySelector('.modal-overlay').remove();
        } else {
          showToast('Gagal mengupdate pesan', 'error');
          btn.disabled = false;
          btn.innerHTML = 'üíæ Simpan';
        }
      } else {
        // Create new message
        const result = await window.dataSdk.create({
          type: 'message',
          message_key: messageKey,
          message_text: messageText || null,
          message_image_url: messageImageUrl || null,
          created_at: new Date().toISOString()
        });

        if (result.isOk) {
          showToast('‚úÖ Pesan berhasil ditambahkan', 'success');
          document.querySelector('.modal-overlay').remove();
        } else {
          showToast('Gagal menambahkan pesan', 'error');
          btn.disabled = false;
          btn.innerHTML = '   Simpan';
        }
      }
    }

    function editMessage(messageKey, messageType) {
      const existingMessage = appData.find(m => m.type === 'message' && m.message_key === messageKey);

      const messageLabels = {
        login_image: 'üé® Gambar/Emoji Login',
        violation_warning: '‚ö†Ô∏è Gambar Peringatan Pelanggaran',
        dashboard_announcement: 'üì¢ Pengumuman Dashboard',
        exam_info: '‚ÑπÔ∏è Informasi Ujian',
        success_message: '‚úÖ Pesan Berhasil Submit'
      };

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 700px;">
          <div class="modal-header">
            <h2 class="modal-title">${existingMessage ? '‚úèÔ∏è Edit' : '‚ûï Tambah'} ${messageLabels[messageKey]}</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>

          <form id="editMessageForm">
            ${messageType === 'image_or_text' ? `
              <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                <div style="background: #dbeafe; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #3b82f6;">
                  <p style="margin: 0; color: #1e40af; font-size: 13px; font-weight: 700;">
                    üí° Pilih salah satu: <strong>Emoji/Teks ATAU URL Gambar</strong>
                  </p>
                </div>

                <div class="form-group">
                  <label class="form-label" for="editMessageText">Emoji atau Teks (ditampilkan di tengah)</label>
                  <textarea id="editMessageText" class="form-textarea" 
                            style="min-height: 100px; text-align: center; font-size: 48px;"
                            placeholder="Contoh: üéì atau     ">${existingMessage && existingMessage.message_text ? existingMessage.message_text : ''}</textarea>
                  <small style="color: #6b7280; display: block; margin-top: 8px;">
                    Gunakan emoji besar atau teks pendek yang akan ditampilkan di tengah halaman login
                  </small>
                </div>

                <div style="text-align: center; margin: 16px 0; font-weight: 700; color: #6b7280;">
                  - ATAU -
                </div>

                <div class="form-group">
                  <label class="form-label" for="editMessageImageUrl">URL Gambar</label>
                  <input type="url" id="editMessageImageUrl" class="form-input" 
                         value="${existingMessage && existingMessage.message_image_url ? existingMessage.message_image_url : ''}"
                         placeholder="https://example.com/image.jpg">
                  <small style="color: #6b7280; display: block; margin-top: 8px;">
                    Gambar akan ditampilkan di tengah dengan ukuran maksimal 200x200px
                  </small>
                </div>
              </div>
            ` : messageType === 'image' ? `
              <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                <div class="form-group">
                  <label class="form-label" for="editMessageImageUrl">URL Gambar *</label>
                  <input type="url" id="editMessageImageUrl" class="form-input" required
                         value="${existingMessage && existingMessage.message_image_url ? existingMessage.message_image_url : ''}"
                         placeholder="https://example.com/warning.jpg">
                  <small style="color: #6b7280; display: block; margin-top: 8px;">
                    Masukkan URL gambar peringatan yang akan ditampilkan saat pelanggaran
                  </small>
                </div>

                <div class="form-group">
                  <label class="form-label" for="editMessageText">Teks Peringatan (Opsional)</label>
                  <textarea id="editMessageText" class="form-textarea" 
                            style="min-height: 80px;"
                            placeholder="Contoh: Anda terdeteksi melakukan pelanggaran!">${existingMessage && existingMessage.message_text ? existingMessage.message_text : ''}</textarea>
                </div>
              </div>
            ` : `
              <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">
                <div class="form-group">
                  <label class="form-label" for="editMessageText">Teks Pesan *</label>
                  <textarea id="editMessageText" class="form-textarea" required
                            style="min-height: 150px;"
                            placeholder="Tulis pesan di sini...">${existingMessage && existingMessage.message_text ? existingMessage.message_text : ''}</textarea>
                  <small style="color: #6b7280; display: block; margin-top: 8px;">
                    Tulis pesan yang ingin ditampilkan. Mendukung baris baru.
                  </small>
                </div>

                <div style="background: #dbeafe; padding: 12px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                  <p style="margin: 0; color: #1e40af; font-size: 13px; font-weight: 700;">
                    üí° <strong>Tips:</strong> Gunakan enter untuk membuat paragraf baru
                  </p>
                </div>
              </div>
            `}

            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button type="button" onclick="this.closest('.modal-overlay').remove()" 
                      class="btn btn-secondary" style="flex: 1;">
                Batal
              </button>
              <button type="submit" class="btn btn-success" style="flex: 1;" id="updateMessageBtn">
                üíæ Simpan
              </button>
            </div>
          </form>
        </div>
      `;

      document.body.appendChild(modal);

      document.getElementById('editMessageForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await updateMessage(messageKey, existingMessage);
      });
    }

    async function updateMessage(messageKey, existingMessage) {
      const btn = document.getElementById('updateMessageBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Menyimpan...';

      const messageText = document.getElementById('editMessageText') ? document.getElementById('editMessageText').value.trim() : '';
      const messageImageUrl = document.getElementById('editMessageImageUrl') ? document.getElementById('editMessageImageUrl').value.trim() : '';

      // Validation
      if (!messageText && !messageImageUrl) {
        showToast('Isi minimal teks atau URL gambar', 'error');
        btn.disabled = false;
        btn.innerHTML = '   Simpan';
        return;
      }

      if (existingMessage) {
        // Update existing message
        const updatedMessage = {
          ...existingMessage,
          message_text: messageText || null,
          message_image_url: messageImageUrl || null,
          created_at: new Date().toISOString()
        };

        const result = await window.dataSdk.update(updatedMessage);

        if (result.isOk) {
          showToast('‚úÖ Pesan berhasil diupdate', 'success');
          document.querySelector('.modal-overlay').remove();
        } else {
          showToast('Gagal mengupdate pesan', 'error');
          btn.disabled = false;
          btn.innerHTML = 'üíæ Simpan';
        }
      } else {
        // Create new message
        const result = await window.dataSdk.create({
          type: 'message',
          message_key: messageKey,
          message_text: messageText || null,
          message_image_url: messageImageUrl || null,
          created_at: new Date().toISOString()
        });

        if (result.isOk) {
          showToast('‚úÖ Pesan berhasil ditambahkan', 'success');
          document.querySelector('.modal-overlay').remove();
        } else {
          showToast('Gagal menambahkan pesan', 'error');
          btn.disabled = false;
          btn.innerHTML = 'üíæ Simpan';
        }
      }
    }

    async function deleteMessage(messageKey) {
      const message = appData.find(m => m.type === 'message' && m.message_key === messageKey);
      if (!message) return;

      const messageLabels = {
        login_image: 'Gambar/Emoji Login',
        violation_warning: 'Gambar Peringatan Pelanggaran',
        dashboard_announcement: 'Pengumuman Dashboard',
        exam_info: 'Informasi Ujian',
        success_message: 'Pesan Berhasil Submit'
      };

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 500px; text-align: center;">
          <div style="font-size: 64px; margin-bottom: 16px;">‚ö†Ô∏è</div>
          <h3 style="margin: 0 0 12px;">Hapus Pesan?</h3>
          <p style="margin: 0 0 8px; color: #1f2937; font-weight: 700;">
            ${messageLabels[messageKey]}
          </p>
          <p style="margin: 0 0 24px; color: #6b7280;">
            Yakin ingin menghapus pesan ini?
          </p>
          <div style="display: flex; gap: 12px;">
            <button onclick="this.closest('.modal-overlay').remove()" 
                    class="btn btn-secondary" style="flex: 1;">
              Batal
            </button>
            <button onclick="confirmDeleteMessage('${message.__backendId}')" 
                    class="btn btn-danger" style="flex: 1;" id="confirmDeleteMessageBtn">
              üóëÔ∏è Hapus
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    async function confirmDeleteMessage(messageId) {
      const message = appData.find(m => m.__backendId === messageId);
      if (!message) return;

      const btn = document.getElementById('confirmDeleteMessageBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Menghapus...';

      const result = await window.dataSdk.delete(message);

      if (result.isOk) {
        showToast('‚úÖ Pesan berhasil dihapus', 'success');
        document.querySelector('.modal-overlay').remove();
      } else {
        showToast('Gagal menghapus pesan', 'error');
        btn.disabled = false;
        btn.innerHTML = 'üóëÔ∏è Hapus';
      }
    }

    // Start initialization
    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a55ec50f06e310b',t:'MTc2NDI5MTU3MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>